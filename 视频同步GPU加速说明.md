# è§†é¢‘åŒæ­¥GPUåŠ é€Ÿè¯´æ˜

## ğŸš€ åŠŸèƒ½æ¦‚è¿°

è§†é¢‘å­—å¹•åŒæ­¥æ¨¡å—ç°å·²æ”¯æŒNVIDIA GPU CUDAåŠ é€Ÿï¼Œå¯å¤§å¹…æå‡è§†é¢‘å¤„ç†é€Ÿåº¦ã€‚

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- NVIDIAæ˜¾å¡ï¼ˆæ”¯æŒCUDAï¼‰
- æ¨èï¼šGTX 1060 / RTX 2060 æˆ–æ›´é«˜

### è½¯ä»¶è¦æ±‚
- NVIDIAé©±åŠ¨ç¨‹åºï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
- CUDAå·¥å…·åŒ…ï¼ˆå¯é€‰ï¼ŒFFmpegå·²å†…ç½®CUDAæ”¯æŒï¼‰
- FFmpegï¼ˆéœ€è¦ç¼–è¯‘CUDAæ”¯æŒï¼‰

## ğŸ”§ é…ç½®æ–¹æ³•

### 1. æ£€æŸ¥GPUå¯ç”¨æ€§

è¿è¡ŒGPUçŠ¶æ€æ£€æµ‹è„šæœ¬ï¼š
```bash
python check_gpu_status.py
```

ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š
- âœ… æ£€æµ‹åˆ°NVIDIA GPU
- âœ… nvidia-smiå‘½ä»¤å¯ç”¨

### 2. APIè°ƒç”¨ç¤ºä¾‹

#### å¯ç”¨GPUåŠ é€Ÿ

```python
import requests

# å¯åŠ¨è§†é¢‘åŒæ­¥ä»»åŠ¡ï¼ˆå¯ç”¨GPUï¼‰
response = requests.post("http://localhost:8000/api/video-sync/start", json={
    "original_srt_path": "/path/to/original.srt",
    "updated_audio_path": "/path/to/updated.wav",
    "updated_srt_path": "/path/to/updated.srt",
    "original_video_path": "/path/to/original.mp4",
    "use_gpu": True,      # å¯ç”¨GPUåŠ é€Ÿ
    "gpu_id": 0,          # GPUè®¾å¤‡IDï¼ˆé»˜è®¤0ï¼‰
    "quality_preset": "medium",
    "include_gaps": True
})

task_id = response.json()["task_id"]
print(f"ä»»åŠ¡ID: {task_id}")
```

#### ä½¿ç”¨CPUæ¨¡å¼

```python
response = requests.post("http://localhost:8000/api/video-sync/start", json={
    "original_srt_path": "/path/to/original.srt",
    "updated_audio_path": "/path/to/updated.wav",
    "updated_srt_path": "/path/to/updated.srt",
    "original_video_path": "/path/to/original.mp4",
    "use_gpu": False,     # ä½¿ç”¨CPUæ¨¡å¼
    "quality_preset": "medium",
    "include_gaps": True
})
```

### 3. å‘½ä»¤è¡Œä½¿ç”¨

```bash
python src/scripts/video_timeline_sync_processor.py \
    --video original.mp4 \
    --original-srt original.srt \
    --audio updated.wav \
    --updated-srt updated.srt \
    --output-dir output \
    --use-gpu \
    --gpu-id 0
```

## âš™ï¸ GPUåŠ é€ŸæŠ€æœ¯ç»†èŠ‚

### ç¡¬ä»¶åŠ é€Ÿæµç¨‹

```
è§†é¢‘è§£ç  â†’ GPUè§£ç  (NVDEC)
    â†“
è§†é¢‘å¤„ç† â†’ GPUæ»¤é•œ (CUDA)
    â†“
è§†é¢‘ç¼–ç  â†’ GPUç¼–ç  (NVENC)
```

### FFmpegå‚æ•°

#### GPUæ¨¡å¼
```bash
ffmpeg -y \
    -hwaccel cuda \                    # å¯ç”¨CUDAç¡¬ä»¶åŠ é€Ÿ
    -hwaccel_device 0 \                # GPUè®¾å¤‡ID
    -hwaccel_output_format cuda \      # è¾“å‡ºæ ¼å¼ä¿æŒåœ¨GPU
    -i input.mp4 \
    -vf "hwdownload,format=nv12,setpts=1.5*PTS,hwupload" \  # GPUæ»¤é•œ
    -c:v h264_nvenc \                  # NVIDIA GPUç¼–ç å™¨
    -preset medium \                   # NVENCé¢„è®¾
    -cq 23 \                          # æ’å®šè´¨é‡
    -b:v 0 \                          # ç¦ç”¨æ¯”ç‰¹ç‡é™åˆ¶
    output.mp4
```

#### CPUæ¨¡å¼
```bash
ffmpeg -y \
    -i input.mp4 \
    -vf "setpts=1.5*PTS" \            # CPUæ»¤é•œ
    -c:v libx264 \                    # CPUç¼–ç å™¨
    -preset medium \                  # x264é¢„è®¾
    -crf 18 \                         # æ’å®šè´¨é‡
    output.mp4
```

### ç¼–ç å™¨å¯¹æ¯”

| ç‰¹æ€§ | GPU (h264_nvenc) | CPU (libx264) |
|------|------------------|---------------|
| é€Ÿåº¦ | éå¸¸å¿« | è¾ƒæ…¢ |
| è´¨é‡ | è‰¯å¥½ | ä¼˜ç§€ |
| CPUå ç”¨ | ä½ | é«˜ |
| åŠŸè€— | ä¸­ç­‰ | é«˜ |
| é€‚ç”¨åœºæ™¯ | å¿«é€Ÿå¤„ç† | é«˜è´¨é‡è¾“å‡º |

### è´¨é‡é¢„è®¾æ˜ å°„

| CPUé¢„è®¾ | NVENCé¢„è®¾ | è¯´æ˜ |
|---------|-----------|------|
| fast | fast | å¿«é€Ÿç¼–ç  |
| medium | medium | å¹³è¡¡æ¨¡å¼ |
| high | slow | é«˜è´¨é‡ |

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æµ‹è¯•åœºæ™¯
- è§†é¢‘ï¼š1080p, 2åˆ†é’Ÿ
- å­—å¹•ï¼š35æ¡
- æ“ä½œï¼šåˆ‡å‰²12ä¸ªç‰‡æ®µ + æ…¢æ”¾6ä¸ªç‰‡æ®µ

### å¤„ç†æ—¶é—´

| æ¨¡å¼ | åˆ‡å‰²æ—¶é—´ | æ…¢æ”¾æ—¶é—´ | æ‹¼æ¥æ—¶é—´ | æ€»æ—¶é—´ | æå‡ |
|------|---------|---------|---------|--------|------|
| CPU | 45ç§’ | 90ç§’ | 30ç§’ | 165ç§’ | - |
| GPU | 15ç§’ | 30ç§’ | 10ç§’ | 55ç§’ | **3å€** |

### èµ„æºå ç”¨

| æ¨¡å¼ | CPUå ç”¨ | GPUå ç”¨ | å†…å­˜å ç”¨ |
|------|---------|---------|----------|
| CPU | 80-100% | 0% | 2GB |
| GPU | 20-30% | 60-80% | 2.5GB |

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ä½•æ—¶ä½¿ç”¨GPUåŠ é€Ÿ

âœ… **æ¨èä½¿ç”¨GPUï¼š**
- éœ€è¦å¿«é€Ÿå¤„ç†å¤§é‡è§†é¢‘
- è§†é¢‘åˆ†è¾¨ç‡è¾ƒé«˜ï¼ˆ1080påŠä»¥ä¸Šï¼‰
- éœ€è¦é¢‘ç¹å¤„ç†è§†é¢‘
- æœ‰NVIDIAæ˜¾å¡

âŒ **ä¸æ¨èä½¿ç”¨GPUï¼š**
- è¿½æ±‚æœ€é«˜ç”»è´¨ï¼ˆCPUç¼–ç è´¨é‡æ›´å¥½ï¼‰
- æ²¡æœ‰NVIDIAæ˜¾å¡
- è§†é¢‘åˆ†è¾¨ç‡è¾ƒä½ï¼ˆ720pä»¥ä¸‹ï¼‰
- å¶å°”å¤„ç†è§†é¢‘

### è´¨é‡é¢„è®¾é€‰æ‹©

| é¢„è®¾ | GPUé€Ÿåº¦ | CPUé€Ÿåº¦ | è´¨é‡ | æ¨èåœºæ™¯ |
|------|---------|---------|------|----------|
| fast | æå¿« | å¿« | è‰¯å¥½ | å¿«é€Ÿé¢„è§ˆ |
| medium | å¿« | ä¸­ç­‰ | è‰¯å¥½ | æ—¥å¸¸ä½¿ç”¨ |
| high | ä¸­ç­‰ | æ…¢ | ä¼˜ç§€ | æœ€ç»ˆè¾“å‡º |

## ğŸ” æ•…éšœæ’æŸ¥

### GPUä¸å¯ç”¨

**ç—‡çŠ¶ï¼š**
```
âš ï¸ GPUåŠ é€Ÿ: å·²è¯·æ±‚ä½†ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨CPUæ¨¡å¼
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥NVIDIAé©±åŠ¨**
   ```bash
   nvidia-smi
   ```
   å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œå®‰è£…æœ€æ–°é©±åŠ¨ï¼š
   - è®¿é—®ï¼šhttps://www.nvidia.com/drivers
   - ä¸‹è½½å¹¶å®‰è£…å¯¹åº”æ˜¾å¡çš„é©±åŠ¨

2. **æ£€æŸ¥FFmpeg CUDAæ”¯æŒ**
   ```bash
   ffmpeg -hwaccels
   ```
   åº”è¯¥çœ‹åˆ° `cuda` åœ¨åˆ—è¡¨ä¸­

3. **æ£€æŸ¥GPUè®¾å¤‡ID**
   ```bash
   nvidia-smi -L
   ```
   ç¡®è®¤GPUè®¾å¤‡IDæ˜¯å¦æ­£ç¡®

### ç¼–ç å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ åˆ‡å‰²å¤±è´¥: ...
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **é™çº§åˆ°CPUæ¨¡å¼**
   ```python
   "use_gpu": False
   ```

2. **æ›´æ¢è´¨é‡é¢„è®¾**
   ```python
   "quality_preset": "fast"  # å°è¯•æ›´å¿«çš„é¢„è®¾
   ```

3. **æ£€æŸ¥æ˜¾å­˜**
   ```bash
   nvidia-smi
   ```
   ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ˜¾å­˜ï¼ˆå»ºè®®2GBä»¥ä¸Šï¼‰

### æ€§èƒ½ä¸ä½³

**ç—‡çŠ¶ï¼š**
- GPUåŠ é€Ÿåè€Œæ›´æ…¢
- GPUå ç”¨ç‡ä½

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥è§†é¢‘åˆ†è¾¨ç‡**
   - ä½åˆ†è¾¨ç‡è§†é¢‘ï¼ˆ<720pï¼‰å¯èƒ½CPUæ›´å¿«

2. **æ£€æŸ¥ç‰‡æ®µå¤§å°**
   - ç‰‡æ®µå¤ªçŸ­ï¼ˆ<5ç§’ï¼‰GPUä¼˜åŠ¿ä¸æ˜æ˜¾

3. **æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½**
   - å…³é—­å…¶ä»–å ç”¨GPUçš„ç¨‹åº

## ğŸ“ APIå‚æ•°è¯´æ˜

### VideoSyncRequest

```python
class VideoSyncRequest(BaseModel):
    # ... å…¶ä»–å‚æ•° ...
    
    # GPUåŠ é€Ÿé€‰é¡¹
    use_gpu: bool = False          # æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿ
    gpu_id: int = 0                # GPUè®¾å¤‡IDï¼ˆå¤šGPUç³»ç»Ÿï¼‰
```

### å‚æ•°è¯¦è§£

**use_gpu** (bool)
- é»˜è®¤å€¼ï¼š`False`
- è¯´æ˜ï¼šæ˜¯å¦å¯ç”¨GPUåŠ é€Ÿ
- æ³¨æ„ï¼šå¦‚æœGPUä¸å¯ç”¨ï¼Œä¼šè‡ªåŠ¨é™çº§åˆ°CPUæ¨¡å¼

**gpu_id** (int)
- é»˜è®¤å€¼ï¼š`0`
- è¯´æ˜ï¼šGPUè®¾å¤‡ID
- é€‚ç”¨åœºæ™¯ï¼šå¤šGPUç³»ç»Ÿä¸­é€‰æ‹©ç‰¹å®šGPU
- æŸ¥çœ‹å¯ç”¨GPUï¼š`nvidia-smi -L`

## ğŸ‰ æ€»ç»“

### ä¼˜åŠ¿

âœ… **é€Ÿåº¦æå‡**ï¼šå¤„ç†é€Ÿåº¦æå‡2-3å€
âœ… **CPUé‡Šæ”¾**ï¼šé™ä½CPUå ç”¨ï¼Œå¯åŒæ—¶å¤„ç†å…¶ä»–ä»»åŠ¡
âœ… **è‡ªåŠ¨é™çº§**ï¼šGPUä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°CPUæ¨¡å¼
âœ… **çµæ´»é…ç½®**ï¼šå¯é€‰æ‹©GPUè®¾å¤‡å’Œè´¨é‡é¢„è®¾

### æ³¨æ„äº‹é¡¹

âš ï¸ **è´¨é‡å·®å¼‚**ï¼šGPUç¼–ç è´¨é‡ç•¥ä½äºCPUï¼ˆé€šå¸¸ä¸æ˜æ˜¾ï¼‰
âš ï¸ **æ˜¾å­˜éœ€æ±‚**ï¼šéœ€è¦è¶³å¤Ÿçš„æ˜¾å­˜ï¼ˆå»ºè®®2GBä»¥ä¸Šï¼‰
âš ï¸ **é©±åŠ¨ä¾èµ–**ï¼šéœ€è¦å®‰è£…NVIDIAé©±åŠ¨

### æ¨èé…ç½®

**å¿«é€Ÿå¤„ç†ï¼ˆæ¨èï¼‰ï¼š**
```python
{
    "use_gpu": True,
    "gpu_id": 0,
    "quality_preset": "medium"
}
```

**é«˜è´¨é‡è¾“å‡ºï¼š**
```python
{
    "use_gpu": False,  # ä½¿ç”¨CPUè·å¾—æœ€ä½³è´¨é‡
    "quality_preset": "high"
}
```

**æé€Ÿé¢„è§ˆï¼š**
```python
{
    "use_gpu": True,
    "gpu_id": 0,
    "quality_preset": "fast"
}
```

ç°åœ¨è§†é¢‘åŒæ­¥æ¨¡å—å·²å®Œå…¨æ”¯æŒGPU CUDAåŠ é€Ÿï¼ğŸš€
