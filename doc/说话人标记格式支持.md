# 说话人标记格式支持

## 🐛 问题

**错误信息**：
```
400 Client Error: Bad Request for url: ...
text=%5Bspk01%5D+%E3%81%8A%E5%85%84%E3%81%95%E3%82%93
```

**原因**：
TTS API接收到的文本包含了 `[spk01]` 标记，但这个标记应该在调用TTS之前就被移除。

父类的 `parse_srt` 方法只支持 `SPEAKER_XX` 格式，不支持 `spk` 格式。

## ✅ 解决方案

修改 `parse_srt` 方法，支持多种说话人标记格式。

### 支持的格式

| 格式 | 示例 | 说明 |
|------|------|------|
| `[spkXX]` | `[spk01] こんにちは` | 多角色配音格式（推荐） |
| `[SPEAKER_XX]` | `[SPEAKER_00] Hello` | 标准格式 |
| `spkXX:` | `spk01: こんにちは` | 冒号格式 |
| `SPEAKER_XX:` | `SPEAKER_00: Hello` | 标准冒号格式 |

### 解析逻辑

```python
# 1. 尝试匹配 [spkXX] 格式
speaker_match = re.match(r'\[(spk\d+)\]\s*(.*)', text_content)

# 2. 尝试匹配 [SPEAKER_XX] 格式
speaker_match = re.match(r'\[(SPEAKER_\d+)\]\s*(.*)', text_content)

# 3. 尝试匹配 spkXX: 格式
speaker_match = re.match(r'(spk\d+):\s*(.*)', text_content)

# 4. 尝试匹配 SPEAKER_XX: 格式
speaker_match = re.match(r'(SPEAKER_\d+):\s*(.*)', text_content)
```

### 处理流程

```
原始SRT:
  [spk01] こんにちは

解析后:
  speaker = 'spk01'
  clean_text = 'こんにちは'

调用TTS:
  text = 'こんにちは'  ← 不包含标记
  speaker = 'spk01'    ← 用于选择角色配置
```

## 📝 SRT文件示例

### 多角色配音SRT

```srt
1
00:00:00,000 --> 00:00:02,000
[spk01] お兄さん

2
00:00:02,500 --> 00:00:05,000
[spk02] 何でだよ

3
00:00:05,500 --> 00:00:08,000
[spk01] 私たちは治療を受けに来たんだよ
```

### 标准格式SRT

```srt
1
00:00:00,000 --> 00:00:02,000
[SPEAKER_00] Hello

2
00:00:02,500 --> 00:00:05,000
[SPEAKER_01] Hi there
```

## 🎉 总结

现在 `parse_srt` 方法支持多种说话人标记格式，包括：
- ✅ `[spk01]` - 多角色配音格式
- ✅ `[SPEAKER_00]` - 标准格式
- ✅ `spk01:` - 冒号格式
- ✅ `SPEAKER_00:` - 标准冒号格式

所有格式都会正确解析，说话人标记会被移除，只有纯文本会发送给TTS API。
