# è§†é¢‘åˆå¹¶æ¨¡å—ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

è§†é¢‘åˆå¹¶æ¨¡å—ä½¿ç”¨FFmpegå°†MP4è§†é¢‘ã€TTSç”Ÿæˆçš„WAVéŸ³è½¨å’Œæ›´æ–°åçš„SRTå­—å¹•è‡ªåŠ¨åˆå¹¶å¯¹é½ã€‚

## æ ¸å¿ƒåŠŸèƒ½

1. **æ›¿æ¢éŸ³è½¨**ï¼šç”¨TTSé…éŸ³æ›¿æ¢åŸè§†é¢‘éŸ³è½¨
2. **æ··åˆéŸ³è½¨**ï¼šä¿ç•™åŸéŸ³å¹¶æ··åˆTTSé…éŸ³
3. **åµŒå…¥å­—å¹•**ï¼šå°†å­—å¹•ä½œä¸ºè½¯å­—å¹•åµŒå…¥è§†é¢‘
4. **çƒ§å½•å­—å¹•**ï¼šå°†å­—å¹•çƒ§å½•åˆ°è§†é¢‘ç”»é¢ï¼ˆç¡¬å­—å¹•ï¼‰

## å®‰è£…è¦æ±‚

### FFmpeg

æ¨¡å—ä¾èµ–FFmpegï¼Œè¯·ç¡®ä¿å·²å®‰è£…ï¼š

**Windows:**
```bash
# é¡¹ç›®å·²åŒ…å«ffmpegï¼Œä½äº ffmpeg/ ç›®å½•
# æˆ–ä¸‹è½½ï¼šhttps://ffmpeg.org/download.html
```

**Linux:**
```bash
sudo apt-get install ffmpeg
```

**macOS:**
```bash
brew install ffmpeg
```

## ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ç”¨æ³•

```python
from video_merger import VideoMerger

# åˆ›å»ºåˆå¹¶å™¨
merger = VideoMerger()

# åˆå¹¶è§†é¢‘ã€éŸ³é¢‘å’Œå­—å¹•
output = merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",           # åŸè§†é¢‘
    audio_path="output/dubbing_result.wav", # TTSéŸ³è½¨
    subtitle_path="output/updated_subtitles.srt",  # å­—å¹•ï¼ˆå¯é€‰ï¼‰
    mode="replace_audio"  # åˆå¹¶æ¨¡å¼
)

print(f"âœ… åˆå¹¶å®Œæˆ: {output}")
```

### æŒ‡å®šFFmpegè·¯å¾„

```python
# å¦‚æœFFmpegä¸åœ¨ç³»ç»ŸPATHä¸­
merger = VideoMerger(ffmpeg_path="ffmpeg/ffmpeg.exe")
```

## åˆå¹¶æ¨¡å¼

### 1. æ›¿æ¢éŸ³è½¨ï¼ˆæ¨èï¼‰

**æ¨¡å¼ï¼š** `replace_audio`

**è¯´æ˜ï¼š** ç”¨TTSé…éŸ³å®Œå…¨æ›¿æ¢åŸè§†é¢‘éŸ³è½¨

**ç‰¹ç‚¹ï¼š**
- âœ… å¤„ç†é€Ÿåº¦å¿«ï¼ˆä¸é‡æ–°ç¼–ç è§†é¢‘ï¼‰
- âœ… è§†é¢‘è´¨é‡æ— æŸ
- âœ… é€‚åˆå¤§å¤šæ•°åœºæ™¯

**ä½¿ç”¨ï¼š**
```python
merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    subtitle_path="output/updated_subtitles.srt",
    mode="replace_audio"
)
```

**è¾“å‡ºï¼š**
- è§†é¢‘æµï¼šå¤åˆ¶åŸè§†é¢‘ï¼ˆæ— æŸï¼‰
- éŸ³é¢‘æµï¼šTTSé…éŸ³ï¼ˆAACç¼–ç ï¼Œ192kbpsï¼‰
- å­—å¹•æµï¼šåµŒå…¥SRTå­—å¹•ï¼ˆå¦‚æœæä¾›ï¼‰

### 2. æ··åˆéŸ³è½¨

**æ¨¡å¼ï¼š** `mix_audio`

**è¯´æ˜ï¼š** ä¿ç•™åŸéŸ³å¹¶æ··åˆTTSé…éŸ³

**ç‰¹ç‚¹ï¼š**
- âœ… ä¿ç•™åŸå§‹éŸ³æ•ˆå’ŒèƒŒæ™¯éŸ³
- âœ… å åŠ TTSé…éŸ³
- âš ï¸ å¯èƒ½å‡ºç°éŸ³é‡ä¸å¹³è¡¡

**ä½¿ç”¨ï¼š**
```python
merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    mode="mix_audio"
)
```

**è¾“å‡ºï¼š**
- éŸ³é¢‘ï¼šåŸéŸ³ + TTSé…éŸ³æ··åˆ

### 3. åµŒå…¥å­—å¹•ï¼ˆè½¯å­—å¹•ï¼‰

**æ¨¡å¼ï¼š** `embed_subtitle`

**è¯´æ˜ï¼š** å°†å­—å¹•ä½œä¸ºç‹¬ç«‹æµåµŒå…¥è§†é¢‘

**ç‰¹ç‚¹ï¼š**
- âœ… å¯ä»¥å¼€å…³å­—å¹•
- âœ… æ”¯æŒå¤šè¯­è¨€å­—å¹•
- âœ… æ–‡ä»¶ä½“ç§¯å°

**ä½¿ç”¨ï¼š**
```python
merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    subtitle_path="output/updated_subtitles.srt",
    mode="embed_subtitle"
)
```

**è¾“å‡ºï¼š**
- å­—å¹•æµï¼šmov_textæ ¼å¼ï¼ˆMP4å…¼å®¹ï¼‰
- å¯åœ¨æ’­æ”¾å™¨ä¸­å¼€å…³

### 4. çƒ§å½•å­—å¹•ï¼ˆç¡¬å­—å¹•ï¼‰

**æ¨¡å¼ï¼š** `burn_subtitle`

**è¯´æ˜ï¼š** å°†å­—å¹•çƒ§å½•åˆ°è§†é¢‘ç”»é¢

**ç‰¹ç‚¹ï¼š**
- âœ… å­—å¹•æ°¸ä¹…æ˜¾ç¤º
- âœ… å…¼å®¹æ‰€æœ‰æ’­æ”¾å™¨
- âš ï¸ éœ€è¦é‡æ–°ç¼–ç è§†é¢‘ï¼ˆè€—æ—¶ï¼‰
- âš ï¸ æ— æ³•å…³é—­å­—å¹•

**ä½¿ç”¨ï¼š**
```python
merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    subtitle_path="output/updated_subtitles.srt",
    mode="burn_subtitle"
)
```

**è¾“å‡ºï¼š**
- å­—å¹•ç›´æ¥ç»˜åˆ¶åœ¨è§†é¢‘ç”»é¢ä¸Š
- è§†é¢‘éœ€è¦é‡æ–°ç¼–ç ï¼ˆH.264ï¼‰

## å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥éª¤1ï¼šTTSé…éŸ³ç”Ÿæˆ

```python
from tts_dubbing_processor import TTSDubbingProcessor

# ç”Ÿæˆé…éŸ³
processor = TTSDubbingProcessor(
    srt_path="input/subtitles.srt",
    output_dir="output",
    engine="gpt-sovits",
    role_data={...},
    api_url="http://localhost:9880"
)

result = processor.process()
# result = {
#     'audio_path': 'output/dubbing_result.wav',
#     'srt_path': 'output/updated_subtitles.srt'
# }
```

### æ­¥éª¤2ï¼šåˆå¹¶è§†é¢‘

```python
from video_merger import VideoMerger

# åˆå¹¶
merger = VideoMerger()
output = merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path=result['audio_path'],
    subtitle_path=result['srt_path'],
    mode="replace_audio"
)

print(f"âœ… æœ€ç»ˆè§†é¢‘: {output}")
```

## é«˜çº§åŠŸèƒ½

### è·å–è§†é¢‘ä¿¡æ¯

```python
merger = VideoMerger()
info = merger.get_video_info("input/video.mp4")

print(f"è§†é¢‘æ—¶é•¿: {info['duration_seconds']}ç§’")
print(f"æœ‰è§†é¢‘æµ: {info['has_video']}")
print(f"æœ‰éŸ³é¢‘æµ: {info['has_audio']}")
print(f"æœ‰å­—å¹•æµ: {info['has_subtitle']}")
```

### è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„

```python
merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    output_path="final/my_video_dubbed.mp4",  # è‡ªå®šä¹‰è¾“å‡º
    mode="replace_audio"
)
```

## å¸¸è§é—®é¢˜

### Q1: FFmpegæœªæ‰¾åˆ°

**é”™è¯¯ï¼š** `RuntimeError: æœªæ‰¾åˆ°FFmpeg`

**è§£å†³ï¼š**
```python
# æŒ‡å®šFFmpegè·¯å¾„
merger = VideoMerger(ffmpeg_path="ffmpeg/ffmpeg.exe")

# æˆ–æ·»åŠ åˆ°ç³»ç»ŸPATH
```

### Q2: éŸ³è§†é¢‘ä¸åŒæ­¥

**åŸå› ï¼š** éŸ³é¢‘æ—¶é•¿ä¸è§†é¢‘æ—¶é•¿ä¸åŒ¹é…

**è§£å†³ï¼š**
1. ä½¿ç”¨"ä¿æŒSRTæ€»æ—¶é•¿ä¸å˜"åŠŸèƒ½
2. ç¡®ä¿TTSé…éŸ³æ—¶é•¿åŒ¹é…è§†é¢‘é•¿åº¦
3. ä½¿ç”¨`-shortest`å‚æ•°ï¼ˆå·²é»˜è®¤å¯ç”¨ï¼‰

### Q3: å­—å¹•ä¸æ˜¾ç¤º

**åŸå› ï¼š** å­—å¹•æ ¼å¼æˆ–ç¼–ç é—®é¢˜

**è§£å†³ï¼š**
1. ç¡®ä¿SRTæ–‡ä»¶UTF-8ç¼–ç 
2. ä½¿ç”¨`embed_subtitle`æ¨¡å¼
3. æˆ–ä½¿ç”¨`burn_subtitle`çƒ§å½•å­—å¹•

### Q4: å¤„ç†é€Ÿåº¦æ…¢

**åŸå› ï¼š** çƒ§å½•å­—å¹•éœ€è¦é‡æ–°ç¼–ç 

**è§£å†³ï¼š**
1. ä½¿ç”¨`replace_audio`æ¨¡å¼ï¼ˆæœ€å¿«ï¼‰
2. ä½¿ç”¨`embed_subtitle`ä»£æ›¿`burn_subtitle`
3. è°ƒæ•´FFmpegç¼–ç å‚æ•°

## æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | é€Ÿåº¦ | è§†é¢‘è´¨é‡ | å­—å¹• | æ¨èåº¦ |
|------|------|----------|------|--------|
| replace_audio | âš¡âš¡âš¡ æå¿« | ğŸŒŸğŸŒŸğŸŒŸ æ— æŸ | è½¯å­—å¹• | â­â­â­â­â­ |
| mix_audio | âš¡âš¡âš¡ æå¿« | ğŸŒŸğŸŒŸğŸŒŸ æ— æŸ | è½¯å­—å¹• | â­â­â­â­ |
| embed_subtitle | âš¡âš¡âš¡ æå¿« | ğŸŒŸğŸŒŸğŸŒŸ æ— æŸ | è½¯å­—å¹• | â­â­â­â­â­ |
| burn_subtitle | âš¡ æ…¢ | ğŸŒŸğŸŒŸ æœ‰æŸ | ç¡¬å­—å¹• | â­â­â­ |

## å‘½ä»¤è¡Œä½¿ç”¨

### åˆ›å»ºå‘½ä»¤è¡Œè„šæœ¬

```python
# merge_video.py
import sys
from video_merger import VideoMerger

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("ç”¨æ³•: python merge_video.py <video> <audio> [subtitle] [mode]")
        sys.exit(1)
    
    video = sys.argv[1]
    audio = sys.argv[2]
    subtitle = sys.argv[3] if len(sys.argv) > 3 else None
    mode = sys.argv[4] if len(sys.argv) > 4 else "replace_audio"
    
    merger = VideoMerger()
    output = merger.merge_video_audio_subtitle(video, audio, subtitle, mode=mode)
    print(f"âœ… å®Œæˆ: {output}")
```

### è¿è¡Œ

```bash
# æ›¿æ¢éŸ³è½¨
python merge_video.py input/video.mp4 output/dubbing_result.wav

# æ›¿æ¢éŸ³è½¨ + åµŒå…¥å­—å¹•
python merge_video.py input/video.mp4 output/dubbing_result.wav output/updated_subtitles.srt

# çƒ§å½•å­—å¹•
python merge_video.py input/video.mp4 output/dubbing_result.wav output/updated_subtitles.srt burn_subtitle
```

## é›†æˆåˆ°Webç•Œé¢

### åç«¯APIç¤ºä¾‹

```python
from flask import Flask, request, jsonify
from video_merger import VideoMerger

app = Flask(__name__)
merger = VideoMerger()

@app.route('/api/merge_video', methods=['POST'])
def merge_video():
    data = request.json
    
    try:
        output = merger.merge_video_audio_subtitle(
            video_path=data['video_path'],
            audio_path=data['audio_path'],
            subtitle_path=data.get('subtitle_path'),
            mode=data.get('mode', 'replace_audio')
        )
        
        return jsonify({
            'success': True,
            'output_path': output
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500
```

## æ€»ç»“

**æ¨èé…ç½®ï¼š**
```python
# æœ€ä½³å®è·µ
merger = VideoMerger()
output = merger.merge_video_audio_subtitle(
    video_path="input/video.mp4",
    audio_path="output/dubbing_result.wav",
    subtitle_path="output/updated_subtitles.srt",
    mode="replace_audio"  # å¿«é€Ÿã€æ— æŸã€æ”¯æŒè½¯å­—å¹•
)
```

**å…³é”®ä¼˜åŠ¿ï¼š**
1. âœ… è‡ªåŠ¨å¯¹é½éŸ³è§†é¢‘
2. âœ… æ”¯æŒå¤šç§åˆå¹¶æ¨¡å¼
3. âœ… å¤„ç†é€Ÿåº¦å¿«
4. âœ… è§†é¢‘è´¨é‡æ— æŸ
5. âœ… ç®€å•æ˜“ç”¨

---

*æ›´æ–°æ—¥æœŸï¼š2024-12-16*
*ç›¸å…³ä»£ç ï¼šsrc/scripts/video_merger.py*