# pyvideotrans å¯¹é½ç®—æ³•ç§»æ¤åˆ° pyannote-audio æŒ‡å—

## ğŸ“‹ ç›®æ ‡

å°† pyvideotrans é¡¹ç›®ä¸­å®Œæ•´çš„ `SpeedRate` å¯¹é½ç®—æ³•ç§»æ¤åˆ° pyannote-audio-web-ui é¡¹ç›®ä¸­ã€‚

## ğŸ” ç°çŠ¶åˆ†æ

### pyannote å·²æœ‰åŠŸèƒ½
- âœ… éŸ³é¢‘åŠ é€Ÿï¼ˆrubberband/atempoï¼‰
- âœ… æ™ºèƒ½ç­–ç•¥é€‰æ‹©
- âœ… éŸ³é¢‘ç‰‡æ®µåˆå¹¶
- âœ… å­—å¹•æ—¶é—´è½´å¯¹é½

### pyannote ç¼ºå°‘åŠŸèƒ½
- âŒ è§†é¢‘æ…¢é€Ÿå¤„ç†
- âŒ è§†é¢‘ç‰‡æ®µåˆ‡å‰²å’Œæ‹¼æ¥
- âŒ ç‰©ç†æ—¶é—´è½´æ¨¡å‹
- âŒ å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†
- âŒ å®Œæ•´çš„è¾¹ç•Œæƒ…å†µå¤„ç†

## ğŸ¯ ç§»æ¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å®Œæ•´ç§»æ¤ï¼ˆæ¨èï¼‰

ç›´æ¥å°† pyvideotrans çš„ `_rate.py` æ–‡ä»¶å¤åˆ¶å¹¶é€‚é…åˆ° pyannote é¡¹ç›®ã€‚

**æ­¥éª¤ï¼š**

1. å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
2. è°ƒæ•´ä¾èµ–å¯¼å…¥
3. é€‚é…é…ç½®ç³»ç»Ÿ
4. é›†æˆåˆ°ç°æœ‰æµç¨‹

### æ–¹æ¡ˆ2: å¢é‡æ”¹è¿›

åœ¨ç°æœ‰ `speed_rate_adjuster.py` åŸºç¡€ä¸Šé€æ­¥æ·»åŠ åŠŸèƒ½ã€‚

**æ­¥éª¤ï¼š**

1. æ·»åŠ è§†é¢‘å¤„ç†æ–¹æ³•
2. å®ç°å¤šçº¿ç¨‹æ”¯æŒ
3. å®Œå–„è¾¹ç•Œå¤„ç†
4. ä¼˜åŒ–æ€§èƒ½

## ğŸ“ è¯¦ç»†å®ç°æ­¥éª¤

### æ­¥éª¤1: å¤åˆ¶æ ¸å¿ƒä»£ç 

```bash
# ä» pyvideotrans å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
cp pyvideotrans-main/videotrans/task/_rate.py \
   pyannote-audio-web-ui/src/scripts/speed_rate_core.py
```

### æ­¥éª¤2: ä¿®æ”¹ä¾èµ–å¯¼å…¥

åŸä»£ç ï¼š
```python
from videotrans.configure import config
from videotrans.configure.config import tr, logs
from videotrans.util import tools
```

ä¿®æ”¹ä¸ºï¼š
```python
# ä½¿ç”¨ pyannote é¡¹ç›®çš„å·¥å…·å‡½æ•°
from scripts.util import get_video_duration, ms_to_time_string
import logging

logger = logging.getLogger(__name__)
```

### æ­¥éª¤3: é€‚é…é…ç½®ç³»ç»Ÿ

åˆ›å»ºé…ç½®é€‚é…å™¨ï¼š
```python
class ConfigAdapter:
    """é€‚é… pyvideotrans çš„é…ç½®ç³»ç»Ÿ"""
    def __init__(self, ffmpeg_bin='ffmpeg', temp_dir='./temp'):
        self.FFMPEG_BIN = ffmpeg_bin
        self.TEMP_DIR = temp_dir
        self.settings = {
            'max_audio_speed_rate': 100,
            'max_video_pts_rate': 10
        }
```

### æ­¥éª¤4: å®ç°è§†é¢‘å¤„ç†æ–¹æ³•

æ·»åŠ ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š

```python
def _cut_to_intermediate(self, ss, to, source, pts, out):
    """è§†é¢‘å˜é€Ÿ - åˆ‡å‰²å¹¶è°ƒæ•´PTS"""
    cmd = [
        'ffmpeg', '-y',
        '-ss', self._ms_to_time_string(ss),
        '-t', f'{(to - ss) / 1000.0}',
        '-i', source,
        '-an', '-c:v', 'libx264',
        '-x264-params', 'keyint=1:min-keyint=1:scenecut=0',
        '-preset', self.preset,
        '-crf', self.crf,
        '-pix_fmt', 'yuv420p'
    ]
    
    if pts and pts > 1.0:
        cmd.extend(['-vf', f'setpts={pts}*PTS', '-vsync', 'vfr'])
    else:
        cmd.extend(['-vf', 'setpts=PTS', '-vsync', 'vfr'])
    
    cmd.append(out)
    subprocess.run(cmd, check=True, capture_output=True)
```



```python
def _concat_and_finalize(self, clip_meta_list):
    """æ— æŸæ‹¼æ¥è§†é¢‘ç‰‡æ®µ"""
    valid_clips = [
        task['out'] for task in clip_meta_list
        if Path(task['out']).exists() and Path(task['out']).stat().st_size > 1024
    ]
    
    if not valid_clips:
        logger.warning("æ²¡æœ‰æœ‰æ•ˆçš„è§†é¢‘ç‰‡æ®µ")
        return
    
    # åˆ›å»ºconcatåˆ—è¡¨æ–‡ä»¶
    concat_txt = self.temp_dir / 'concat_list.txt'
    with open(concat_txt, 'w', encoding='utf-8') as f:
        for clip in valid_clips:
            f.write(f"file '{Path(clip).absolute()}'\n")
    
    # æ‹¼æ¥è§†é¢‘
    output = self.output_dir / 'video_merged.mp4'
    cmd = [
        'ffmpeg', '-y',
        '-f', 'concat',
        '-safe', '0',
        '-i', str(concat_txt),
        '-c:v', 'copy',
        str(output)
    ]
    subprocess.run(cmd, check=True)
    return str(output)
```

### æ­¥éª¤5: å®ç°å¤šçº¿ç¨‹å¤„ç†

```python
def _execute_audio_speedup_parallel(self):
    """å¹¶è¡Œå¤„ç†éŸ³é¢‘åŠ é€Ÿ"""
    from concurrent.futures import ThreadPoolExecutor
    
    tasks = []
    for i, subtitle in enumerate(self.subtitles):
        if self._need_speedup(subtitle):
            tasks.append((i, subtitle))
    
    with ThreadPoolExecutor(max_workers=min(12, len(tasks), os.cpu_count())) as executor:
        futures = []
        for i, subtitle in tasks:
            future = executor.submit(self._speedup_single_audio, i, subtitle)
            futures.append(future)
        
        # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        for future in futures:
            try:
                future.result()
            except Exception as e:
                logger.error(f"éŸ³é¢‘åŠ é€Ÿå¤±è´¥: {e}")

def _speedup_single_audio(self, index, subtitle):
    """å•ä¸ªéŸ³é¢‘åŠ é€Ÿä»»åŠ¡"""
    target_duration = subtitle['final_audio_duration_theoretical']
    current_duration = subtitle['dubb_time_ms']
    speedup_ratio = current_duration / target_duration
    
    input_file = subtitle['audio_file']
    output_file = self.temp_dir / f"speedup_{index:04d}.wav"
    
    # æ„å»ºFFmpegå‘½ä»¤
    cmd = self._build_speedup_command(input_file, output_file, speedup_ratio, target_duration)
    
    # æ‰§è¡Œå˜é€Ÿ
    subprocess.run(cmd, check=True, capture_output=True)
    
    # æ›´æ–°å­—å¹•æ•°æ®
    new_duration = self._get_audio_duration_ms(str(output_file))
    if new_duration > 0:
        subtitle['audio_file'] = str(output_file)
        subtitle['dubb_time_ms'] = new_duration
```

### æ­¥éª¤6: æ·»åŠ è¾¹ç•Œæƒ…å†µå¤„ç†

```python
def _prepare_data_with_boundary_check(self):
    """å‡†å¤‡æ•°æ®å¹¶å¤„ç†è¾¹ç•Œæƒ…å†µ"""
    
    # å¤„ç†å°äº40msçš„é—´éš™
    if self.enable_video_slowdown:
        for i, subtitle in enumerate(self.subtitles):
            if i == 0 and 0 < subtitle['start_ms'] < self.MIN_CLIP_DURATION_MS:
                subtitle['start_ms'] = 0
            elif i > 0 and i < len(self.subtitles) - 1:
                diff = subtitle['start_ms'] - self.subtitles[i-1]['end_ms']
                if 0 < diff < self.MIN_CLIP_DURATION_MS:
                    subtitle['start_ms'] = self.subtitles[i-1]['end_ms']
    
    # å¤„ç†ç©ºæ–‡æœ¬å­—å¹•
    for i, subtitle in enumerate(self.subtitles):
        if not subtitle.get('text', '').strip():
            subtitle['audio_file'] = None
            if i > 0:
                self.subtitles[i-1]['end_ms'] = subtitle['end_ms']
                subtitle['start_ms'] = subtitle['end_ms']
    
    # è®¡ç®—åŸå§‹æ—¶é•¿å’Œé™éŸ³é—´éš™
    for i, subtitle in enumerate(self.subtitles):
        subtitle['source_duration_ms'] = subtitle['end_ms'] - subtitle['start_ms']
        subtitle['start_time_source'] = subtitle['start_ms']
        subtitle['end_time_source'] = subtitle['end_ms']
        
        # è®¡ç®—é™éŸ³é—´éš™
        if i < len(self.subtitles) - 1:
            subtitle['silent_gap'] = self.subtitles[i+1]['start_time_source'] - subtitle['end_time_source']
        else:
            subtitle['silent_gap'] = self.raw_total_time_ms - subtitle['end_time_source']
        subtitle['silent_gap'] = max(0, subtitle['silent_gap'])
```

## ğŸ”§ é›†æˆåˆ°ç°æœ‰æµç¨‹

### ä¿®æ”¹ tts_dubbing_processor.py

```python
from scripts.speed_rate_core import SpeedRateEnhanced

class TTSDubbingProcessor:
    def __init__(self, ..., video_file=None, enable_video_slowdown=False):
        self.video_file = video_file
        self.enable_video_slowdown = enable_video_slowdown
    
    def _align_audio_with_video(self):
        """ä½¿ç”¨å¢å¼ºç‰ˆå¯¹é½ç®—æ³•"""
        adjuster = SpeedRateEnhanced(
            subtitles=self.subtitles,
            audio_files=self.audio_files,
            output_dir=self.output_dir,
            video_file=self.video_file,  # æ–°å¢ï¼šè§†é¢‘æ–‡ä»¶
            enable_audio_speedup=self.enable_audio_speedup,
            enable_video_slowdown=self.enable_video_slowdown,  # æ–°å¢
            max_audio_speed_rate=self.max_audio_speed_rate,
            max_video_pts_rate=self.max_video_pts_rate,  # æ–°å¢
            raw_total_time_ms=self.raw_total_time_ms,
            video_fps=self._get_video_fps(),  # æ–°å¢
        )
        
        final_audio, final_video, updated_subtitles = adjuster.process()
        return final_audio, final_video, updated_subtitles
```

## ğŸ“¦ å®Œæ•´çš„ç±»ç»“æ„

```python
class SpeedRateEnhanced:
    """å¢å¼ºç‰ˆå¯¹é½ç®—æ³•"""
    
    def __init__(self, ...):
        """åˆå§‹åŒ–"""
        pass
    
    # ========== æ ¸å¿ƒæµç¨‹ ==========
    def process(self):
        """ä¸»å¤„ç†æµç¨‹"""
        if not self.enable_audio_speedup and not self.enable_video_slowdown:
            return self._run_no_rate_change_mode()
        
        self._prepare_data()
        self._calculate_adjustments()
        self._execute_audio_speedup()
        clip_meta_list = self._execute_video_processing()
        audio_concat_list = self._recalculate_timeline(clip_meta_list)
        self._finalize_files(audio_concat_list)
        
        return self.final_audio, self.final_video, self.subtitles
    
    # ========== é˜¶æ®µ1: å‡†å¤‡æ•°æ® ==========
    def _prepare_data(self):
        """å‡†å¤‡æ•°æ®"""
        pass
    
    # ========== é˜¶æ®µ2: è®¡ç®—è°ƒæ•´æ–¹æ¡ˆ ==========
    def _calculate_adjustments(self):
        """è®¡ç®—è°ƒæ•´æ–¹æ¡ˆ"""
        pass
    
    # ========== é˜¶æ®µ3: éŸ³é¢‘åŠ é€Ÿ ==========
    def _execute_audio_speedup(self):
        """æ‰§è¡ŒéŸ³é¢‘åŠ é€Ÿ"""
        pass
    
    def _speedup_single_audio(self, index, subtitle):
        """å•ä¸ªéŸ³é¢‘åŠ é€Ÿ"""
        pass
    
    # ========== é˜¶æ®µ4: è§†é¢‘å¤„ç† ==========
    def _execute_video_processing(self):
        """æ‰§è¡Œè§†é¢‘å¤„ç†"""
        pass
    
    def _create_clip_meta(self):
        """åˆ›å»ºè§†é¢‘åˆ‡å‰²ä»»åŠ¡åˆ—è¡¨"""
        pass
    
    def _cut_to_intermediate(self, ss, to, source, pts, out):
        """åˆ‡å‰²è§†é¢‘ç‰‡æ®µ"""
        pass
    
    def _concat_and_finalize(self, clip_meta_list):
        """æ‹¼æ¥è§†é¢‘ç‰‡æ®µ"""
        pass
    
    # ========== é˜¶æ®µ5: æ—¶é—´è½´é‡å»º ==========
    def _recalculate_timeline(self, clip_meta_list):
        """é‡å»ºæ—¶é—´è½´"""
        if self.enable_video_slowdown and clip_meta_list:
            return self._recalculate_timeline_physical(clip_meta_list)
        else:
            return self._recalculate_timeline_theoretical()
    
    def _recalculate_timeline_physical(self, clip_meta_list):
        """ç‰©ç†æ—¶é—´è½´æ¨¡å‹"""
        pass
    
    def _recalculate_timeline_theoretical(self):
        """ç†è®ºæ—¶é—´è½´æ¨¡å‹"""
        pass
    
    # ========== å·¥å…·æ–¹æ³• ==========
    def _get_audio_duration_ms(self, file_path):
        """è·å–éŸ³é¢‘æ—¶é•¿"""
        pass
    
    def _get_video_duration_ms(self, file_path):
        """è·å–è§†é¢‘æ—¶é•¿"""
        pass
    
    def _ms_to_time_string(self, ms):
        """æ¯«ç§’è½¬æ—¶é—´å­—ç¬¦ä¸²"""
        pass
    
    def _check_ffmpeg_filters(self):
        """æ£€æŸ¥FFmpegæ»¤é•œ"""
        pass
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: ä»…éŸ³é¢‘åŠ é€Ÿ

```python
from scripts.speed_rate_core import SpeedRateEnhanced

subtitles = [
    {'start_ms': 0, 'end_ms': 2000, 'text': 'ç¬¬ä¸€å¥è¯'},
    {'start_ms': 2500, 'end_ms': 5000, 'text': 'ç¬¬äºŒå¥è¯'},
]

audio_files = ['audio_001.wav', 'audio_002.wav']

adjuster = SpeedRateEnhanced(
    subtitles=subtitles,
    audio_files=audio_files,
    output_dir='./output',
    enable_audio_speedup=True,
    enable_video_slowdown=False,
)

final_audio, final_video, updated_subtitles = adjuster.process()
```

### æµ‹è¯•2: éŸ³é¢‘åŠ é€Ÿ + è§†é¢‘æ…¢é€Ÿ

```python
adjuster = SpeedRateEnhanced(
    subtitles=subtitles,
    audio_files=audio_files,
    output_dir='./output',
    video_file='input_video.mp4',  # æä¾›è§†é¢‘æ–‡ä»¶
    enable_audio_speedup=True,
    enable_video_slowdown=True,
    max_audio_speed_rate=1.5,
    max_video_pts_rate=2.0,
)

final_audio, final_video, updated_subtitles = adjuster.process()
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¤šçº¿ç¨‹ä¼˜åŒ–

```python
# éŸ³é¢‘åŠ é€Ÿå¹¶è¡Œå¤„ç†
max_workers = min(12, len(tasks), os.cpu_count())

# è§†é¢‘åˆ‡å‰²å¹¶è¡Œå¤„ç†
with ThreadPoolExecutor(max_workers=max_workers) as executor:
    futures = [executor.submit(task_func, task) for task in tasks]
    for future in futures:
        future.result()
```

### 2. å†…å­˜ä¼˜åŒ–

```python
# ä½¿ç”¨ç”Ÿæˆå™¨å¤„ç†å¤§æ–‡ä»¶
def _process_audio_segments_generator(self):
    for i, subtitle in enumerate(self.subtitles):
        audio = AudioSegment.from_file(subtitle['audio_file'])
        yield audio
        del audio  # åŠæ—¶é‡Šæ”¾å†…å­˜

# æµå¼æ‹¼æ¥
final_audio = sum(self._process_audio_segments_generator())
```

### 3. ç¼“å­˜ä¼˜åŒ–

```python
# ç¼“å­˜è§†é¢‘ä¿¡æ¯
@functools.lru_cache(maxsize=128)
def _get_video_info_cached(self, video_path):
    return self._get_video_info(video_path)
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
pip install pydub ffmpeg-python
```

### 2. å¤åˆ¶æ–‡ä»¶

```bash
# å¤åˆ¶æ ¸å¿ƒç®—æ³•
cp pyvideotrans-main/videotrans/task/_rate.py \
   pyannote-audio-web-ui/src/scripts/speed_rate_core.py

# ä¿®æ”¹å¯¼å…¥å’Œé…ç½®
# æ‰‹åŠ¨ç¼–è¾‘ speed_rate_core.py
```

### 3. é›†æˆåˆ°ä¸»æµç¨‹

ä¿®æ”¹ `tts_dubbing_processor.py`ï¼Œæ·»åŠ è§†é¢‘å¤„ç†æ”¯æŒã€‚

### 4. æµ‹è¯•

```bash
python src/scripts/test_speed_rate_enhanced.py
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **FFmpegç‰ˆæœ¬**: ç¡®ä¿FFmpegæ”¯æŒ rubberband æ»¤é•œ
2. **è§†é¢‘ç¼–ç **: å»ºè®®ä½¿ç”¨ H.264 ç¼–ç ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§
3. **å†…å­˜ä½¿ç”¨**: å¤„ç†å¤§è§†é¢‘æ—¶æ³¨æ„å†…å­˜å ç”¨
4. **ä¸´æ—¶æ–‡ä»¶**: åŠæ—¶æ¸…ç†ä¸´æ—¶è§†é¢‘ç‰‡æ®µ
5. **é”™è¯¯å¤„ç†**: æ·»åŠ å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•

## ğŸ“š å‚è€ƒèµ„æ–™

- [pyvideotrans é¡¹ç›®](https://github.com/jianchang512/pyvideotrans)
- [FFmpeg PTS æ–‡æ¡£](https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video)
- [PyDub æ–‡æ¡£](https://github.com/jiaaro/pydub)

## ğŸ‰ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥å°† pyvideotrans çš„å®Œæ•´å¯¹é½ç®—æ³•ç§»æ¤åˆ° pyannote-audio é¡¹ç›®ä¸­ï¼Œå®ç°ï¼š

âœ… éŸ³é¢‘åŠ é€Ÿï¼ˆå·²æœ‰ï¼‰  
âœ… è§†é¢‘æ…¢é€Ÿï¼ˆæ–°å¢ï¼‰  
âœ… æ™ºèƒ½ç­–ç•¥é€‰æ‹©ï¼ˆå·²æœ‰ï¼‰  
âœ… å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼ˆæ–°å¢ï¼‰  
âœ… å®Œæ•´è¾¹ç•Œå¤„ç†ï¼ˆæ–°å¢ï¼‰  
âœ… ç‰©ç†æ—¶é—´è½´æ¨¡å‹ï¼ˆæ–°å¢ï¼‰  

ç§»æ¤å®Œæˆåï¼Œpyannote-audio å°†å…·å¤‡ä¸ pyvideotrans ç›¸åŒçš„ä¸“ä¸šçº§å¯¹é½èƒ½åŠ›ï¼
