# SRT解析问题诊断与修复

## 问题描述

后端解析SRT文件时出现错误：
```
⚠️ 块 721 行数不足 (1 < 3)
⚠️ 块 722 行数不足 (1 < 3)
✅ 解析完成，共 0 条字幕
❌ 多角色TTS配音任务失败: SRT文件中没有字幕
```

## 原因分析

1. **分割问题**：原始代码使用 `\n\n+` 分割，可能对某些SRT文件格式不够健壮
2. **空行处理**：SRT文件末尾或中间的额外空行导致分割出空块
3. **格式变化**：不同来源的SRT文件可能有微小的格式差异

## 已实施的修复

### 1. 优化块分割逻辑
```python
# 修复前
blocks = re.split(r'\n\n+', content_normalized.strip())

# 修复后
blocks = re.split(r'\n\s*\n', content_normalized.strip())
```

### 2. 过滤空行
```python
lines = [line.strip() for line in block.split('\n') if line.strip()]
```

### 3. 灵活的时间轴查找
```python
# 时间轴可能在第2行或第3行
for idx in range(1, min(3, len(lines))):
    time_match = time_pattern.match(lines[idx])
    if time_match:
        time_line_idx = idx
        break
```

### 4. 添加详细的调试信息
- 打印文件前500字符
- 显示解析失败的块内容
- 减少日志输出（只显示前10条和每100条）

## 测试步骤

### 步骤1：使用测试SRT文件
1. 使用项目根目录的 `测试用SRT示例.srt` 文件
2. 该文件包含4个说话人（spk01, spk02, spk04, spk00）
3. 共10条字幕

### 步骤2：重启服务
```bash
# 停止当前运行的服务
# 重新启动
python src/main.py
```

### 步骤3：测试上传
1. 进入"多角色配音"标签
2. 上传测试SRT文件
3. 查看后端控制台输出

### 步骤4：检查输出
应该看到类似以下的输出：
```
📖 开始解析带说话人标识的SRT文件: ...
📄 文件大小: 723 字符
📝 文件前500字符预览:
--------------------------------------------------
1
00:00:00,000 --> 00:00:03,500
[spk01] 大家好，欢迎收看今天的节目

2
00:00:04,000 --> 00:00:08,000
[spk02] 今天我们要讲解的是人工智能技术
...
--------------------------------------------------
📦 分割后的块数: 10
✅ 解析字幕 1: [spk01] 大家好，欢迎收看今天的节目...
✅ 解析字幕 2: [spk02] 今天我们要讲解的是人工智能技术...
...
✅ 解析完成，共 10 条字幕
👥 说话人统计:
  - spk00: 2 条字幕
  - spk01: 3 条字幕
  - spk02: 2 条字幕
  - spk04: 3 条字幕
```

## 诊断您的SRT文件

如果仍然解析失败，请检查：

### 1. 查看文件预览
后端会打印文件前500字符，检查：
- ✅ 是否有序号（1, 2, 3...）
- ✅ 是否有时间轴（00:00:00,000 --> 00:00:03,500）
- ✅ 是否有说话人标识（[spk01]）
- ✅ 是否有文本内容

### 2. 检查文件编码
确保SRT文件是UTF-8编码：
```python
# 在Python中检查
with open('your_file.srt', 'rb') as f:
    raw = f.read()
    print(raw[:100])  # 查看原始字节
```

### 3. 检查换行符
SRT文件应该使用标准换行符：
- Windows: `\r\n`
- Linux/Mac: `\n`
- 代码已自动处理两种格式

### 4. 检查空行
标准SRT格式：
```srt
1
00:00:00,000 --> 00:00:03,500
[spk01] 文本内容
<空行>
2
00:00:04,000 --> 00:00:08,000
[spk02] 文本内容
<空行>
```

## 常见问题

### Q1: 块数很多但解析出0条字幕
**可能原因**：
- 时间轴格式不正确
- 缺少文本内容
- 序号不是数字

**解决方法**：
查看后端输出的警告信息，找出具体哪些块解析失败

### Q2: 部分字幕解析失败
**可能原因**：
- 某些字幕块格式异常
- 文本为空

**解决方法**：
查看具体的警告信息，修复对应的字幕块

### Q3: 说话人标识未识别
**可能原因**：
- 说话人标识不在文本行开头
- 使用了错误的括号（如中文括号【】）

**正确格式**：
```
[spk01] 文本内容  ✅
【spk01】文本内容  ❌
文本内容 [spk01]  ❌
```

## 手动验证SRT文件

### 方法1：使用文本编辑器
1. 用记事本或VS Code打开SRT文件
2. 检查格式是否正确
3. 确保每个字幕块之间有空行

### 方法2：使用在线工具
访问 SRT 验证网站，上传文件检查格式

### 方法3：使用Python脚本
```python
import re

def validate_srt(file_path):
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    blocks = re.split(r'\n\s*\n', content.strip())
    print(f"总块数: {len(blocks)}")
    
    for i, block in enumerate(blocks[:5]):  # 只检查前5块
        print(f"\n块 {i+1}:")
        print(block)
        print("-" * 50)

validate_srt('your_file.srt')
```

## 修复建议

### 如果是OCR生成的SRT文件
1. 检查OCR输出的格式是否正确
2. 确保说话人标识格式统一
3. 验证时间轴格式

### 如果是手动编辑的SRT文件
1. 使用标准的SRT编辑器
2. 确保每个字幕块格式一致
3. 删除多余的空行

### 如果是从其他软件导出的SRT文件
1. 尝试重新导出
2. 检查导出设置
3. 使用SRT格式转换工具标准化

## 下一步

1. **重启服务**：确保使用最新的代码
2. **测试上传**：先用测试SRT文件验证功能正常
3. **上传实际文件**：查看后端输出的调试信息
4. **提供反馈**：如果仍有问题，提供：
   - 后端完整的输出日志
   - SRT文件的前100行内容
   - 文件来源（OCR/手动/其他软件）

## 联系支持

如果问题持续存在，请提供：
1. 后端控制台的完整输出
2. SRT文件的前500字符（已自动打印）
3. 文件大小和字幕数量
4. 文件来源和生成方式
