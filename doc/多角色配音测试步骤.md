# 多角色配音功能测试步骤

## 问题修复说明

### 修复的问题
1. **说话人检测问题**：修复了正则表达式使用错误，导致只能检测到第一个说话人的问题
2. **角色列表显示问题**：修复了 `getAvailableRoles()` 函数，使其能正确支持多角色配音模式
3. **UI显示优化**：改进了角色映射配置的显示逻辑和提示信息

### 修复内容
- ✅ 修改SRT解析逻辑，使用 `match()` 代替 `exec()` 来正确提取所有说话人
- ✅ 修改 `getAvailableRoles()` 函数，根据当前模式自动选择正确的引擎
- ✅ 优化UI显示，添加未选择引擎时的提示信息

---

## 测试步骤

### 步骤1：刷新页面
1. 保存所有修改的文件
2. 在浏览器中刷新页面（按 F5 或 Ctrl+R）
3. 清除浏览器缓存（按 Ctrl+Shift+Delete）

### 步骤2：进入多角色配音模式
1. 点击顶部的 **"TTS配音"** 标签
2. 点击 **"多角色配音"** 子标签（注意不是"单角色配音"）
3. 确认界面标题显示 **"多角色配音配置"**

### 步骤3：上传SRT文件
1. 点击 **"带说话人标识的SRT文件"** 上传按钮
2. 选择您的SRT文件（如 `字幕说话人分配结果.srt`）
3. 上传后，查看控制台（按F12打开开发者工具）
4. 应该看到类似以下的日志：
   ```
   ✅ 检测到 4 个说话人: ['spk01', 'spk02', 'spk04', 'spk00']
   📋 说话人列表: ['spk01', 'spk02', 'spk04', 'spk00']
   ```

### 步骤4：验证说话人显示
在 **"检测到 X 个说话人"** 区域，应该看到：
- ✅ 所有说话人标签（如 spk01, spk02, spk04, spk00）
- ✅ 每个标签都有紫色背景
- ✅ 显示正确的说话人数量

### 步骤5：选择TTS引擎
1. 在 **"TTS引擎"** 下拉框中选择 **"GPT-SoVITS"**
2. 此时应该看到 **"角色映射配置"** 区域出现

### 步骤6：验证角色映射配置
在 **"角色映射配置"** 区域，应该看到：
- ✅ **每个说话人都有独立的配置卡片**（如果有4个说话人，就应该有4个卡片）
- ✅ 每个卡片显示：
  - 说话人名称（如 spk01）
  - 字幕数量（如 "2402 条字幕"）
  - 配音角色下拉框
- ✅ 每个下拉框中都显示您在TTS模型管理中配置的角色

### 步骤7：配置角色映射
1. 为每个说话人选择一个配音角色
2. 例如：
   - spk00 → 角色A
   - spk01 → 角色B
   - spk02 → 角色A
   - spk04 → 角色C

### 步骤8：调整高级选项（可选）
- 合成语言：中文
- 语速调整：1.0x
- 静音间隔：0.5秒
- 自动对齐时间轴：勾选

### 步骤9：开始配音
1. 确认所有说话人都已分配角色
2. 点击 **"开始多角色配音"** 按钮
3. 观察右侧的进度显示

---

## 预期结果

### 上传SRT后
```
✅ 已上传: 字幕说话人分配结果.srt
   2402 条字幕

👥 检测到 4 个说话人:
   [spk01] [spk02] [spk04] [spk00]
```

### 选择引擎后
```
🔗 角色映射配置 (为每个说话人分配TTS角色)

┌─────────────────────────────────┐
│ 👤 spk01          2402 条字幕   │
│ [请选择配音角色 ▼]              │
│   - 角色示例1                    │
│   - 角色示例2                    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 👤 spk02          1500 条字幕   │
│ [请选择配音角色 ▼]              │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 👤 spk04          800 条字幕    │
│ [请选择配音角色 ▼]              │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 👤 spk00          300 条字幕    │
│ [请选择配音角色 ▼]              │
└─────────────────────────────────┘
```

---

## 常见问题排查

### Q1: 上传SRT后没有检测到说话人
**检查**：
1. 打开浏览器控制台（F12）查看是否有错误
2. 确认SRT文件格式正确，说话人标识在文本行开头
3. 确认使用的是 `[spk01]` 这样的格式

**示例正确格式**：
```srt
1
00:00:00,000 --> 00:00:03,500
[spk01] 这是第一条字幕
```

### Q2: 角色映射配置区域不显示
**检查**：
1. 确认已经上传SRT文件
2. 确认检测到了说话人（查看"检测到 X 个说话人"）
3. 如果没选择引擎，会显示黄色提示框

### Q3: 角色下拉框是空的
**检查**：
1. 确认已在 **"TTS模型管理"** 中配置了角色
2. 确认选择的TTS引擎已启用
3. 刷新页面重新加载配置

### Q4: 只显示一个角色下拉框
**检查**：
1. 确认您在 **"多角色配音"** 标签页，而不是"单角色配音"
2. 查看浏览器控制台，确认 `detectedSpeakers` 数组有多个元素
3. 尝试重新上传SRT文件

---

## 调试技巧

### 查看检测到的说话人
打开浏览器控制台（F12），在上传SRT后应该看到：
```javascript
✅ 检测到 4 个说话人: ['spk01', 'spk02', 'spk04', 'spk00']
📋 说话人列表: ['spk01', 'spk02', 'spk04', 'spk00']
```

### 查看角色配置
在控制台输入：
```javascript
// 查看TTS配置
console.log(ttsConfig.value.gptSovits.roles)

// 查看多角色配音状态
console.log(multiRoleDubbing.value)
```

### 查看角色映射
在控制台输入：
```javascript
console.log(multiRoleDubbing.value.rolesMapping)
```

应该看到类似：
```javascript
{
  "spk01": { name: "角色A", ... },
  "spk02": { name: "角色B", ... },
  "spk04": null,  // 未分配
  "spk00": null   // 未分配
}
```

---

## 成功标志

✅ **功能正常的标志**：
1. 上传SRT后能看到所有说话人标签
2. 选择引擎后能看到每个说话人的配置卡片
3. 每个下拉框都显示TTS模型中配置的角色
4. 可以为每个说话人独立选择不同的角色
5. 所有角色分配完成后，"开始多角色配音"按钮可点击

---

## 测试完成后

如果一切正常，您应该能够：
1. ✅ 为每个说话人分配不同的TTS角色
2. ✅ 开始配音任务
3. ✅ 看到实时进度更新
4. ✅ 获得最终的多角色配音音频

如果仍有问题，请提供：
- 浏览器控制台的错误信息
- 上传的SRT文件示例
- 截图显示当前界面状态
