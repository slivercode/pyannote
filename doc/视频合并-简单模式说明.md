# 视频合并 - 简单模式说明

## 功能概述

新增"简单合并"模式，专门用于只合并视频和音频，不涉及字幕处理。这个模式更快速、更简单，适合只需要替换音轨的场景。

## 使用场景

### 适合使用简单模式

✅ **只需要替换音轨**
- 已经有配音音频
- 不需要字幕
- 快速合并

✅ **音频比视频长**
- 自动慢放视频以匹配音频
- 无需手动调整
- 画面和音频完美同步

✅ **测试和预览**
- 快速查看配音效果
- 不需要字幕烧录
- 节省处理时间

### 不适合使用简单模式

❌ **需要字幕**
- 需要烧录字幕到画面
- 需要嵌入软字幕
- 使用标准模式

❌ **需要混合音轨**
- 保留原音+配音
- 使用标准模式的"混合音轨"

## 使用方法

### 步骤1：选择文件

1. 上传MP4视频文件
2. 上传WAV/MP3音频文件
3. **不需要上传字幕文件**

### 步骤2：选择模式

选择"⚡ 简单合并（视频+音频）"模式

### 步骤3：开始合并

点击"开始合并"按钮

## 功能特性

### 1. 自动慢放视频

当音频比视频长时，系统会自动慢放视频以匹配音频长度。

**示例**：
```
原始视频：85秒
配音音频：170秒

结果：
- 视频慢放2倍 → 170秒
- 音频正常播放 → 170秒
- 完美同步
```

### 2. 三种合并模式

虽然叫"简单合并"，但内部支持三种模式（默认使用"替换"）：

| 模式 | 说明 | 使用场景 |
|------|------|---------|
| replace | 替换音轨 | 默认，最常用 |
| mix | 混合音轨 | 保留原音+新音频 |
| remove | 去除音轨 | 只要视频，无音频 |

当前版本UI只暴露"替换"模式，如需其他模式可通过API调用。

### 3. 快速处理

相比标准模式，简单模式：
- ✅ 不需要处理字幕
- ✅ 不需要字幕烧录
- ✅ 处理速度更快
- ✅ 占用资源更少

## API接口

### 端点

```
POST /api/video-merger/merge-simple
```

### 参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| video | File | 是 | MP4视频文件 |
| audio | File | 是 | WAV/MP3音频文件 |
| mode | string | 否 | 合并模式（默认：replace） |
| enable_slowdown | boolean | 否 | 是否启用自动慢放（默认：true） |
|

### 响应

```json
{
  "task_id": "uuid",
  "message": "视频合并任务已启动",
  "status_url": "/api/video-merger/status/{task_id}"
}
```

### 示例

```javascript
const formData = new FormData();
formData.append('video', videoFile);
formData.append('audio', audioFile);
formData.append('mode', 'replace');
formData.append('enable_slowdown', true);

const response = await axios.post('/api/video-merger/merge-simple', formData);
console.log(response.data.task_id);
```

## 技术实现

### 后端

新增方法：`VideoMerger.merge_video_audio_only()`

**核心逻辑**：
```python
1. 获取视频和音频时长
2. 判断是否需要慢放视频
3. 如果需要：
   - 计算慢放比例 = 音频时长 / 视频时长
   - 使用FFmpeg的setpts和fps滤镜慢放视频
4. 合并视频和音频
5. 输出最终视频
```

**FFmpeg命令示例**：
```bash
ffmpeg -y \
  -i video.mp4 \
  -i audio.wav \
  -filter:v "setpts=2.0*PTS,fps=15" \
  -map 0:v \
  -map 1:a \
  -c:a aac \
  -b:a 192k \
  output.mp4
```

### 前端

**UI改动**：
- 新增"简单合并"选项（绿色边框）
- 更新`canStartVideoMerge()`函数
- 更新`startVideoMerge()`函数

**逻辑流程**：
```javascript
1. 检测是否选择"简单合并"模式
2. 如果是：
   - 调用 /api/video-merger/merge-simple
   - 只上传视频和音频
3. 如果不是：
   - 调用 /api/video-merger/merge
   - 按标准流程处理
```

## 与标准模式的对比

| 特性 | 简单模式 | 标准模式 |
|------|---------|---------|
| 字幕处理 | ❌ 不支持 | ✅ 支持 |
| 自动慢放 | ✅ 支持 | ✅ 支持 |
| 处理速度 | ⚡ 快 | 🐢 较慢 |
| 使用场景 | 只需音频 | 需要字幕 |
| 文件要求 | 视频+音频 | 视频+音频+字幕（可选） |

## 常见问题

### Q1: 简单模式能烧录字幕吗？

**A:** 不能。简单模式专门用于只合并视频和音频。如需字幕，请使用标准模式的"替换音轨+烧录字幕"。

### Q2: 简单模式会保留原音吗？

**A:** 默认不保留。简单模式默认使用"替换"模式，会用新音频替换原音轨。

### Q3: 音频比视频短怎么办？

**A:** 系统不会拉伸音频。视频会播放完整，音频结束后视频继续播放（无声）。

### Q4: 能否禁用自动慢放？

**A:** 当前UI版本默认启用。如需禁用，可通过API调用时设置 `enable_slowdown=false`。

### Q5: 简单模式支持哪些视频格式？

**A:** 
- 视频：MP4
- 音频：WAV, MP3
- 输出：MP4

## 更新日志

- **2024-12-18**: 初始版本
  - 新增简单合并模式
  - 支持自动慢放视频
  - 提供独立API端点
  - 更新前端UI

## 相关文档

- [视频合并快速指南](./视频合并快速指南.md)
- [视频慢放同步功能说明](./视频慢放同步功能说明.md)
- [视频合并工具使用指南](./视频合并工具使用指南.md)
