# 视频合并功能集成说明

## 概述

视频合并功能已成功集成到主界面中，用户可以通过 `start.bat` 启动的主界面直接使用视频合并功能，无需单独启动视频合并服务。

## 功能特点

### 1. 完全集成
- ✅ 集成到主界面的"视频合并"标签页
- ✅ 使用统一的后端服务（FastAPI）
- ✅ 共享文件上传和输出目录
- ✅ 统一的进度监控和任务管理

### 2. 支持的合并模式

#### 🔄 替换音轨 + 烧录字幕（推荐）
- **核心功能**：用TTS生成的音轨完全替换原视频音轨
- **字幕烧录**：如果上传字幕文件，会自动烧录到视频画面中
- **智能音视频同步**：如果TTS音轨比原视频长，自动延长视频以匹配音轨时长
- **使用场景**：
  - 仅替换音轨：只上传视频和音频文件
  - 替换音轨+烧录字幕：上传视频、音频和字幕文件
- **优势**：一步完成音轨替换和字幕烧录，无需分两次操作

#### 🎵 混合音轨
- 保留原视频音轨，与TTS音轨混合
- **智能音视频同步**：自动延长视频以匹配最长的音轨
- 适用于需要保留背景音的场景

#### 📝 嵌入字幕（软字幕）
- 将SRT字幕作为软字幕嵌入视频
- **智能音视频同步**：支持音轨延长时的字幕同步
- 播放器可以选择开关字幕
- 适用于需要灵活控制字幕显示的场景

#### 🔇 去除音轨
- 仅移除原视频的音轨
- 生成静音视频

#### 📹 仅视频
- 提取纯视频流，不包含音频
- 用于视频处理

### 3. 智能视频慢放同步技术

#### 🎯 核心原理
- **自动检测时长差异**：比较原视频和TTS音轨的时长
- **智能视频慢放**：当TTS音轨较长时，自动慢放视频画面以匹配音轨时长
- **计算拉伸系数**：拉伸系数 = 音轨时长 / 视频时长
- **匀速拉长画面**：使用FFmpeg的`setpts`滤镜实现画面慢放
- **完美同步**：视频时长自动匹配音轨时长，无黑屏、无静止

#### 🔧 技术实现
```bash
# 示例：TTS音轨45秒，原视频30秒
# 拉伸系数 = 45 / 30 = 1.5x

ffmpeg -i video.mp4 -i audio.wav \
  -filter_complex "[0:v]setpts=1.5*PTS[vout]" \
  -map "[vout]" -map "1:a" \
  -c:v libx264 -c:a aac output.mp4

# 结果：
# - 视频慢放1.5倍，时长从30秒变为45秒
# - 音轨完整播放45秒
# - 视频和音轨完美同步
# - 画面流畅播放，无静止、无黑屏
```

#### 📊 处理场景

**场景1：TTS音轨较长（自动慢放）**
```
原视频: 30秒
TTS音轨: 45秒
拉伸系数: 1.5x

处理：
- 视频慢放1.5倍 → 30秒变为45秒
- 音轨正常播放45秒
- 完美同步，无黑屏

效果：
✅ 画面流畅播放（慢放50%）
✅ 音视频完美同步
✅ 无静止、无黑屏
```

**场景2：TTS音轨较短**
```
原视频: 45秒
TTS音轨: 30秒

处理：
- 视频正常播放45秒
- 音轨播放30秒后静音

效果：
✅ 正常播放
```

**场景3：时长相近**
```
原视频: 30秒
TTS音轨: 30.5秒

处理：
- 直接合并，无需慢放

效果：
✅ 正常播放
```

#### 🎬 慢放效果说明

**拉伸系数对照表**

| 原视频 | 音轨 | 拉伸系数 | 慢放程度 | 效果 |
|--------|------|---------|---------|------|
| 30秒 | 33秒 | 1.1x | 慢10% | 几乎察觉不到 |
| 30秒 | 36秒 | 1.2x | 慢20% | 轻微慢放 |
| 30秒 | 45秒 | 1.5x | 慢50% | 明显慢放 |
| 30秒 | 60秒 | 2.0x | 慢100% | 显著慢放 |

**建议**：
- ✅ 拉伸系数 < 1.3x：效果自然，推荐
- ⚠️ 拉伸系数 1.3x - 1.5x：可接受
- ❌ 拉伸系数 > 1.5x：慢放明显，建议优化TTS音轨

#### 💡 最佳实践

**方案A：自动慢放（推荐）**
```
适用场景：
- 音轨比视频长不超过50%
- 可接受轻微的慢放效果
- 追求操作简便

优势：
✅ 一键完成，无需手动调整
✅ 画面流畅，无静止无黑屏
✅ 音视频完美同步
```

**方案B：TTS时长控制（最佳）**
```
适用场景：
- 追求完美的播放速度
- 不希望视频慢放
- 有时间进行两步操作

操作：
1. TTS配音时启用"保持SRT总时长"
2. 视频合并时无需慢放

优势：
✅ 视频正常速度播放
✅ 音视频时长完全匹配
✅ 最佳观看体验
```

### 3. 高级选项
- **去除原始音轨**：推荐开启，避免音轨冲突
- **自动模式检测**：根据上传文件自动调整必需文件要求

## 使用方法

### 1. 启动服务
```bash
# 运行主服务（包含视频合并功能）
start.bat
```

### 2. 访问界面
1. 浏览器自动打开主界面
2. 点击"视频合并"标签页
3. 开始使用视频合并功能

### 3. 操作步骤
1. **上传视频文件**：选择MP4格式的视频文件（必需）
2. **上传音频文件**：选择WAV/MP3格式的音频文件（可选，取决于合并模式）
3. **上传字幕文件**：选择SRT格式的字幕文件（可选，取决于合并模式）
4. **选择合并模式**：根据需求选择合适的合并模式
5. **配置高级选项**：设置是否去除原始音轨等
6. **开始合并**：点击"开始合并"按钮
7. **监控进度**：实时查看合并进度
8. **下载结果**：合并完成后下载或预览结果

## API接口

### 合并视频
```
POST /api/video-merger/merge
```

**参数：**
- `video`: MP4视频文件（必需）
- `audio`: WAV/MP3音频文件（可选）
- `subtitle`: SRT字幕文件（可选）
- `mode`: 合并模式（默认：replace_audio）
- `remove_original_audio`: 是否去除原音轨（默认：true）

### 查询状态
```
GET /api/video-merger/status/{task_id}
```

### 下载结果
```
GET /api/video-merger/download/{filename}
```

### 获取视频信息
```
POST /api/video-merger/info
```

## 技术实现

### 1. 后端集成
- 在 `src/main.py` 中集成视频合并API
- 使用现有的 `VideoMerger` 类
- 共享FFmpeg配置和路径

### 2. 前端集成
- 在主界面 `src/static/index.html` 中添加视频合并标签页
- 使用Vue.js响应式数据管理
- 实时进度监控和状态更新

### 3. 文件管理
- 使用统一的 `input` 和 `output` 目录
- 自动清理临时文件
- 支持大文件上传

## 故障排除

### 1. FFmpeg相关问题
```
⚠️ 视频合并器初始化失败: FFmpeg不可用
```
**解决方案：**
- 确保 `ffmpeg/bin/ffmpeg.exe` 存在
- 检查FFmpeg是否正确安装

### 2. 文件上传问题
```
❌ 启动视频合并任务失败: 文件保存失败
```
**解决方案：**
- 检查磁盘空间是否充足
- 确保有写入权限
- 检查文件格式是否支持

### 3. 合并失败
```
❌ 视频合并任务失败: FFmpeg执行失败
```
**解决方案：**
- 检查输入文件是否损坏
- 确认文件格式兼容性
- 查看详细错误日志

### 4. 音视频同步问题

#### 问题：视频没有延长，音轨被截断
```
📹 原视频时长: 30.00秒
🎵 音轨时长: 45.00秒
❌ 输出视频只有30秒，音轨被截断
```
**解决方案：**
- 确保使用最新版本的视频合并器
- 检查FFmpeg版本是否支持loop滤镜
- 查看控制台输出确认是否检测到时长差异

#### 问题：视频延长但画面卡住
```
✅ 视频延长到45秒
❌ 30秒后画面静止不动
```
**说明：** 这是正常行为，系统循环播放最后一帧来延长视频

#### 问题：音频不同步
```
❌ 音频和视频时间轴不匹配
```
**解决方案：**
- 检查原始文件是否已经存在同步问题
- 确认TTS音轨是否从0秒开始
- 使用 `-avoid_negative_ts make_zero` 参数（已自动添加）

#### 问题：混合音轨模式音量不平衡
```
❌ 原音轨太大声或TTS音轨太小声
```
**解决方案：**
- 在TTS生成阶段调整音量
- 使用专业音频编辑软件预处理音轨
- 考虑使用替换音轨模式而非混合模式

## 性能优化

### 1. 文件大小限制
- 建议视频文件不超过500MB
- 音频文件不超过100MB
- 字幕文件不超过1MB

### 2. 处理时间
- 替换音轨：通常1-2分钟
- 混合音轨：通常2-3分钟
- 烧录字幕：通常5-10分钟（取决于视频长度）

### 3. 系统要求
- 推荐4GB以上内存
- 推荐SSD硬盘
- 支持硬件加速的显卡（可选）

## 更新日志

### v1.4.0 (2024-12-17) - 智能视频慢放同步
- 🎯 **核心功能：视频慢放同步**
  - 当TTS音轨比视频长时，自动慢放视频画面以匹配音轨时长
  - 使用FFmpeg的`setpts`滤镜实现匀速慢放
  - 自动计算拉伸系数：拉伸系数 = 音轨时长 / 视频时长
- 🎬 **完美同步效果**
  - 画面流畅播放，无静止、无黑屏
  - 音视频时长完全匹配
  - 字幕正确同步显示
- 📊 **智能处理**
  - 拉伸系数 < 1.3x：效果自然，几乎察觉不到
  - 拉伸系数 1.3x - 1.5x：轻微慢放，可接受
  - 拉伸系数 > 1.5x：明显慢放，建议优化TTS音轨
- 🔧 **技术实现**
  - 替换音轨模式：支持视频慢放 + 字幕烧录
  - 混合音轨模式：支持视频慢放 + 原音轨慢放 + 音频混合
  - 嵌入字幕模式：支持视频慢放 + 软字幕嵌入
- 💡 **使用建议**
  - 推荐方案A：直接使用自动慢放（简单快捷）
  - 推荐方案B：TTS时长控制 + 视频合并（最佳效果）

### v1.3.0 (2024-12-17) - 视频播放优化
- 🎯 **修复视频静止问题**
  - 移除视频延长逻辑，避免画面静止
  - 视频保持原长度，正常播放
  - 音轨完整播放，不被截断
- 📋 **处理逻辑优化**
  - 当音轨较长时，视频正常播放，音轨完整播放
  - 视频结束后显示黑屏，音轨继续播放
  - 移除`-shortest`参数，确保音轨不被截断
- 💡 **使用建议**
  - 推荐使用TTS配音模块的"保持SRT总时长"功能
  - 让TTS音轨时长与原视频时长匹配
  - 避免视频结束后的黑屏问题
- 📚 **文档更新**
  - 更新技术实现说明
  - 添加推荐工作流程
  - 详细的时长匹配指南

### v1.2.0 (2024-12-17) - 字幕烧录优化
- 🎯 **合并功能优化**
  - 将"替换音轨"和"烧录字幕"合并为一个选项
  - 上传字幕文件时自动烧录到视频画面
  - 简化用户操作流程，一步完成音轨替换和字幕烧录
- 🔧 **字幕烧录修复**
  - 修复字幕无法烧录的问题
  - 修复视频与字幕不同步的问题
  - 优化字幕路径处理，支持Windows路径
- 📋 **界面优化**
  - 简化合并模式选项（从6个减少到5个）
  - 更清晰的模式说明和使用提示
  - 突出显示推荐模式
- 🧪 **测试工具**
  - 添加 `test_subtitle_burn.py` 字幕烧录测试脚本
  - 提供示例SRT字幕文件生成功能
  - 详细的字幕格式说明

### v1.1.0 (2024-12-17) - 音视频同步更新
- 🎯 **新增智能音视频同步功能**
  - 自动检测TTS音轨和原视频的时长差异
  - 当TTS音轨较长时，自动延长视频以匹配音轨时长
  - 使用FFmpeg loop滤镜循环播放最后一帧
- 🔧 **技术改进**
  - 移除 `-shortest` 参数，避免以最短流为准
  - 添加 `get_media_duration()` 方法获取精确时长
  - 音频混合使用 `duration=longest` 保持最长流
  - 添加 `-avoid_negative_ts make_zero` 避免时间戳问题
- 📋 **支持的同步模式**
  - 替换音轨：智能视频延长
  - 混合音轨：以最长音轨为准
  - 嵌入字幕：延长时字幕正确同步
  - 烧录字幕：延长时字幕正确显示
- 🧪 **测试和文档**
  - 添加 `test_video_sync.py` 测试脚本
  - 完善故障排除指南
  - 详细的技术实现说明

### v1.0.0 (2024-12-17)
- ✅ 完成视频合并功能集成
- ✅ 支持6种合并模式
- ✅ 实时进度监控
- ✅ 统一的文件管理
- ✅ 完整的错误处理

## 相关文件

- `src/main.py` - 主服务和视频合并API
- `src/scripts/video_merger.py` - 视频合并核心逻辑
- `src/static/index.html` - 主界面和视频合并UI
- `doc/视频合并工具使用指南.md` - 详细使用指南