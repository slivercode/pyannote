# 字幕自动调整功能说明

## 功能概述

当启用"移除静音间隙"选项时，系统会自动调整字幕时间轴以匹配实际生成的TTS音频长度。这个功能特别适合跨语言配音场景（如中文字幕配日语音频）。

## 使用场景

### 典型问题
- 原始视频：85秒，中文字幕
- 日语配音后：170秒（日语表达比中文长）
- 问题：字幕时间轴仍然是85秒，与170秒的音频不匹配

### 解决方案
启用"移除静音间隙"后，系统会：
1. 生成TTS音频（移除对话间的静音间隙）
2. 测量实际音频总时长
3. 自动拉伸字幕时间轴以匹配音频
4. 导出调整后的字幕文件

## 工作原理

### 移除静音间隙的智能处理

启用"移除静音间隙"后，系统会：
1. **移除大间隙**：移除字幕之间的长时间静音（如5秒、10秒的空白）
2. **保留自然停顿**：保留短暂的自然停顿（最多300ms），让对话听起来自然
3. **紧凑拼接**：将所有配音片段紧密拼接，减少总时长

**示例**：
```
原始时间轴：
字幕1: 0-3秒 → [静音5秒] → 字幕2: 8-11秒 → [静音2秒] → 字幕3: 13-16秒

移除静音间隙后：
字幕1: 0-3秒 → [停顿0.3秒] → 字幕2: 3.3-6.3秒 → [停顿0.3秒] → 字幕3: 6.6-9.6秒
```

### 方案A：智能字幕时间轴拉伸

```
1. TTS生成完成后，获取实际音频总时长（如170秒）
2. 读取原始SRT字幕总时长（如85秒）
3. 计算拉伸比例：ratio = 170 / 85 = 2.0
4. 遍历每条字幕，将时间戳乘以ratio：
   - 原始: 00:00:05,000 --> 00:00:08,000
   - 调整后: 00:00:10,000 --> 00:00:16,000
5. 生成新的SRT文件：adjusted_subtitles.srt
```

### 触发条件

只有当满足以下条件时才会调整字幕：
- 启用了"移除静音间隙"选项
- 实际音频时长 > 原始字幕时长 × 1.1（超过10%）

如果音频与字幕时长差异小于10%，系统认为无需调整。

## 使用方法

### 单角色配音

1. 进入"TTS配音" → "单角色配音"
2. 上传SRT字幕文件
3. 选择TTS引擎和配音角色
4. **勾选"移除静音间隙（推荐）"**
5. 点击"开始配音"

### 多角色配音

1. 进入"TTS配音" → "多角色配音"
2. 上传带说话人标记的SRT文件
3. 为每个角色配置TTS设置
4. **勾选"移除静音间隙（推荐）"**
5. 点击"开始配音"

## 输出文件

配音完成后，会生成以下文件：

```
output/
├── dubbing_result.wav              # 最终音频（移除了静音间隙）
└── adjusted_subtitles.srt          # 调整后的字幕（时间轴已拉伸）
```

### 字幕文件说明

**adjusted_subtitles.srt**：
- 时间轴已按比例拉伸
- 保留了原始文本内容
- 保留了说话人标记（如果有）
- 可直接用于视频合并模块烧录

## 实际效果示例

### 场景1：日语配音（拉伸1.7倍）

**原始字幕（10秒）：**
```srt
1
00:00:00,000 --> 00:00:02,000
你好，欢迎来到这里

2
00:00:02,500 --> 00:00:05,000
今天我们要介绍一个新功能
```

**调整后字幕（17秒）：**
```srt
1
00:00:00,000 --> 00:00:03,400
你好，欢迎来到这里

2
00:00:04,250 --> 00:00:08,500
今天我们要介绍一个新功能
```

### 场景2：差异小于10%（无需调整）

- 原始字幕：10秒
- 实际音频：10.5秒
- 差异：5%（< 10%）
- 结果：不生成adjusted_subtitles.srt

## 与视频合并的配合

调整后的字幕可以直接用于视频合并：

1. 进入"视频合并"模块
2. 上传原始视频
3. 上传 `dubbing_result.wav`（配音音频）
4. 上传 `adjusted_subtitles.srt`（调整后的字幕）
5. 选择"替换音轨并烧录字幕"
6. 系统会自动慢放视频以匹配音频长度

**最终效果**：
- 视频画面慢放（如1.7倍慢速）
- 音频正常播放
- 字幕时间轴与音频完美同步

## 技术细节

### 拉伸算法

```python
stretch_ratio = audio_duration_ms / original_duration_ms

for subtitle in subtitles:
    new_start_ms = int(start_ms * stretch_ratio)
    new_end_ms = int(end_ms * stretch_ratio)
```

### 优点
- 简单直接，保持字幕相对时间关系
- 适合整体语速差异的场景
- 不需要复杂的对齐算法
- 计算速度快

### 限制
- 假设语速差异是均匀的
- 如果某些片段差异特别大，可能不够精确
- 未来可以升级为基于音频片段的精确对齐（方案B）

## 日志输出示例

```
📊 移除静音间隙模式:
   实际音频时长: 17.00秒 (17000ms)

🎯 自动调整字幕时间轴（方案A）:
   原始字幕时长: 10.00秒 (10000ms)
   实际音频时长: 17.00秒 (17000ms)
   拉伸比例: 1.70x

✅ 字幕时间轴调整完成:
   调整后总时长: 17.00秒 (17000ms)
   与音频差异: 0ms
   保存位置: output/adjusted_subtitles.srt
```

## 常见问题

### Q1: 为什么我没有看到adjusted_subtitles.srt？

**A:** 可能的原因：
1. 没有勾选"移除静音间隙"选项
2. 音频与字幕时长差异小于10%（无需调整）
3. 使用了"保持SRT总时长不变"功能（会生成updated_subtitles.srt）

### Q2: 调整后的字幕能用于其他视频编辑软件吗？

**A:** 可以！adjusted_subtitles.srt是标准的SRT格式，可以导入到：
- Premiere Pro
- Final Cut Pro
- DaVinci Resolve
- 剪映
- 等任何支持SRT的软件

### Q3: 如果我想手动调整字幕怎么办？

**A:** 你可以：
1. 用文本编辑器打开adjusted_subtitles.srt
2. 手动修改时间戳
3. 保存后重新上传到视频合并模块

### Q4: 这个功能会影响音质吗？

**A:** 不会。这个功能只调整字幕文件的时间戳，不会对音频进行任何处理。

## 最佳实践

### 跨语言配音推荐设置

```
✅ 移除静音间隙：勾选
✅ 保持SRT总时长不变：不勾选
✅ TTS生成语速：1.0x（让TTS自然生成）
```

### 同语言配音推荐设置

```
❌ 移除静音间隙：不勾选
✅ 保持SRT总时长不变：勾选
✅ TTS生成语速：根据需要调整
```

## 更新日志

- **2024-12-18**: 初始版本，实现方案A（智能字幕时间轴拉伸）
- 支持单角色和多角色配音
- 自动检测是否需要调整（10%阈值）
- 保留说话人标记

## 未来计划

- **方案B**：基于音频片段的精确对齐
  - 记录每个片段的实际时长
  - 逐条精确调整字幕时间轴
  - 适合语速差异不均匀的场景
