# 视频慢放同步功能说明

## 🎯 功能概述

当TTS音轨比原视频长时，系统会自动**慢放视频画面**来匹配音轨时长，实现完美的音视频同步。

### 核心思路
```
音轨先定死 → 计算拉伸系数 → 画面匀速慢放 → 完美同步
```

## 🔧 技术原理

### 1. 计算拉伸系数
```python
拉伸系数 = 音轨时长 / 视频时长

示例：
- 原视频：30秒
- TTS音轨：45秒
- 拉伸系数：45 / 30 = 1.5x
```

### 2. 使用setpts+fps滤镜慢放视频
```bash
# 假设原视频30fps，需要慢放1.5倍
# 目标帧率 = 30 / 1.5 = 20fps
ffmpeg -i input.mp4 -i audio.wav \
  -filter_complex "[0:v]setpts=1.5*PTS,fps=20[vout]" \
  -map "[vout]" -map "1:a" \
  -c:v libx264 -c:a aac output.mp4
```

**滤镜组合说明**：
- `PTS` = Presentation Time Stamp（显示时间戳）
- `setpts=1.5*PTS` = 每一帧的时间戳乘以1.5
- `fps=20` = 设置目标帧率为20fps（原30fps ÷ 1.5）
- 效果：视频时长从30秒变为45秒（慢放50%）
- **关键**：必须同时调整时间戳和帧率，否则画面会静止
- **注意**：`fps` 参数必须是具体数值，不能使用 `fps/1.5` 表达式

### 3. 字幕同步处理
```bash
# 慢放视频 + 烧录字幕
# 假设原视频30fps，慢放1.5倍，目标帧率20fps
ffmpeg -i input.mp4 -i audio.wav \
  -filter_complex "[0:v]setpts=1.5*PTS,fps=20,subtitles='subtitle.srt'[vout]" \
  -map "[vout]" -map "1:a" \
  -c:v libx264 -c:a aac output.mp4
```

字幕会自动跟随视频慢放，保持同步。

**重要提示**：
- 必须同时使用 `setpts` 和 `fps` 滤镜，否则会出现画面静止的问题
- `fps` 参数必须是具体数值（如20），不能使用表达式（如fps/1.5）
- 系统会自动获取原视频帧率并计算目标帧率

## 📊 拉伸系数效果对照

### 轻微慢放（推荐）
| 原视频 | 音轨 | 拉伸系数 | 慢放程度 | 观感 |
|--------|------|---------|---------|------|
| 30秒 | 33秒 | 1.1x | 慢10% | ✅ 几乎察觉不到 |
| 30秒 | 36秒 | 1.2x | 慢20% | ✅ 轻微慢放，自然 |
| 30秒 | 39秒 | 1.3x | 慢30% | ✅ 可接受 |

### 中度慢放（可接受）
| 原视频 | 音轨 | 拉伸系数 | 慢放程度 | 观感 |
|--------|------|---------|---------|------|
| 30秒 | 42秒 | 1.4x | 慢40% | ⚠️ 明显但可接受 |
| 30秒 | 45秒 | 1.5x | 慢50% | ⚠️ 明显慢放 |

### 显著慢放（不推荐）
| 原视频 | 音轨 | 拉伸系数 | 慢放程度 | 观感 |
|--------|------|---------|---------|------|
| 30秒 | 54秒 | 1.8x | 慢80% | ❌ 非常明显 |
| 30秒 | 60秒 | 2.0x | 慢100% | ❌ 显著慢放 |

## 🎬 实际应用场景

### 场景1：轻微慢放（最佳）
```
原视频：1分50秒 (110秒)
TTS音轨：2分10秒 (130秒)
拉伸系数：1.18x

效果：
✅ 视频慢放18%
✅ 观感自然，几乎察觉不到
✅ 音视频完美同步
✅ 字幕正确显示

推荐：直接使用，无需优化
```

### 场景2：中度慢放（可接受）
```
原视频：1分50秒 (110秒)
TTS音轨：2分40秒 (160秒)
拉伸系数：1.45x

效果：
⚠️ 视频慢放45%
⚠️ 慢放明显但可接受
✅ 音视频完美同步
✅ 字幕正确显示

建议：
- 可直接使用
- 或优化TTS音轨时长
```

### 场景3：显著慢放（需优化）
```
原视频：1分50秒 (110秒)
TTS音轨：3分40秒 (220秒)
拉伸系数：2.0x

效果：
❌ 视频慢放100%（慢一倍）
❌ 慢放非常明显
✅ 音视频完美同步
✅ 字幕正确显示

建议：优化TTS音轨时长
- 使用TTS配音模块的"保持SRT总时长"功能
- 或手动加速TTS音轨
```

## 💡 最佳实践

### 方案A：自动慢放（简单快捷）

**适用场景**：
- 拉伸系数 < 1.5x
- 可接受轻微慢放效果
- 追求操作简便

**操作步骤**：
```
1. 上传原视频
2. 上传TTS音轨
3. 上传字幕文件（可选）
4. 选择"替换音轨 + 烧录字幕"
5. 开始合并

系统自动：
- 检测时长差异
- 计算拉伸系数
- 慢放视频画面
- 烧录字幕
- 完美同步
```

**优势**：
- ✅ 一键完成
- ✅ 无黑屏、无静止
- ✅ 音视频完美同步
- ✅ 字幕正确显示

### 方案B：TTS时长控制（最佳效果）

**适用场景**：
- 追求完美播放速度
- 不希望视频慢放
- 拉伸系数会 > 1.5x

**操作步骤**：
```
步骤1：TTS配音（控制时长）
1. 上传原视频的SRT字幕
2. 启用"保持SRT总时长不变"
3. 设置最大加速倍率（1.5x-2.0x）
4. 生成TTS音轨
   → 系统自动调整音轨时长匹配原视频

步骤2：视频合并
1. 上传原视频
2. 上传TTS音轨（时长已匹配）
3. 上传字幕文件
4. 选择"替换音轨 + 烧录字幕"
5. 开始合并
   → 无需慢放或仅轻微慢放
```

**优势**：
- ✅ 视频正常速度播放
- ✅ 音视频时长完全匹配
- ✅ 最佳观看体验
- ✅ 配音清晰流畅

## 🔍 技术细节

### 1. 替换音轨模式

**无字幕**：
```python
if need_stretch:
    # 获取原视频帧率并计算目标帧率
    original_fps = self._get_video_fps(video_path)
    target_fps = original_fps / stretch_ratio
    
    # 仅慢放视频
    # 关键：同时调整时间戳和帧率
    video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps={target_fps}[vout]"
    cmd.extend([
        "-filter_complex", video_filter,
        "-map", "[vout]",
        "-map", "1:a",
    ])
```

**有字幕**：
```python
if need_stretch:
    # 获取原视频帧率并计算目标帧率
    original_fps = self._get_video_fps(video_path)
    target_fps = original_fps / stretch_ratio
    
    # 慢放视频 + 烧录字幕
    # 关键：同时调整时间戳和帧率
    video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps={target_fps},subtitles='{subtitle_path}'[vout]"
    cmd.extend([
        "-filter_complex", video_filter,
        "-map", "[vout]",
        "-map", "1:a",
    ])
```

### 2. 混合音轨模式

```python
if need_stretch:
    # 获取原视频帧率并计算目标帧率
    original_fps = self._get_video_fps(video_path)
    target_fps = original_fps / stretch_ratio
    
    # 慢放视频 + 慢放原音轨 + 混合音频
    # 关键：同时调整时间戳和帧率
    filter_complex = f"""
    [0:v]setpts={stretch_ratio}*PTS,fps={target_fps}[vout];
    [0:a]atempo={1/stretch_ratio}[a0];
    [a0][1:a]amix=inputs=2:duration=longest[aout]
    """
    cmd.extend([
        "-filter_complex", filter_complex,
        "-map", "[vout]",
        "-map", "[aout]",
    ])
```

**注意**：
- 原视频音轨也需要慢放以匹配视频速度
- 视频必须同时调整时间戳和帧率
- fps参数必须是具体数值，不能使用表达式

### 3. 嵌入字幕模式

```python
if need_stretch:
    # 获取原视频帧率并计算目标帧率
    original_fps = self._get_video_fps(video_path)
    target_fps = original_fps / stretch_ratio
    
    # 慢放视频 + 嵌入软字幕
    # 关键：同时调整时间戳和帧率
    video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps={target_fps}[vout]"
    cmd.extend([
        "-filter_complex", video_filter,
        "-map", "[vout]",
        "-map", "1:a",
        "-map", "2:s",
    ])
```

## 🧪 测试验证

### 测试1：轻微慢放
```
输入：
- 视频：30秒
- 音轨：36秒
- 字幕：有

处理：
- 拉伸系数：1.2x
- 视频慢放20%

结果：
✅ 视频流畅播放36秒
✅ 音轨完整播放36秒
✅ 字幕正确显示
✅ 慢放效果自然
```

### 测试2：中度慢放
```
输入：
- 视频：30秒
- 音轨：45秒
- 字幕：有

处理：
- 拉伸系数：1.5x
- 视频慢放50%

结果：
✅ 视频流畅播放45秒
✅ 音轨完整播放45秒
✅ 字幕正确显示
⚠️ 慢放明显但可接受
```

### 测试3：显著慢放
```
输入：
- 视频：30秒
- 音轨：60秒
- 字幕：有

处理：
- 拉伸系数：2.0x
- 视频慢放100%

结果：
✅ 视频流畅播放60秒
✅ 音轨完整播放60秒
✅ 字幕正确显示
❌ 慢放非常明显

建议：优化TTS音轨时长
```

## 📋 常见问题

### Q1：慢放会影响视频质量吗？
```
A：不会。慢放只是改变播放速度，不会降低画质。
   系统使用libx264编码器，保持原视频质量。
```

### Q2：字幕会跟随慢放吗？
```
A：会。字幕时间轴会自动跟随视频慢放，保持同步。
```

### Q3：原视频有音轨怎么办？
```
A：
- 替换音轨模式：原音轨被移除
- 混合音轨模式：原音轨也会慢放，然后与TTS音轨混合
```

### Q4：如何避免慢放？
```
A：使用TTS配音模块的"保持SRT总时长"功能
   在配音阶段就控制好音轨时长，使其与视频时长匹配
```

### Q5：拉伸系数有上限吗？
```
A：技术上没有上限，但建议：
   ✅ < 1.3x：推荐
   ⚠️ 1.3x - 1.5x：可接受
   ❌ > 1.5x：不推荐，建议优化TTS音轨
```

## 🎓 总结

### 核心优势
- ✅ 画面流畅播放，无静止、无黑屏
- ✅ 音视频完美同步
- ✅ 字幕正确显示
- ✅ 一键完成，操作简单

### 使用建议
- **轻微慢放（< 1.3x）**：直接使用，效果自然
- **中度慢放（1.3x - 1.5x）**：可接受，或优化TTS
- **显著慢放（> 1.5x）**：建议使用TTS时长控制

### 最佳工作流程
```
TTS配音（启用"保持SRT总时长"）
    ↓
生成时长匹配的TTS音轨
    ↓
视频合并（无需慢放或仅轻微慢放）
    ↓
完美的音视频同步效果
```
