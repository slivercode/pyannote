# å­—å¹•è‡ªåŠ¨è°ƒæ•´åŠŸèƒ½ - å®ç°æ€»ç»“

## å®ç°æ—¥æœŸ
2024-12-18

## åŠŸèƒ½æ¦‚è¿°

åœ¨TTSé…éŸ³æ¨¡å—ä¸­å®ç°äº†"å­—å¹•è‡ªåŠ¨è°ƒæ•´"åŠŸèƒ½ï¼ˆæ–¹æ¡ˆAï¼‰ã€‚å½“ç”¨æˆ·å‹¾é€‰"ç§»é™¤é™éŸ³é—´éš™"é€‰é¡¹æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®å®é™…ç”Ÿæˆçš„éŸ³é¢‘æ—¶é•¿ï¼ŒæŒ‰æ¯”ä¾‹æ‹‰ä¼¸å­—å¹•æ—¶é—´è½´ï¼Œå¹¶å¯¼å‡ºè°ƒæ•´åçš„å­—å¹•æ–‡ä»¶ã€‚

## æ ¸å¿ƒå®ç°

### 1. æ–°å¢æ–¹æ³•ï¼š`_adjust_subtitle_timeline_for_audio()`

**ä½ç½®**ï¼š
- `src/scripts/tts_dubbing_processor.py`

**åŠŸèƒ½**ï¼š
- è§£æåŸå§‹SRTæ–‡ä»¶
- è®¡ç®—éŸ³é¢‘ä¸å­—å¹•çš„æ—¶é•¿å·®å¼‚
- åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´ï¼ˆå·®å¼‚>10%ï¼‰
- æŒ‰æ¯”ä¾‹æ‹‰ä¼¸æ‰€æœ‰å­—å¹•æ—¶é—´æˆ³
- ä¿å­˜ä¸º `adjusted_subtitles.srt`

**ç®—æ³•**ï¼š
```python
stretch_ratio = audio_duration_ms / original_duration_ms

for subtitle in subtitles:
    new_start_ms = int(start_ms * stretch_ratio)
    new_end_ms = int(end_ms * stretch_ratio)
```

### 2. ä¿®æ”¹ä¼ ç»Ÿæ‹¼æ¥éŸ³é¢‘é€»è¾‘

**ä½ç½®**ï¼š
- `src/scripts/tts_dubbing_processor.py` - `process()` æ–¹æ³•
- `src/scripts/tts_multi_role_dubbing.py` - `process()` æ–¹æ³•

**æ”¹åŠ¨**ï¼š
```python
# åŸæ¥ï¼šæ€»æ˜¯æ·»åŠ é™éŸ³é—´éš™
if start_ms > last_end_time:
    audio_segments.append(self.create_silence(silence_duration))

# ç°åœ¨ï¼šæ ¹æ®remove_silent_gapså†³å®š
if not self.remove_silent_gaps and start_ms > last_end_time:
    audio_segments.append(self.create_silence(silence_duration))
```

**æ–°å¢é€»è¾‘**ï¼š
```python
# å¦‚æœå¯ç”¨äº†ç§»é™¤é™éŸ³é—´éš™ï¼Œè‡ªåŠ¨è°ƒæ•´å­—å¹•æ—¶é—´è½´
if self.remove_silent_gaps:
    actual_audio_duration_ms = len(final_audio)
    updated_srt_path = self._adjust_subtitle_timeline_for_audio(
        self.srt_path, 
        actual_audio_duration_ms
    )
```

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. src/scripts/tts_dubbing_processor.py

**æ–°å¢**ï¼š
- `_adjust_subtitle_timeline_for_audio()` æ–¹æ³•ï¼ˆçº¦80è¡Œï¼‰

**ä¿®æ”¹**ï¼š
- `process()` æ–¹æ³•ä¸­çš„ä¼ ç»Ÿæ‹¼æ¥éŸ³é¢‘éƒ¨åˆ†ï¼ˆçº¦30è¡Œï¼‰

### 2. src/scripts/tts_multi_role_dubbing.py

**ä¿®æ”¹**ï¼š
- `process()` æ–¹æ³•ä¸­çš„ä¼ ç»Ÿæ‹¼æ¥éŸ³é¢‘éƒ¨åˆ†ï¼ˆçº¦30è¡Œï¼‰
- è°ƒç”¨ `processor._adjust_subtitle_timeline_for_audio()`

### 3. æµ‹è¯•æ–‡ä»¶

**æ–°å¢**ï¼š
- `test_subtitle_auto_adjust.py` - åŠŸèƒ½æµ‹è¯•è„šæœ¬

### 4. æ–‡æ¡£

**æ–°å¢**ï¼š
- `doc/å­—å¹•è‡ªåŠ¨è°ƒæ•´åŠŸèƒ½è¯´æ˜.md` - è¯¦ç»†åŠŸèƒ½è¯´æ˜
- `doc/è·¨è¯­è¨€é…éŸ³å®Œæ•´æµç¨‹.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `doc/å­—å¹•è‡ªåŠ¨è°ƒæ•´åŠŸèƒ½-å®ç°æ€»ç»“.md` - æœ¬æ–‡æ¡£

## å·¥ä½œæµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹

```
1. è¿›å…¥TTSé…éŸ³æ¨¡å—
   â†“
2. ä¸Šä¼ SRTå­—å¹•æ–‡ä»¶
   â†“
3. å‹¾é€‰"ç§»é™¤é™éŸ³é—´éš™"
   â†“
4. ç‚¹å‡»"å¼€å§‹é…éŸ³"
   â†“
5. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - ç”ŸæˆTTSéŸ³é¢‘ï¼ˆç§»é™¤é™éŸ³ï¼‰
   - æµ‹é‡å®é™…éŸ³é¢‘æ—¶é•¿
   - æ‹‰ä¼¸å­—å¹•æ—¶é—´è½´
   - å¯¼å‡ºadjusted_subtitles.srt
   â†“
6. è·å¾—è¾“å‡ºï¼š
   - dubbing_result.wav
   - adjusted_subtitles.srt
```

### ç³»ç»Ÿå¤„ç†æµç¨‹

```python
# 1. ç”ŸæˆTTSéŸ³é¢‘ç‰‡æ®µ
for subtitle in subtitles:
    audio_file = synthesize_speech(subtitle['text'])
    audio_files.append(audio_file)

# 2. æ‹¼æ¥éŸ³é¢‘ï¼ˆç§»é™¤é™éŸ³é—´éš™ï¼‰
if remove_silent_gaps:
    # ç›´æ¥æ‹¼æ¥ï¼Œä¸æ·»åŠ é—´éš™
    for audio_file in audio_files:
        audio_segments.append(load_audio(audio_file))
else:
    # ä¿ç•™æ—¶é—´è½´ï¼Œæ·»åŠ é—´éš™
    for audio_file in audio_files:
        add_silence_if_needed()
        audio_segments.append(load_audio(audio_file))

# 3. å¯¼å‡ºæœ€ç»ˆéŸ³é¢‘
final_audio = concatenate(audio_segments)
final_audio.export("dubbing_result.wav")

# 4. è‡ªåŠ¨è°ƒæ•´å­—å¹•æ—¶é—´è½´
if remove_silent_gaps:
    actual_duration = len(final_audio)
    adjusted_srt = adjust_subtitle_timeline(
        original_srt, 
        actual_duration
    )
```

## æµ‹è¯•ç»“æœ

### æµ‹è¯•åœºæ™¯1ï¼šæ‹‰ä¼¸2å€

**è¾“å…¥**ï¼š
- åŸå§‹å­—å¹•ï¼š10ç§’
- å®é™…éŸ³é¢‘ï¼š20ç§’

**è¾“å‡º**ï¼š
- æ‹‰ä¼¸æ¯”ä¾‹ï¼š2.00x
- è°ƒæ•´åå­—å¹•ï¼š20ç§’
- å·®å¼‚ï¼š0ms âœ…

**ç¤ºä¾‹**ï¼š
```
åŸå§‹: 00:00:00,000 --> 00:00:02,000
è°ƒæ•´: 00:00:00,000 --> 00:00:04,000
```

### æµ‹è¯•åœºæ™¯2ï¼šå·®å¼‚å°äº10%

**è¾“å…¥**ï¼š
- åŸå§‹å­—å¹•ï¼š10ç§’
- å®é™…éŸ³é¢‘ï¼š10.5ç§’

**è¾“å‡º**ï¼š
- æ— éœ€è°ƒæ•´ âœ…
- ä¸ç”Ÿæˆadjusted_subtitles.srt

### æµ‹è¯•åœºæ™¯3ï¼šæ—¥è¯­é…éŸ³åœºæ™¯

**è¾“å…¥**ï¼š
- åŸå§‹å­—å¹•ï¼š10ç§’
- å®é™…éŸ³é¢‘ï¼š17ç§’

**è¾“å‡º**ï¼š
- æ‹‰ä¼¸æ¯”ä¾‹ï¼š1.70x
- è°ƒæ•´åå­—å¹•ï¼š17ç§’
- å·®å¼‚ï¼š0ms âœ…

**ç¤ºä¾‹**ï¼š
```
åŸå§‹: 00:00:06,000 --> 00:00:08,000
è°ƒæ•´: 00:00:10,200 --> 00:00:13,600
```

## æŠ€æœ¯ç»†èŠ‚

### è§¦å‘æ¡ä»¶

```python
if self.remove_silent_gaps:
    # å¯ç”¨äº†ç§»é™¤é™éŸ³é—´éš™
    if audio_duration_ms > original_duration_ms * 1.1:
        # éŸ³é¢‘æ¯”å­—å¹•é•¿10%ä»¥ä¸Š
        # â†’ æ‰§è¡Œå­—å¹•è°ƒæ•´
    else:
        # å·®å¼‚å°äº10%
        # â†’ ä¸è°ƒæ•´
```

### æ—¶é—´æˆ³è½¬æ¢

```python
# SRTæ—¶é—´æ ¼å¼ â†’ æ¯«ç§’
def time_to_ms(time_str):
    # "00:00:05,500" â†’ 5500
    h, m, s_ms = time_str.split(':')
    s, ms = s_ms.split(',')
    return int(h)*3600000 + int(m)*60000 + int(s)*1000 + int(ms)

# æ¯«ç§’ â†’ SRTæ—¶é—´æ ¼å¼
def _ms_to_srt_time(ms):
    # 5500 â†’ "00:00:05,500"
    hours = int(ms // 3600000)
    minutes = int((ms % 3600000) // 60000)
    seconds = int((ms % 60000) // 1000)
    milliseconds = int(ms % 1000)
    return f"{hours:02d}:{minutes:02d}:{seconds:02d},{milliseconds:03d}"
```

### è¯´è¯äººæ ‡è®°ä¿ç•™

```python
# å¦‚æœæœ‰è¯´è¯äººæ ‡è®°ï¼Œä¿ç•™å®ƒ
if subtitle['speaker']:
    f.write(f"[{subtitle['speaker']}] {subtitle['text']}\n\n")
else:
    f.write(f"{subtitle['text']}\n\n")
```

## è¾“å‡ºæ–‡ä»¶

### æ–‡ä»¶å‘½å

| åœºæ™¯ | æ–‡ä»¶å | è¯´æ˜ |
|------|--------|------|
| ç§»é™¤é™éŸ³é—´éš™ | `adjusted_subtitles.srt` | æ—¶é—´è½´å·²æ‹‰ä¼¸ |
| ä¿æŒæ€»æ—¶é•¿ | `updated_subtitles.srt` | åŠ¨æ€è°ƒæ•´åçš„å­—å¹• |
| ä¼ ç»Ÿæ¨¡å¼ | æ—  | ä¸ç”Ÿæˆå­—å¹•æ–‡ä»¶ |

### æ–‡ä»¶ä½ç½®

```
output/
â”œâ”€â”€ dubbing_result.wav              # TTSé…éŸ³éŸ³é¢‘
â”œâ”€â”€ adjusted_subtitles.srt          # è°ƒæ•´åçš„å­—å¹•ï¼ˆç§»é™¤é™éŸ³é—´éš™æ¨¡å¼ï¼‰
â””â”€â”€ updated_subtitles.srt           # æ›´æ–°åçš„å­—å¹•ï¼ˆä¿æŒæ€»æ—¶é•¿æ¨¡å¼ï¼‰
```

## æ—¥å¿—è¾“å‡º

### éœ€è¦è°ƒæ•´çš„æƒ…å†µ

```
ğŸ“Š ç§»é™¤é™éŸ³é—´éš™æ¨¡å¼:
   å®é™…éŸ³é¢‘æ—¶é•¿: 170.00ç§’ (170000ms)

ğŸ¯ è‡ªåŠ¨è°ƒæ•´å­—å¹•æ—¶é—´è½´ï¼ˆæ–¹æ¡ˆAï¼‰:
   åŸå§‹å­—å¹•æ—¶é•¿: 85.00ç§’ (85000ms)
   å®é™…éŸ³é¢‘æ—¶é•¿: 170.00ç§’ (170000ms)
   æ‹‰ä¼¸æ¯”ä¾‹: 2.00x

âœ… å­—å¹•æ—¶é—´è½´è°ƒæ•´å®Œæˆ:
   è°ƒæ•´åæ€»æ—¶é•¿: 170.00ç§’ (170000ms)
   ä¸éŸ³é¢‘å·®å¼‚: 0ms
   ä¿å­˜ä½ç½®: output/adjusted_subtitles.srt
```

### æ— éœ€è°ƒæ•´çš„æƒ…å†µ

```
ğŸ“Š ç§»é™¤é™éŸ³é—´éš™æ¨¡å¼:
   å®é™…éŸ³é¢‘æ—¶é•¿: 10.50ç§’ (10500ms)

ğŸ“Š å­—å¹•æ—¶é—´è½´æ— éœ€è°ƒæ•´:
   åŸå§‹å­—å¹•æ—¶é•¿: 10.00ç§’
   å®é™…éŸ³é¢‘æ—¶é•¿: 10.50ç§’
   å·®å¼‚: 0.50ç§’ (< 10%)
```

## ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ

### 1. ä¸"ä¿æŒSRTæ€»æ—¶é•¿"çš„å…³ç³»

```
if preserve_total_time:
    # ä½¿ç”¨TimelineAdjusteråŠ¨æ€è°ƒæ•´
    # ç”Ÿæˆ updated_subtitles.srt
elif enable_smart_speedup:
    # ä½¿ç”¨SpeedRateAdjusteråŒé‡å˜é€Ÿ
    # ç”Ÿæˆ updated_subtitles.srt
else:
    # ä¼ ç»Ÿæ‹¼æ¥
    if remove_silent_gaps:
        # æ–°åŠŸèƒ½ï¼šè‡ªåŠ¨è°ƒæ•´å­—å¹•
        # ç”Ÿæˆ adjusted_subtitles.srt
```

### 2. ä¸è§†é¢‘åˆå¹¶çš„é…åˆ

```
TTSé…éŸ³æ¨¡å—
    â†“
adjusted_subtitles.srt (170ç§’)
    â†“
è§†é¢‘åˆå¹¶æ¨¡å—
    â†“
è‡ªåŠ¨æ…¢æ”¾è§†é¢‘ä»¥åŒ¹é…éŸ³é¢‘
    â†“
å†æ¬¡è°ƒæ•´å­—å¹•ä»¥åŒ¹é…æ…¢æ”¾åçš„è§†é¢‘
    â†“
æœ€ç»ˆè§†é¢‘ï¼ˆç”»é¢+éŸ³é¢‘+å­—å¹•å®Œç¾åŒæ­¥ï¼‰
```

## ä¼˜ç‚¹

1. **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨è°ƒæ•´å­—å¹•
2. **å‡†ç¡®æ€§**ï¼šæ—¶é—´è½´ç²¾ç¡®åŒ¹é…éŸ³é¢‘
3. **ç®€å•æ€§**ï¼šç®—æ³•ç®€å•ï¼Œè®¡ç®—å¿«é€Ÿ
4. **å…¼å®¹æ€§**ï¼šç”Ÿæˆæ ‡å‡†SRTæ ¼å¼
5. **çµæ´»æ€§**ï¼š10%é˜ˆå€¼é¿å…ä¸å¿…è¦çš„è°ƒæ•´

## é™åˆ¶

1. **å‡åŒ€æ‹‰ä¼¸**ï¼šå‡è®¾è¯­é€Ÿå·®å¼‚æ˜¯å‡åŒ€çš„
2. **æ•´ä½“è°ƒæ•´**ï¼šä¸èƒ½é’ˆå¯¹å•ä¸ªç‰‡æ®µç²¾ç¡®è°ƒæ•´
3. **ä¾èµ–åŸå§‹æ—¶é—´è½´**ï¼šéœ€è¦åŸå§‹SRTæ–‡ä»¶å‡†ç¡®

## æœªæ¥æ”¹è¿›æ–¹å‘

### æ–¹æ¡ˆBï¼šåŸºäºéŸ³é¢‘ç‰‡æ®µçš„ç²¾ç¡®å¯¹é½

```python
# è®°å½•æ¯ä¸ªç‰‡æ®µçš„å®é™…æ—¶é•¿
segments = []
for subtitle in subtitles:
    audio = synthesize_speech(subtitle['text'])
    segments.append({
        'text': subtitle['text'],
        'original_duration': subtitle['end'] - subtitle['start'],
        'actual_duration': len(audio)
    })

# ç´¯ç§¯è®¡ç®—æ–°æ—¶é—´è½´
current_time = 0
for segment in segments:
    new_start = current_time
    new_end = current_time + segment['actual_duration']
    current_time = new_end
```

**ä¼˜ç‚¹**ï¼š
- æ¯æ¡å­—å¹•ç²¾ç¡®å¯¹é½
- é€‚åˆè¯­é€Ÿå·®å¼‚ä¸å‡åŒ€çš„åœºæ™¯

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹TTSç”Ÿæˆæµç¨‹
- å®ç°å¤æ‚åº¦è¾ƒé«˜

## ç›¸å…³Issueå’Œéœ€æ±‚

### åŸå§‹é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š
```
"TTSç¿»è¯‘ä¸­srtç›®å‰åªèƒ½åœ¨æ‹¼æ¥è¿‡ç¨‹ä¸­æ·»åŠ é™éŸ³å¸§ï¼Œ
ç”»é¢èƒ½ä»¥ç›¸åŒçš„æ–¹å¼åœ¨å¯¹è¯é—´è¿›è¡Œéƒ¨åˆ†ç¼©æ”¾ä¹ˆ"
```

### è§£å†³æ–¹æ¡ˆ

1. âœ… ç§»é™¤é™éŸ³é—´éš™ï¼ˆè®©éŸ³é¢‘è‡ªç„¶ç”Ÿæˆï¼‰
2. âœ… è‡ªåŠ¨è°ƒæ•´å­—å¹•æ—¶é—´è½´ï¼ˆæœ¬åŠŸèƒ½ï¼‰
3. âœ… è§†é¢‘æ…¢æ”¾åŒæ­¥ï¼ˆè§†é¢‘åˆå¹¶æ¨¡å—ï¼‰

### ç”¨æˆ·åé¦ˆ

```
"é‚£å½“å‰æ•´ä½“æ”¾æ…¢åæŒ‰ä»€ä¹ˆæ ‡å‡†æ”¾æ…¢ 
æ—¥è¯­é€šè¿‡ç¿»è¯‘åè¿œè¿œæ¯”ä¸­æ–‡çš„æ—¶é—´è½´è¦é•¿ 
ä½†æ—¥è¯­åŒ¹é…çš„æ˜¯ä¸­æ–‡çš„æ—¶é—´è½´"
```

**è§£å†³**ï¼š
- ä¸å†å¼ºåˆ¶åŒ¹é…ä¸­æ–‡æ—¶é—´è½´
- è®©æ—¥è¯­è‡ªç„¶ç”Ÿæˆ
- è‡ªåŠ¨æ‹‰ä¼¸å­—å¹•ä»¥åŒ¹é…æ—¥è¯­éŸ³é¢‘
- è§†é¢‘æ…¢æ”¾ä»¥åŒ¹é…éŸ³é¢‘

## æ€»ç»“

æˆåŠŸå®ç°äº†å­—å¹•è‡ªåŠ¨è°ƒæ•´åŠŸèƒ½ï¼ˆæ–¹æ¡ˆAï¼‰ï¼Œè§£å†³äº†è·¨è¯­è¨€é…éŸ³ä¸­çš„å­—å¹•æ—¶é—´è½´ä¸åŒ¹é…é—®é¢˜ã€‚è¯¥åŠŸèƒ½ï¼š

- âœ… è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜
- âœ… ä½¿ç”¨ç®€å•ï¼ˆåªéœ€å‹¾é€‰ä¸€ä¸ªé€‰é¡¹ï¼‰
- âœ… æ•ˆæœå‡†ç¡®ï¼ˆæµ‹è¯•é€šè¿‡ï¼‰
- âœ… ä¸ç°æœ‰åŠŸèƒ½è‰¯å¥½é›†æˆ
- âœ… æ–‡æ¡£å®Œå–„

ç”¨æˆ·ç°åœ¨å¯ä»¥è½»æ¾å®Œæˆè·¨è¯­è¨€é…éŸ³ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒæ•´å­—å¹•æ—¶é—´è½´ã€‚
