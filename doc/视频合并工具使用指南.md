# 视频合并工具使用指南

## 功能概述

视频合并工具提供了完整的Web界面，支持将MP4视频、TTS音轨和SRT字幕进行智能合并，并提供多种处理模式。

## 启动方法

### 方法1：直接启动
```bash
python start_video_merger.py
```

### 方法2：集成到现有项目
```python
from src.api.video_merger_api import VideoMergerAPI
from flask import Flask

app = Flask(__name__)
api = VideoMergerAPI(app)
app.run(port=8515)
```

## 访问地址

启动后访问：
- **主页**：http://localhost:8515
- **视频合并工具**：http://localhost:8515/video_merger

## 界面功能

### 1. 文件选择区域

**📹 MP4视频文件（必需）**
- 支持格式：.mp4
- 作为合并的基础视频

**🎵 WAV音轨文件**
- 支持格式：.wav, .mp3
- TTS生成的配音文件

**📝 SRT字幕文件**
- 支持格式：.srt
- 更新后的字幕文件

### 2. 合并模式选择

#### 🔄 替换音轨（推荐）
- **功能**：用TTS音轨完全替换原视频音轨
- **特点**：
  - ✅ 处理速度最快
  - ✅ 视频质量无损
  - ✅ 适合大多数场景
- **需要文件**：视频 + 音频

#### 🎵 混合音轨
- **功能**：保留原音并混合TTS配音
- **特点**：
  - ✅ 保留背景音和音效
  - ✅ 叠加TTS配音
  - ⚠️ 可能音量不平衡
- **需要文件**：视频 + 音频

#### 📝 嵌入字幕
- **功能**：将字幕作为软字幕嵌入视频
- **特点**：
  - ✅ 可开关字幕
  - ✅ 支持多语言
  - ✅ 文件体积小
- **需要文件**：视频 + 字幕

#### 🔥 烧录字幕
- **功能**：将字幕烧录到视频画面
- **特点**：
  - ✅ 字幕永久显示
  - ✅ 兼容所有播放器
  - ⚠️ 需要重新编码（慢）
- **需要文件**：视频 + 字幕

#### 🔇 去除音轨
- **功能**：仅移除原视频音轨
- **特点**：
  - ✅ 保留视频流
  - ✅ 可选择性嵌入字幕
  - ✅ 处理速度快
- **需要文件**：仅视频

#### 📹 仅视频
- **功能**：提取纯视频流（无音轨无字幕）
- **特点**：
  - ✅ 最小文件体积
  - ✅ 纯视频流
  - ✅ 处理速度最快
- **需要文件**：仅视频

### 3. 高级选项

**去除原始音轨**
- ✅ 勾选：完全移除原视频音轨（推荐）
- ❌ 不勾选：保留原音轨（仅在混合模式下有效）

## 使用流程

### 完整配音流程

#### 步骤1：TTS配音生成
1. 使用TTS配音工具生成配音
2. 获得：
   - `dubbing_result.wav`（配音文件）
   - `updated_subtitles.srt`（更新后字幕）

#### 步骤2：视频合并
1. 打开视频合并工具：http://localhost:8515/video_merger
2. 选择文件：
   - 📹 选择原始MP4视频
   - 🎵 选择TTS生成的WAV音轨
   - 📝 选择更新后的SRT字幕
3. 选择模式：**替换音轨**
4. 确保勾选：**去除原始音轨**
5. 点击：**🚀 开始合并**

#### 步骤3：下载结果
- 合并完成后点击下载链接
- 获得最终的配音视频

### 快速场景

#### 场景1：仅替换音轨
```
文件：视频 + 音频
模式：替换音轨
选项：去除原始音轨 ✅
结果：新音轨的视频
```

#### 场景2：添加字幕
```
文件：视频 + 字幕
模式：嵌入字幕
选项：去除原始音轨 ✅
结果：带软字幕的静音视频
```

#### 场景3：完整合并
```
文件：视频 + 音频 + 字幕
模式：替换音轨
选项：去除原始音轨 ✅
结果：新音轨 + 软字幕的视频
```

#### 场景4：去除音轨
```
文件：仅视频
模式：去除音轨
结果：静音视频
```

## API接口

### 合并视频
```http
POST /api/merge_video
Content-Type: multipart/form-data

参数：
- video: 视频文件
- audio: 音频文件（可选）
- subtitle: 字幕文件（可选）
- mode: 合并模式
- remove_original_audio: 是否去除原音轨
```

### 获取视频信息
```http
POST /api/video_info
Content-Type: multipart/form-data

参数：
- video: 视频文件
```

### 下载文件
```http
GET /download/<filename>
```

## 技术规格

### 支持格式

**输入格式：**
- 视频：MP4
- 音频：WAV, MP3
- 字幕：SRT

**输出格式：**
- 视频：MP4 (H.264)
- 音频：AAC (192kbps)
- 字幕：mov_text (软字幕)

### 文件大小限制
- 最大上传：1GB
- 推荐大小：< 500MB

### 处理性能

| 模式 | 速度 | CPU使用 | 说明 |
|------|------|---------|------|
| 替换音轨 | ⚡⚡⚡ | 低 | 仅重新封装 |
| 混合音轨 | ⚡⚡⚡ | 中 | 音频混合 |
| 嵌入字幕 | ⚡⚡⚡ | 低 | 仅重新封装 |
| 烧录字幕 | ⚡ | 高 | 视频重编码 |
| 去除音轨 | ⚡⚡⚡ | 低 | 仅重新封装 |

## 常见问题

### Q1: 上传失败
**原因：** 文件过大或格式不支持
**解决：**
- 检查文件大小（< 1GB）
- 确认文件格式正确
- 检查网络连接

### Q2: 合并失败
**原因：** FFmpeg错误或文件损坏
**解决：**
- 检查FFmpeg安装
- 确认输入文件完整
- 查看错误信息

### Q3: 音视频不同步
**原因：** 音频时长与视频不匹配
**解决：**
- 使用TTS的"保持总时长"功能
- 检查音频文件时长
- 尝试不同的合并模式

### Q4: 字幕不显示
**原因：** 字幕格式或编码问题
**解决：**
- 确保SRT文件UTF-8编码
- 使用"烧录字幕"模式
- 检查字幕文件格式

### Q5: 处理速度慢
**原因：** 使用了重编码模式
**解决：**
- 使用"替换音轨"模式
- 避免"烧录字幕"模式
- 减小输入文件大小

## 最佳实践

### 推荐工作流程
1. **TTS配音**：生成高质量配音和字幕
2. **预处理**：确保文件格式和编码正确
3. **合并**：使用"替换音轨"模式
4. **验证**：检查输出质量和同步性

### 性能优化
- 优先使用"替换音轨"模式
- 避免不必要的重编码
- 合理控制文件大小
- 使用SSD存储提高I/O性能

### 质量保证
- 使用无损音频格式
- 确保字幕时间轴准确
- 验证最终输出质量
- 保留原始文件备份

## 故障排除

### 检查FFmpeg
```bash
# Windows
ffmpeg\ffmpeg.exe -version

# Linux/Mac
ffmpeg -version
```

### 查看日志
- 浏览器开发者工具查看网络请求
- 服务器控制台查看处理日志
- 检查临时文件是否正常生成

### 重启服务
```bash
# 停止服务：Ctrl+C
# 重新启动
python start_video_merger.py
```

## 总结

视频合并工具提供了：
1. ✅ 直观的Web界面
2. ✅ 多种合并模式
3. ✅ 去除音轨选项
4. ✅ 实时处理进度
5. ✅ 完整的API接口

**推荐配置：**
- 模式：替换音轨
- 选项：去除原始音轨 ✅
- 文件：视频 + TTS音频 + 更新字幕

这样可以获得最佳的处理速度和输出质量。

---

*更新日期：2024-12-16*
*相关文件：*
- *前端：templates/video_merger.html*
- *后端：src/api/video_merger_api.py*
- *启动：start_video_merger.py*