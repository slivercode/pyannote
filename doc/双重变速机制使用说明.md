# 双重变速机制使用说明

## 功能概述

双重变速机制是一个智能的音频/视频速度调整系统，参考了 `pyvideotrans` 项目的实现，用于解决TTS配音时长与字幕时长不匹配的问题。

### 核心特性

1. **音频加速** - 使用FFmpeg的高质量变速滤镜（rubberband/atempo）压缩配音时长
2. **视频慢速** - 延长视频片段以容纳较长的配音
3. **智能策略选择** - 根据时长差异自动选择最优调整方案
4. **静音间隙利用** - 优先利用字幕间的静音时段，减少变速需求

## 工作原理

### 三种调整策略

#### 策略1: 音频加速 + 视频慢速（推荐）
当配音时长超过字幕时长时：
- **优先级1**: 利用静音间隙容纳配音
- **优先级2**: 如果加速倍率 ≤ 1.3x，仅音频加速
- **优先级3**: 音频和视频各承担一半调整量

#### 策略2: 仅音频加速
适用于无法修改视频的场景：
- 优先利用静音间隙
- 限制最大加速倍率（默认2.0x）
- 超过限制时按最大倍率加速

#### 策略3: 仅视频慢速
适用于保持原音质的场景：
- 优先利用静音间隙
- 限制最大慢速倍率（默认10.0x）
- 超过限制时按最大倍率慢放

### 音频变速引擎

系统自动检测FFmpeg支持的滤镜：

1. **rubberband** (优先)
   - 高质量音频变速
   - 保持音高不变
   - 支持大范围变速

2. **atempo** (备选)
   - FFmpeg内置滤镜
   - 倍率限制: 0.5x - 4.0x
   - 超过限制时自动链式处理

## 使用方法

### 1. 在TTS配音处理器中启用

```python
from scripts.tts_dubbing_processor import TTSDubbingProcessor

processor = TTSDubbingProcessor(
    srt_path="input.srt",
    output_dir="output",
    engine="gpt-sovits",
    role_data={...},
    
    # 启用双重变速机制
    enable_smart_speedup=True,          # 总开关
    enable_audio_speedup=True,          # 启用音频加速
    enable_video_slowdown=False,        # 启用视频慢速
    max_audio_speed_rate=2.0,           # 最大音频加速倍率
    max_video_pts_rate=10.0,            # 最大视频慢速倍率
    remove_silent_gaps=False,           # 是否移除静音间隙
)

result = processor.process()
```

### 2. 直接使用SpeedRateAdjuster

```python
from scripts.speed_rate_adjuster import SpeedRateAdjuster

# 准备字幕数据
subtitles = [
    {'start_ms': 0, 'end_ms': 2000, 'text': '第一句话'},
    {'start_ms': 2500, 'end_ms': 5000, 'text': '第二句话'},
]

# 对应的音频文件
audio_files = ['audio_001.wav', 'audio_002.wav']

# 创建调整器
adjuster = SpeedRateAdjuster(
    subtitles=subtitles,
    audio_files=audio_files,
    output_dir='./output',
    enable_audio_speedup=True,
    enable_video_slowdown=False,
    max_audio_speed_rate=2.0,
)

# 执行处理
final_audio, updated_subtitles = adjuster.process()
```

## 参数说明

### SpeedRateAdjuster 参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `subtitles` | List[Dict] | 必填 | 字幕列表，包含start_ms, end_ms, text |
| `audio_files` | List[str] | 必填 | 配音文件路径列表 |
| `output_dir` | str | 必填 | 输出目录 |
| `enable_audio_speedup` | bool | True | 是否启用音频加速 |
| `enable_video_slowdown` | bool | False | 是否启用视频慢速 |
| `max_audio_speed_rate` | float | 100.0 | 音频最大加速倍率 |
| `max_video_pts_rate` | float | 10.0 | 视频最大慢速倍率 |
| `remove_silent_gaps` | bool | False | 是否移除字幕间静音 |
| `align_subtitle_audio` | bool | True | 是否对齐字幕和音频时间轴 |
| `raw_total_time_ms` | int | 0 | 原始视频总时长（毫秒） |

### TTSDubbingProcessor 新增参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enable_smart_speedup` | bool | False | 是否启用智能双重变速机制 |
| `enable_audio_speedup` | bool | True | 是否启用音频加速 |
| `enable_video_slowdown` | bool | False | 是否启用视频慢速 |
| `max_audio_speed_rate` | float | 2.0 | 音频最大加速倍率 |
| `max_video_pts_rate` | float | 10.0 | 视频最大慢速倍率 |
| `remove_silent_gaps` | bool | False | 是否移除字幕间静音间隙 |

## 处理流程

```
1. 准备数据
   ├─ 计算原始字幕时长
   ├─ 获取配音文件时长
   └─ 计算静音间隙

2. 计算调整方案
   ├─ 分析时长差异
   ├─ 选择最优策略
   └─ 计算目标时长

3. 执行音频加速
   ├─ 检测FFmpeg滤镜
   ├─ 构建变速命令
   └─ 批量处理音频

4. 合并音频片段
   ├─ 添加静音对齐
   ├─ 拼接所有片段
   └─ 导出最终音频

5. 清理临时文件
   └─ 删除中间文件
```

## 输出文件

处理完成后会生成以下文件：

1. **final_audio_speedup.wav** - 最终合成的音频文件
2. **updated_subtitles.srt** - 更新时间轴后的字幕文件
3. **speed_adjust_temp/** - 临时文件目录（自动清理）

## 使用建议

### 推荐配置

**场景1: 一般配音（推荐）**
```python
enable_smart_speedup=True
enable_audio_speedup=True
enable_video_slowdown=False
max_audio_speed_rate=2.0
```

**场景2: 高质量配音（保持音质）**
```python
enable_smart_speedup=True
enable_audio_speedup=True
enable_video_slowdown=False
max_audio_speed_rate=1.3  # 限制在最佳倍率
```

**场景3: 视频同步（可修改视频）**
```python
enable_smart_speedup=True
enable_audio_speedup=True
enable_video_slowdown=True
max_audio_speed_rate=1.5
max_video_pts_rate=2.0
```

### 注意事项

1. **FFmpeg依赖**: 确保FFmpeg已正确安装并包含音频滤镜
2. **音质影响**: 加速倍率越大，音质损失越明显，建议不超过2.0x
3. **处理时间**: 音频加速需要FFmpeg处理，大文件可能耗时较长
4. **内存占用**: 处理大量字幕时注意内存使用
5. **文件格式**: 输入音频建议使用WAV格式以获得最佳兼容性

## 调试信息

启用双重变速后，控制台会输出详细的处理信息：

```
🎬 开始双重变速机制处理
============================================================
📊 阶段 1/5: 准备数据
============================================================
  字幕 1: 原时长=2000ms, 配音时长=2500ms
  字幕 2: 原时长=2500ms, 配音时长=3000ms

============================================================
🧮 阶段 2/5: 计算调整方案
============================================================
--- 分析字幕 1 ---
  配音时长: 2500ms
  字幕时长: 2000ms
  静音间隙: 500ms
  ⚡ 仅需音频加速 (倍率1.25 <= 1.3)
  🎯 最终方案: 音频目标=2000ms, 视频目标=2000ms

============================================================
⚡ 阶段 3/5: 执行音频加速
============================================================
  字幕 1: 加速 1.25x (2500ms -> 2000ms)
    ✅ 加速成功，实际时长: 2003ms

============================================================
🔗 阶段 4/5: 合并音频片段
============================================================
  字幕 1: 添加配音 2003ms
  字幕 1 前添加静音: 500ms
  字幕 2: 添加配音 3000ms

============================================================
🧹 阶段 5/5: 清理临时文件
============================================================
  ✅ 临时文件清理完成

✅ 双重变速处理完成！
```

## 常见问题

### Q1: 为什么音频加速后音质变差？
A: 音频加速会改变音频特性。建议：
- 限制最大加速倍率在1.5x以内
- 使用rubberband滤镜（音质更好）
- 考虑重新录制配音

### Q2: 如何检查是否支持rubberband？
A: 运行以下命令：
```bash
ffmpeg -filters | grep rubberband
```

### Q3: 处理速度慢怎么办？
A: 优化建议：
- 减少字幕数量
- 降低音频采样率
- 使用atempo替代rubberband

### Q4: 能否只对部分字幕加速？
A: 当前版本会自动判断每条字幕是否需要加速，无需手动指定。

## 技术参考

本实现参考了以下项目：
- [pyvideotrans](https://github.com/jianchang512/pyvideotrans) - 视频翻译配音工具
- FFmpeg rubberband滤镜文档
- PyDub音频处理库

## 更新日志

### v1.0.0 (2024-12-12)
- ✅ 实现双重变速机制核心功能
- ✅ 支持音频加速和视频慢速
- ✅ 智能策略选择算法
- ✅ 集成到TTS配音处理器
- ✅ 完整的文档和示例

---

如有问题或建议，请查看项目文档或提交Issue。
