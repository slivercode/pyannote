# 将 pyvideotrans 对齐算法应用到 pyannote-audio 总结

## 📊 项目现状

### pyannote-audio-web-ui 已有功能
✅ 说话人分离（pyannote-audio）  
✅ TTS 多角色配音（GPT-SoVITS等）  
✅ 基础音频加速（speed_rate_adjuster.py）  
✅ 字幕时间轴对齐  
✅ 智能策略选择  

### pyvideotrans 完整功能
✅ 音频加速（rubberband/atempo）  
✅ 视频慢速（PTS调整）  
✅ 视频片段切割和拼接  
✅ 物理时间轴模型  
✅ 多线程并行处理  
✅ 完整边界情况处理  

## 🎯 三种应用方案

### 方案1: 快速集成（推荐⭐⭐⭐⭐⭐）

**优点**: 最快速，无需修改代码，直接使用  
**缺点**: 需要同时维护两个项目  

**实现步骤**:

1. 创建适配器类（已完成）
```python
# 文件: src/scripts/quick_integration_example.py
from videotrans.task._rate import SpeedRate

class PyannoteSpeedRateAdapter:
    def align_audio_with_subtitles(self, ...):
        # 调用 pyvideotrans 的 SpeedRate
        pass
```

2. 在 TTS 处理器中使用
```python
from scripts.quick_integration_example import PyannoteSpeedRateAdapter

adapter = PyannoteSpeedRateAdapter()
final_audio, updated_subtitles = adapter.align_audio_with_subtitles(
    subtitles=subtitles,
    audio_files=audio_files,
    enable_audio_speedup=True,
)
```

**使用方法**:
```bash
# 1. 确保 pyvideotrans-main 在正确位置
# 2. 运行示例
python src/scripts/quick_integration_example.py
```

---

### 方案2: 完整移植（推荐⭐⭐⭐⭐）

**优点**: 独立维护，可自定义优化  
**缺点**: 需要适配配置系统  

**实现步骤**:

1. 复制核心文件
```bash
cp pyvideotrans-main/videotrans/task/_rate.py \
   pyannote-audio-web-ui/src/scripts/speed_rate_core.py
```

2. 修改依赖导入
```python
# 原代码
from videotrans.configure import config
from videotrans.util import tools

# 修改为
from scripts.util import get_video_duration
import logging
logger = logging.getLogger(__name__)
```

3. 创建配置适配器
```python
class ConfigAdapter:
    FFMPEG_BIN = 'ffmpeg'
    TEMP_DIR = './temp'
    settings = {'max_audio_speed_rate': 100}
```

4. 替换工具函数
```python
# tools.ms_to_time_string() -> 自己实现
# tools.get_video_info() -> 自己实现
# tools.runffmpeg() -> subprocess.run()
```

**详细指南**: 参见 `doc/对齐算法移植指南.md`

---

### 方案3: 增量改进（推荐⭐⭐⭐）

**优点**: 渐进式，风险低  
**缺点**: 耗时较长  

**实现步骤**:

1. 在现有 `speed_rate_adjuster.py` 基础上添加功能

2. 第一阶段：添加视频处理
```python
def _cut_video_clip(self, video_file, start_ms, end_ms, pts, output):
    """切割视频片段"""
    cmd = ['ffmpeg', '-y', '-ss', ..., '-vf', f'setpts={pts}*PTS', ...]
    subprocess.run(cmd)

def _concat_video_clips(self, clip_files, output):
    """拼接视频片段"""
    # 使用 concat demuxer
    pass
```

3. 第二阶段：添加多线程支持
```python
from concurrent.futures import ThreadPoolExecutor

def _execute_audio_speedup_parallel(self):
    with ThreadPoolExecutor(max_workers=12) as executor:
        futures = [executor.submit(self._speedup_audio, i) for i in range(len(self.subtitles))]
        for future in futures:
            future.result()
```

4. 第三阶段：完善边界处理
```python
def _handle_boundary_cases(self):
    # 处理小于40ms的片段
    # 处理空文本字幕
    # 处理视频片段生成失败
    pass
```

---

## 🚀 推荐实施路线

### 阶段1: 快速验证（1天）

使用**方案1**快速集成，验证对齐算法效果：

```python
# 1. 创建测试脚本
python src/scripts/quick_integration_example.py

# 2. 测试音频加速
# 3. 测试视频慢速
# 4. 验证输出质量
```

### 阶段2: 功能完善（3-5天）

根据验证结果，选择**方案2**或**方案3**：

- 如果需要完整功能 → 选择方案2（完整移植）
- 如果只需部分功能 → 选择方案3（增量改进）

### 阶段3: 集成优化（2-3天）

1. 集成到 `tts_dubbing_processor.py`
2. 添加 Web UI 控制选项
3. 完善错误处理和日志
4. 性能优化和测试

---

## 💡 具体使用场景

### 场景1: 多角色配音 + 音频对齐

```python
from scripts.tts_multi_role_dubbing import MultiRoleDubbingProcessor
from scripts.quick_integration_example import PyannoteSpeedRateAdapter

# 1. 多角色配音
dubbing_processor = MultiRoleDubbingProcessor(
    srt_path='input.srt',
    output_dir='output',
    role_configs={...}
)
audio_files, subtitles = dubbing_processor.process()

# 2. 音频对齐
adapter = PyannoteSpeedRateAdapter()
final_audio, updated_subtitles = adapter.align_audio_with_subtitles(
    subtitles=subtitles,
    audio_files=audio_files,
    enable_audio_speedup=True,
    max_audio_speed_rate=1.5,
)
```

### 场景2: 视频翻译配音

```python
# 1. 提取音频
# 2. 说话人分离
# 3. 语音识别
# 4. 翻译字幕
# 5. TTS 配音
# 6. 音视频对齐（使用 pyvideotrans 算法）
adapter = PyannoteSpeedRateAdapter()
final_audio, updated_subtitles = adapter.align_audio_with_subtitles(
    subtitles=translated_subtitles,
    audio_files=tts_audio_files,
    enable_audio_speedup=True,
    enable_video_slowdown=True,
    video_file='original_video.mp4',
)
# 7. 合并视频
```

### 场景3: 字幕时长调整

```python
# 当配音时长与字幕时长不匹配时
adapter = PyannoteSpeedRateAdapter()
final_audio, updated_subtitles = adapter.align_audio_with_subtitles(
    subtitles=subtitles,
    audio_files=audio_files,
    enable_audio_speedup=True,
    max_audio_speed_rate=2.0,  # 允许最大2倍加速
)

# 导出更新后的字幕
with open('output.srt', 'w', encoding='utf-8') as f:
    for i, sub in enumerate(updated_subtitles):
        f.write(f"{i+1}\n")
        f.write(f"{ms_to_srt_time(sub['start_ms'])} --> {ms_to_srt_time(sub['end_ms'])}\n")
        f.write(f"{sub['text']}\n\n")
```

---

## 📋 功能对比表

| 功能 | pyannote 现有 | pyvideotrans | 方案1 | 方案2 | 方案3 |
|------|--------------|--------------|-------|-------|-------|
| 音频加速 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 视频慢速 | ❌ | ✅ | ✅ | ✅ | 需开发 |
| 智能策略 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 多线程 | ❌ | ✅ | ✅ | ✅ | 需开发 |
| 边界处理 | 部分 | ✅ | ✅ | ✅ | 需开发 |
| 物理时间轴 | ❌ | ✅ | ✅ | ✅ | 需开发 |
| 独立维护 | ✅ | ✅ | ❌ | ✅ | ✅ |
| 实施难度 | - | - | ⭐ | ⭐⭐⭐ | ⭐⭐ |
| 实施时间 | - | - | 1天 | 5天 | 3天 |

---

## 🔧 配置参数说明

### 音频加速参数

```python
enable_audio_speedup=True          # 是否启用音频加速
max_audio_speed_rate=2.0           # 最大加速倍率（建议1.5-2.0）
audio_speed_filter='rubberband'    # 变速引擎（rubberband/atempo）
```

### 视频慢速参数

```python
enable_video_slowdown=True         # 是否启用视频慢速
max_video_pts_rate=10.0            # 最大慢速倍率（建议2.0-5.0）
video_fps=30                       # 视频帧率
crf='20'                           # 视频质量（18-28，越小质量越高）
preset='fast'                      # 编码速度（ultrafast/fast/medium/slow）
```

### 对齐策略参数

```python
remove_silent_gaps=False           # 是否移除字幕间静音
align_subtitle_audio=True          # 是否对齐字幕时间轴
BEST_AUDIO_RATE=1.3               # 最佳加速倍率阈值
```

---

## ⚠️ 注意事项

### 1. FFmpeg 依赖

确保 FFmpeg 已安装并支持所需滤镜：

```bash
# 检查 rubberband 支持
ffmpeg -filters | grep rubberband

# 如果不支持，需要重新编译 FFmpeg 或使用 atempo
```

### 2. 性能考虑

- 音频加速：CPU密集型，建议使用多线程
- 视频慢速：IO密集型，注意磁盘空间
- 大文件处理：注意内存占用，及时清理临时文件

### 3. 质量权衡

| 加速倍率 | 音质影响 | 推荐场景 |
|---------|---------|---------|
| 1.0-1.3x | 几乎无损 | 所有场景 |
| 1.3-1.5x | 轻微影响 | 一般配音 |
| 1.5-2.0x | 明显影响 | 快速预览 |
| >2.0x | 严重失真 | 不推荐 |

### 4. 文件路径

- 使用绝对路径避免路径问题
- Windows 路径使用 `Path()` 处理
- 临时文件及时清理

---

## 📚 相关文档

- [对齐算法移植指南](./对齐算法移植指南.md) - 详细的移植步骤
- [双重变速机制使用说明](./双重变速机制使用说明.md) - 现有功能说明
- [多角色配音语速控制说明](./多角色配音语速控制说明.md) - 语速控制
- [快速集成示例](../src/scripts/quick_integration_example.py) - 代码示例

---

## 🎉 总结

### 推荐方案

**立即开始**: 使用**方案1（快速集成）**验证效果  
**长期规划**: 根据需求选择**方案2（完整移植）**或**方案3（增量改进）**

### 预期效果

✅ 配音时长与字幕完美对齐  
✅ 支持音频加速和视频慢速  
✅ 智能策略自动选择最优方案  
✅ 多线程并行处理提升性能  
✅ 完整的边界情况处理  

### 下一步行动

1. ✅ 阅读本文档
2. ⏭️ 运行快速集成示例
3. ⏭️ 测试实际配音场景
4. ⏭️ 根据效果选择实施方案
5. ⏭️ 集成到生产环境

---

**创建日期**: 2024-12-15  
**版本**: v1.0  
**作者**: Kiro AI Assistant
