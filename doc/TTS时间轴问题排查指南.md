# TTS时间轴问题排查指南

## 🐛 问题描述

TTS配音模块生成的字幕时间轴与音频画面不匹配。

## 🔍 可能的原因

### 1. "保持SRT总时长"功能导致时间轴压缩

**场景**：
- 启用了"保持SRT总时长不变"选项
- TTS生成的音频比原字幕时长更长
- 系统自动压缩字幕时间轴以匹配原视频时长
- 结果：字幕时间轴与实际音频不匹配

**示例**：
```
原字幕总时长：85秒
TTS音频总时长：120秒
启用"保持SRT总时长"后：
  → 字幕时间轴被压缩到85秒
  → 但音频实际是120秒
  → 字幕和音频不同步
```

### 2. 视频慢放后字幕未调整

**场景**：
- 视频被慢放以匹配更长的TTS音轨
- 但字幕时间轴没有相应调整
- 结果：字幕和画面不同步

**示例**：
```
原视频：85秒
TTS音轨：170秒
视频慢放到：170秒（拉伸2.0x）
字幕时间轴：还是85秒 ❌
应该调整到：170秒 ✅
```

### 3. 间隙处理不当

**场景**：
- 字幕间的静音间隙被过度压缩或拉伸
- 导致字幕显示时间不准确

## 🔧 排查步骤

### 步骤1：使用诊断脚本

```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

诊断脚本会检查：
- 字幕总时长
- 音频总时长
- 时间轴差异
- 间隙分布
- 重叠问题

### 步骤2：检查配音设置

查看TTS配音时的设置：

```
✅ 推荐设置（字幕跟随音频）：
  - 保持SRT总时长：❌ 关闭
  - 移除静音间隙：✅ 启用
  - 语速系数：1.0-1.5x

❌ 不推荐设置（可能导致不同步）：
  - 保持SRT总时长：✅ 启用
  - 移除静音间隙：❌ 关闭
  - 语速系数：> 2.0x
```

### 步骤3：检查视频合并设置

如果使用视频合并功能：

```
✅ 正确流程：
  1. TTS配音（关闭"保持SRT总时长"）
  2. 生成音频和字幕（字幕跟随音频）
  3. 视频合并（自动调整字幕时间轴以匹配慢放）

❌ 错误流程：
  1. TTS配音（启用"保持SRT总时长"）
  2. 生成音频和字幕（字幕被压缩）
  3. 视频合并（字幕已经不准确）
```

## ✅ 解决方案

### 方案1：关闭"保持SRT总时长"（推荐）

**适用场景**：
- 不需要视频慢放
- 希望字幕完全跟随音频

**操作步骤**：
1. 在TTS配音界面，取消勾选"保持SRT总时长不变"
2. 重新生成配音
3. 字幕时间轴会完全跟随音频长度

**效果**：
```
TTS音频：120秒
字幕时间轴：120秒 ✅
完美匹配
```

### 方案2：使用视频慢放同步（推荐）

**适用场景**：
- 需要保持原视频画面
- TTS音轨比原视频长

**操作步骤**：
1. TTS配音时关闭"保持SRT总时长"
2. 生成音频和字幕（字幕跟随音频）
3. 使用视频合并功能
4. 系统自动：
   - 慢放视频以匹配音轨
   - 调整字幕时间轴以匹配慢放后的视频

**效果**：
```
原视频：85秒
TTS音轨：170秒
处理后：
  - 视频慢放到170秒
  - 字幕时间轴调整到170秒
  - 音频、视频、字幕三者完美同步 ✅
```

### 方案3：手动调整字幕时间轴

**适用场景**：
- 已经生成了不匹配的字幕
- 需要手动修复

**操作步骤**：
1. 计算拉伸系数：`ratio = 音频时长 / 字幕时长`
2. 使用字幕调整工具：
   ```bash
   python test_subtitle_timeline_simple.py
   ```
3. 或使用视频合并模块自动调整

## 📊 常见场景对照表

### 场景A：纯音频配音（无视频）

| 设置 | 结果 |
|------|------|
| 保持SRT总时长：❌ | ✅ 字幕跟随音频，完美匹配 |
| 保持SRT总时长：✅ | ❌ 字幕被压缩，与音频不匹配 |

**推荐**：关闭"保持SRT总时长"

### 场景B：视频配音（需要慢放）

| 步骤 | 设置 | 结果 |
|------|------|------|
| 1. TTS配音 | 保持SRT总时长：❌ | 字幕跟随音频 |
| 2. 视频合并 | 自动慢放视频 | 视频匹配音频 |
| 3. 视频合并 | 自动调整字幕 | 字幕匹配慢放后的视频 |
| 最终 | - | ✅ 三者完美同步 |

**推荐**：TTS时关闭"保持SRT总时长"，视频合并时自动处理

### 场景C：视频配音（不需要慢放）

| 步骤 | 设置 | 结果 |
|------|------|------|
| 1. TTS配音 | 保持SRT总时长：✅ | 字幕匹配原视频 |
| 2. TTS配音 | 语速加速 | 音频匹配原视频 |
| 3. 视频合并 | 直接替换音轨 | ✅ 三者完美同步 |

**推荐**：启用"保持SRT总时长"，让TTS自动加速以匹配原视频

## 🎯 最佳实践

### 推荐工作流程

```
1. 准备阶段
   ├─ 原视频：video.mp4 (85秒)
   └─ 原字幕：subtitle.srt (85秒)

2. TTS配音阶段
   ├─ 设置：保持SRT总时长 = ❌ 关闭
   ├─ 设置：移除静音间隙 = ✅ 启用
   ├─ 设置：语速系数 = 1.0x
   └─ 输出：
       ├─ dubbing_result.wav (120秒)
       └─ updated_subtitles.srt (120秒) ✅ 跟随音频

3. 视频合并阶段
   ├─ 输入：
   │   ├─ video.mp4 (85秒)
   │   ├─ dubbing_result.wav (120秒)
   │   └─ updated_subtitles.srt (120秒)
   ├─ 处理：
   │   ├─ 检测时长差异：120 / 85 = 1.41x
   │   ├─ 慢放视频：85秒 → 120秒
   │   └─ 调整字幕：120秒 → 120秒（已匹配，无需调整）
   └─ 输出：
       └─ final_video.mp4 ✅ 完美同步
```

### 关键要点

1. **TTS配音阶段**
   - ❌ 不要启用"保持SRT总时长"
   - ✅ 让字幕跟随音频长度

2. **视频合并阶段**
   - ✅ 系统自动慢放视频
   - ✅ 系统自动调整字幕（如果需要）

3. **验证阶段**
   - 使用诊断脚本检查时间轴
   - 播放视频检查同步效果

## 🛠️ 工具和脚本

### 1. 诊断脚本
```bash
python diagnose_tts_timeline.py <字幕文件> --audio <音频文件>
```

### 2. 字幕调整脚本
```bash
python test_subtitle_timeline_simple.py
```

### 3. 视频合并（自动调整）
使用主界面的"视频合并"功能，系统会自动处理所有同步问题。

## 📚 相关文档

- [字幕时间轴同步修复说明.md](./字幕时间轴同步修复说明.md)
- [视频慢放同步功能说明.md](./视频慢放同步功能说明.md)
- [TTS配音使用指南.md](./TTS配音使用指南.md)

---

**更新日期**: 2024-12-17
