# 画面静止问题修复说明

## 🐛 问题描述

使用视频慢放同步功能时，合并后的视频画面静止不动，只有音频正常播放。

## 🔍 问题原因

### 错误的实现
```python
# ❌ 错误：只使用 setpts 滤镜
video_filter = f"[0:v]setpts={stretch_ratio}*PTS[vout]"
```

### 根本原因
1. **setpts 只改变时间戳，不改变帧数**
   - 原视频：30秒，900帧（30fps）
   - 使用 `setpts=1.5*PTS` 后：这900帧的时间戳被拉伸到45秒
   - 但帧数仍然是900帧

2. **播放器行为**
   - 播放器看到时间戳被拉伸，但帧数不足
   - 可能只显示第一帧，或者帧与帧之间间隔过大
   - 导致画面看起来静止不动

3. **技术细节**
   ```
   原视频：30秒 @ 30fps = 900帧
   每帧间隔：1/30 = 0.033秒
   
   使用 setpts=1.5*PTS 后：
   - 第1帧时间戳：0秒 → 0秒
   - 第2帧时间戳：0.033秒 → 0.05秒
   - 第3帧时间戳：0.066秒 → 0.1秒
   - ...
   - 第900帧时间戳：30秒 → 45秒
   
   问题：帧数不变，但时间跨度变大
   结果：播放器可能只显示第一帧
   ```

## ✅ 正确的修复

### 方案：同时调整时间戳和帧率

```python
# ✅ 正确：同时使用 setpts 和 fps 滤镜
# 先获取原视频帧率
original_fps = self._get_video_fps(video_path)
target_fps = original_fps / stretch_ratio

# 使用具体的帧率数值
video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps={target_fps}[vout]"
```

**重要**：`fps` 参数必须是具体数值，不能使用 `fps/ratio` 表达式，因为FFmpeg不支持这种动态表达式。

### 工作原理

1. **setpts 调整时间戳**
   - `setpts=1.5*PTS`：时间戳乘以1.5
   - 视频时长从30秒变为45秒

2. **fps 调整帧率**
   - `fps=fps/1.5`：帧率除以1.5
   - 30fps 变为 20fps
   - 保持帧数不变（900帧）

3. **最终效果**
   ```
   原视频：30秒 @ 30fps = 900帧
   
   处理后：45秒 @ 20fps = 900帧
   - 时长：30秒 → 45秒（慢放50%）
   - 帧率：30fps → 20fps
   - 帧数：900帧（不变）
   - 每帧间隔：0.033秒 → 0.05秒
   
   结果：画面流畅播放，慢放效果正确
   ```

## 🔧 修复的代码位置

### 1. 替换音轨模式（有字幕）
```python
# 修复前
video_filter = f"[0:v]setpts={stretch_ratio}*PTS,subtitles='{subtitle_path_str}'[vout]"

# 修复后
video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps=fps/{stretch_ratio},subtitles='{subtitle_path_str}'[vout]"
```

### 2. 替换音轨模式（无字幕）
```python
# 修复前
video_filter = f"[0:v]setpts={stretch_ratio}*PTS[vout]"

# 修复后
video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps=fps/{stretch_ratio}[vout]"
```

### 3. 混合音轨模式
```python
# 修复前
filter_complex = f"[0:v]setpts={stretch_ratio}*PTS[vout]; ..."

# 修复后
filter_complex = f"[0:v]setpts={stretch_ratio}*PTS,fps=fps/{stretch_ratio}[vout]; ..."
```

### 4. 嵌入字幕模式
```python
# 修复前
video_filter = f"[0:v]setpts={stretch_ratio}*PTS[vout]"

# 修复后
video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps=fps/{stretch_ratio}[vout]"
```

## 🧪 验证修复

### 测试场景
```
输入：
- 原视频：30秒 @ 30fps
- TTS音轨：45秒
- 拉伸系数：1.5x

预期结果：
✅ 视频流畅播放45秒
✅ 画面正常慢放，无静止
✅ 音视频完美同步
✅ 字幕正确显示
```

### 验证命令
```bash
# 查看输出视频信息
ffprobe output.mp4

# 检查：
# - Duration: 45秒（正确）
# - Video fps: 20fps（从30fps降到20fps）
# - 画面流畅播放（无静止）
```

## 📋 技术总结

### 关键要点
1. **setpts 只改变时间戳**
   - 不改变帧数
   - 不改变帧率
   - 单独使用会导致画面静止

2. **fps 调整帧率**
   - 改变输出帧率
   - 保持帧数不变
   - 配合 setpts 使用才能正确慢放

3. **正确的慢放公式**
   ```
   setpts={ratio}*PTS,fps=fps/{ratio}
   
   其中：
   - ratio = 音轨时长 / 视频时长
   - ratio > 1：慢放
   - ratio < 1：加速（不推荐）
   ```

### FFmpeg 滤镜链
```bash
# 完整的慢放滤镜链
[0:v]setpts=1.5*PTS,fps=fps/1.5,subtitles='subtitle.srt'[vout]

解释：
1. setpts=1.5*PTS：时间戳乘以1.5
2. fps=fps/1.5：帧率除以1.5
3. subtitles='subtitle.srt'：烧录字幕
4. [vout]：输出流标签
```

## 🎯 最佳实践

### 推荐的慢放范围
- **< 1.3x**：几乎察觉不到，推荐
- **1.3x - 1.5x**：明显但可接受
- **> 1.5x**：非常明显，建议优化TTS音轨

### 避免慢放的方法
使用TTS配音模块的"保持SRT总时长"功能，在配音阶段就控制好音轨时长，避免后期需要慢放视频。

## 📚 相关文档
- [视频慢放同步功能说明.md](./视频慢放同步功能说明.md)
- [视频合并集成说明.md](./视频合并集成说明.md)
- [视频合并快速指南.md](./视频合并快速指南.md)
