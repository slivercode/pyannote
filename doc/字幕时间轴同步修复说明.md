# å­—å¹•æ—¶é—´è½´åŒæ­¥ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

è§†é¢‘æ…¢æ”¾åï¼Œå­—å¹•æ—¶é—´è½´æ— æ³•åŒ¹é…å½“å‰ç”»é¢ã€‚

### å…·ä½“è¡¨ç°
- è§†é¢‘å¯ä»¥æ­£å¸¸åŒ¹é…éŸ³é¢‘æ—¶é—´
- ç”»é¢æµç•…æ…¢æ”¾
- ä½†å­—å¹•æ˜¾ç¤ºçš„æ—¶é—´å’Œç”»é¢ä¸å¯¹åº”

### é—®é¢˜åœºæ™¯
```
åŸè§†é¢‘ï¼š85.24ç§’
TTSéŸ³è½¨ï¼š169.68ç§’
æ‹‰ä¼¸ç³»æ•°ï¼š1.991x

å¤„ç†åï¼š
âœ… è§†é¢‘æ…¢æ”¾åˆ°169.68ç§’
âœ… éŸ³é¢‘æ­£å¸¸æ’­æ”¾169.68ç§’
âŒ å­—å¹•æ—¶é—´è½´è¿˜æ˜¯åŸºäº85ç§’çš„åŸè§†é¢‘
âŒ å­—å¹•åœ¨é”™è¯¯çš„ç”»é¢æ—¶åˆ»æ˜¾ç¤º
```

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜åˆ†æ

1. **è§†é¢‘è¢«æ…¢æ”¾**
   - åŸè§†é¢‘85ç§’é€šè¿‡ `setpts=1.991*PTS` æ…¢æ”¾åˆ°169ç§’
   - ç”»é¢æ—¶é•¿å˜ä¸ºåŸæ¥çš„1.991å€

2. **å­—å¹•æ—¶é—´è½´æœªè°ƒæ•´**
   - å­—å¹•æ–‡ä»¶ä¸­çš„æ—¶é—´æˆ³è¿˜æ˜¯åŸºäºåŸè§†é¢‘
   - ä¾‹å¦‚ï¼š`00:00:10,000` è¡¨ç¤ºåŸè§†é¢‘çš„ç¬¬10ç§’
   - ä½†åŸè§†é¢‘çš„ç¬¬10ç§’ï¼Œåœ¨æ…¢æ”¾åå˜æˆäº†ç¬¬19.91ç§’

3. **æ—¶é—´ä¸åŒ¹é…**
   ```
   åŸè§†é¢‘æ—¶é—´è½´ï¼š0ç§’ -------- 10ç§’ -------- 85ç§’
   æ…¢æ”¾åæ—¶é—´è½´ï¼š0ç§’ -------- 19.91ç§’ ----- 169ç§’
   å­—å¹•æ—¶é—´è½´ï¼š  0ç§’ -------- 10ç§’ -------- 85ç§’ âŒ
   
   ç»“æœï¼šå­—å¹•åœ¨10ç§’æ˜¾ç¤ºï¼Œä½†å¯¹åº”çš„ç”»é¢åœ¨19.91ç§’
   ```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
**åœ¨çƒ§å½•å­—å¹•å‰ï¼Œå…ˆè°ƒæ•´å­—å¹•æ—¶é—´è½´ä»¥åŒ¹é…æ…¢æ”¾åçš„è§†é¢‘**

### å®ç°æ­¥éª¤

#### 1. æ·»åŠ å­—å¹•æ—¶é—´è½´è°ƒæ•´æ–¹æ³•

```python
def _adjust_subtitle_timeline(self, subtitle_path: Path, stretch_ratio: float, output_path: Path) -> Path:
    """
    è°ƒæ•´å­—å¹•æ—¶é—´è½´ä»¥åŒ¹é…è§†é¢‘æ…¢æ”¾
    
    Args:
        subtitle_path: åŸå§‹å­—å¹•æ–‡ä»¶è·¯å¾„
        stretch_ratio: æ‹‰ä¼¸ç³»æ•°
        output_path: è°ƒæ•´åçš„å­—å¹•æ–‡ä»¶è·¯å¾„
        
    Returns:
        è°ƒæ•´åçš„å­—å¹•æ–‡ä»¶è·¯å¾„
    """
    # è¯»å–åŸå§‹å­—å¹•
    with open(subtitle_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # è°ƒæ•´æ‰€æœ‰æ—¶é—´æˆ³
    def adjust_timestamp(match):
        time_str = match.group(0)
        # è§£ææ—¶é—´æˆ³: HH:MM:SS,mmm
        # è½¬æ¢ä¸ºæ¯«ç§’
        # ä¹˜ä»¥æ‹‰ä¼¸ç³»æ•°
        # è½¬æ¢å›æ—¶é—´æ ¼å¼
        return adjusted_time_str
    
    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢æ‰€æœ‰æ—¶é—´æˆ³
    pattern = r'\d{2}:\d{2}:\d{2},\d{3}'
    adjusted_content = re.sub(pattern, adjust_timestamp, content)
    
    # ä¿å­˜è°ƒæ•´åçš„å­—å¹•
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(adjusted_content)
    
    return output_path
```

#### 2. åœ¨çƒ§å½•å­—å¹•å‰è°ƒæ•´æ—¶é—´è½´

```python
if has_subtitle:
    # å¦‚æœéœ€è¦æ…¢æ”¾ï¼Œå…ˆè°ƒæ•´å­—å¹•æ—¶é—´è½´
    subtitle_to_use = subtitle_path
    if need_stretch:
        # åˆ›å»ºä¸´æ—¶è°ƒæ•´åçš„å­—å¹•æ–‡ä»¶
        adjusted_subtitle_path = subtitle_path.parent / f"{subtitle_path.stem}_adjusted{subtitle_path.suffix}"
        subtitle_to_use = self._adjust_subtitle_timeline(subtitle_path, stretch_ratio, adjusted_subtitle_path)
    
    # ä½¿ç”¨è°ƒæ•´åçš„å­—å¹•çƒ§å½•
    subtitle_path_str = str(subtitle_to_use).replace('\\', '/').replace(':', '\\:')
    video_filter = f"[0:v]setpts={stretch_ratio}*PTS,fps={target_fps},subtitles='{subtitle_path_str}'[vout]"
```

## ğŸ“Š æ—¶é—´è½´è°ƒæ•´ç¤ºä¾‹

### åœºæ™¯ï¼šæ‹‰ä¼¸ç³»æ•° 1.991x

#### åŸå§‹å­—å¹•
```srt
1
00:00:10,000 --> 00:00:15,000
ç¬¬ä¸€å¥å­—å¹•

2
00:00:30,000 --> 00:00:35,000
ç¬¬äºŒå¥å­—å¹•

3
00:01:00,000 --> 00:01:05,000
ç¬¬ä¸‰å¥å­—å¹•
```

#### è°ƒæ•´åçš„å­—å¹•
```srt
1
00:00:19,910 --> 00:00:29,865
ç¬¬ä¸€å¥å­—å¹•

2
00:00:59,730 --> 00:01:09,685
ç¬¬äºŒå¥å­—å¹•

3
00:01:59,460 --> 00:02:09,415
ç¬¬ä¸‰å¥å­—å¹•
```

### è®¡ç®—è¿‡ç¨‹

```
åŸå§‹æ—¶é—´æˆ³ â†’ è½¬æ¢ä¸ºç§’ â†’ ä¹˜ä»¥æ‹‰ä¼¸ç³»æ•° â†’ è½¬æ¢å›æ—¶é—´æˆ³

ç¤ºä¾‹1ï¼š
00:00:10,000 â†’ 10.0ç§’ â†’ 10.0 Ã— 1.991 = 19.91ç§’ â†’ 00:00:19,910

ç¤ºä¾‹2ï¼š
00:00:30,000 â†’ 30.0ç§’ â†’ 30.0 Ã— 1.991 = 59.73ç§’ â†’ 00:00:59,730

ç¤ºä¾‹3ï¼š
00:01:00,000 â†’ 60.0ç§’ â†’ 60.0 Ã— 1.991 = 119.46ç§’ â†’ 00:01:59,460
```

## ğŸ¯ å®Œæ•´å·¥ä½œæµç¨‹

### 1. æ£€æµ‹éŸ³è§†é¢‘æ—¶é•¿å·®å¼‚
```python
video_duration = 85.24ç§’
audio_duration = 169.68ç§’
stretch_ratio = 169.68 / 85.24 = 1.991x
```

### 2. è°ƒæ•´å­—å¹•æ—¶é—´è½´
```python
# åˆ›å»ºè°ƒæ•´åçš„å­—å¹•æ–‡ä»¶
adjusted_subtitle = adjust_subtitle_timeline(
    original_subtitle,
    stretch_ratio=1.991,
    output_path="subtitle_adjusted.srt"
)
```

### 3. æ…¢æ”¾è§†é¢‘å¹¶çƒ§å½•è°ƒæ•´åçš„å­—å¹•
```python
# ä½¿ç”¨è°ƒæ•´åçš„å­—å¹•
video_filter = f"[0:v]setpts=1.991*PTS,fps=15.06,subtitles='subtitle_adjusted.srt'[vout]"
```

### 4. æœ€ç»ˆæ•ˆæœ
```
æ—¶é—´è½´å¯¹æ¯”ï¼š
åŸè§†é¢‘ï¼š  0ç§’ -------- 10ç§’ -------- 30ç§’ -------- 85ç§’
æ…¢æ”¾åï¼š  0ç§’ -------- 19.91ç§’ ----- 59.73ç§’ ----- 169ç§’
å­—å¹•ï¼š    0ç§’ -------- 19.91ç§’ ----- 59.73ç§’ ----- 169ç§’ âœ…

ç»“æœï¼š
âœ… å­—å¹•åœ¨19.91ç§’æ˜¾ç¤ºï¼Œå¯¹åº”æ…¢æ”¾åçš„ç¬¬19.91ç§’ç”»é¢
âœ… å­—å¹•å’Œç”»é¢å®Œç¾åŒæ­¥
âœ… éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ä¸‰è€…å®Œç¾å¯¹é½
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
```bash
python test_subtitle_timeline_simple.py
```

### æµ‹è¯•åœºæ™¯
1. **è½»å¾®æ…¢æ”¾ï¼ˆ1.5xï¼‰**
   - 10ç§’ â†’ 15ç§’
   - 30ç§’ â†’ 45ç§’

2. **ä¸­åº¦æ…¢æ”¾ï¼ˆ2.0xï¼‰**
   - 10ç§’ â†’ 20ç§’
   - 30ç§’ â†’ 60ç§’

3. **å®é™…åœºæ™¯ï¼ˆ1.991xï¼‰**
   - 10ç§’ â†’ 19.91ç§’
   - 30ç§’ â†’ 59.73ç§’
   - 85ç§’ â†’ 169.46ç§’

### éªŒè¯æ–¹æ³•
1. æ’­æ”¾åˆå¹¶åçš„è§†é¢‘
2. è§‚å¯Ÿå­—å¹•æ˜¾ç¤ºæ—¶é—´
3. æ£€æŸ¥å­—å¹•æ˜¯å¦åœ¨æ­£ç¡®çš„ç”»é¢æ—¶åˆ»æ˜¾ç¤º
4. ç¡®è®¤éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ä¸‰è€…åŒæ­¥

## ğŸ“‹ æŠ€æœ¯ç»†èŠ‚

### SRTæ—¶é—´æˆ³æ ¼å¼
```
HH:MM:SS,mmm --> HH:MM:SS,mmm

HH: å°æ—¶ (00-99)
MM: åˆ†é’Ÿ (00-59)
SS: ç§’ (00-59)
mmm: æ¯«ç§’ (000-999)
```

### æ—¶é—´è½¬æ¢ç®—æ³•
```python
# æ—¶é—´æˆ³ â†’ æ¯«ç§’
total_ms = (hours * 3600 + minutes * 60 + seconds) * 1000 + milliseconds

# åº”ç”¨æ‹‰ä¼¸ç³»æ•°
new_total_ms = int(total_ms * stretch_ratio)

# æ¯«ç§’ â†’ æ—¶é—´æˆ³
new_hours = new_total_ms // 3600000
new_minutes = (new_total_ms % 3600000) // 60000
new_seconds = (new_total_ms % 60000) // 1000
new_milliseconds = new_total_ms % 1000
```

### æ­£åˆ™è¡¨è¾¾å¼
```python
# åŒ¹é…SRTæ—¶é—´æˆ³
pattern = r'\d{2}:\d{2}:\d{2},\d{3}'

# æ›¿æ¢æ‰€æœ‰æ—¶é—´æˆ³
adjusted_content = re.sub(pattern, adjust_timestamp, content)
```

## âœ… ä¿®å¤çŠ¶æ€

- [x] æ·»åŠ  `_adjust_subtitle_timeline()` æ–¹æ³•
- [x] ä¿®æ”¹æ›¿æ¢éŸ³è½¨æ¨¡å¼ï¼Œåœ¨çƒ§å½•å‰è°ƒæ•´å­—å¹•
- [x] åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
- [x] æ›´æ–°æ–‡æ¡£è¯´æ˜
- [ ] ç­‰å¾…ç”¨æˆ·éªŒè¯å®é™…æ•ˆæœ

## ğŸ“ æ€»ç»“

### é—®é¢˜
è§†é¢‘æ…¢æ”¾åï¼Œå­—å¹•æ—¶é—´è½´ä¸åŒ¹é…ç”»é¢

### åŸå› 
å­—å¹•æ—¶é—´æˆ³åŸºäºåŸè§†é¢‘ï¼Œæœªéšè§†é¢‘æ…¢æ”¾è€Œè°ƒæ•´

### è§£å†³
åœ¨çƒ§å½•å­—å¹•å‰ï¼Œå°†æ‰€æœ‰æ—¶é—´æˆ³ä¹˜ä»¥æ‹‰ä¼¸ç³»æ•°

### æ•ˆæœ
- âœ… å­—å¹•åœ¨æ­£ç¡®çš„ç”»é¢æ—¶åˆ»æ˜¾ç¤º
- âœ… éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ä¸‰è€…å®Œç¾åŒæ­¥
- âœ… è§‚çœ‹ä½“éªŒæµç•…è‡ªç„¶

---

**ä¿®å¤æ—¥æœŸ**: 2024-12-17  
**ç‰ˆæœ¬**: v1.3.3
