# 视频合并快速指南

## 🚀 快速开始

### 1. 启动服务
```bash
start.bat
```

### 2. 访问界面
- 浏览器自动打开主界面
- 点击"视频合并"标签页

### 3. 上传文件

#### 场景1：仅替换音轨
```
✅ 上传MP4视频文件
✅ 上传WAV/MP3音频文件
❌ 不上传字幕文件
```

#### 场景2：替换音轨 + 烧录字幕（推荐）
```
✅ 上传MP4视频文件
✅ 上传WAV/MP3音频文件
✅ 上传SRT字幕文件
```

### 4. 选择模式
- **推荐**：替换音轨 + 烧录字幕
- 系统会自动检测是否有字幕文件
- 有字幕：自动烧录到画面
- 无字幕：仅替换音轨

### 5. 开始合并
- 点击"开始合并"按钮
- 实时查看进度
- 等待处理完成

### 6. 下载结果
- 预览合并后的视频
- 点击"下载视频"保存文件
- 或点击"打开文件夹"查看输出目录

## 🎯 常见使用场景

### 场景A：视频配音（自动慢放同步）
```
输入：
- 原视频.mp4 (30秒)
- TTS音轨.wav (45秒)

操作：
1. 上传视频和音频
2. 选择"替换音轨"模式
3. 开始合并

输出：
- 视频自动慢放1.5倍 → 30秒变为45秒
- 音轨完整播放45秒
- 画面流畅播放，无静止无黑屏
- 音视频完美同步

效果：
✅ 画面慢放50%（可接受）
✅ 无黑屏问题
✅ 一键完成
```

### 场景B：视频配音 + 字幕（自动慢放同步）
```
输入：
- 原视频.mp4 (30秒)
- TTS音轨.wav (45秒)
- 字幕.srt

操作：
1. 上传视频、音频和字幕
2. 选择"替换音轨 + 烧录字幕"模式
3. 开始合并

输出：
- 视频自动慢放1.5倍 → 30秒变为45秒
- 音轨完整播放45秒
- 字幕烧录到画面并同步
- 音视频字幕三者完美同步

效果：
✅ 画面慢放50%
✅ 字幕正确显示
✅ 完美同步
```

### 场景C：最佳方案（TTS时长控制 + 视频合并）
```
步骤1：TTS配音（控制时长）
- 原视频: 30秒
- 启用"保持SRT总时长不变"
- 生成TTS音轨: 30秒 ← 自动匹配

步骤2：视频合并
- 上传视频(30秒) + 音轨(30秒) + 字幕
- 选择"替换音轨 + 烧录字幕"
- 开始合并

输出：
- 视频正常速度播放30秒
- 音轨完整播放30秒
- 字幕烧录到画面
- 完美同步，无慢放

效果：
✅ 视频正常速度（最佳）
✅ 音视频时长完全匹配
✅ 最佳观看体验
```

### 场景C：保留原音 + 配音
```
输入：
- 原视频.mp4 (含原音轨)
- TTS音轨.wav

操作：
1. 上传视频和音频
2. 选择"混合音轨"模式
3. 开始合并

输出：
- 原音轨和TTS音轨混合播放
- 适合需要保留背景音的场景
```

## 📝 字幕文件准备

### SRT格式示例
```srt
1
00:00:00,000 --> 00:00:05,000
这是第一句字幕

2
00:00:05,000 --> 00:00:10,000
这是第二句字幕

3
00:00:10,000 --> 00:00:15,000
这是第三句字幕
```

### 字幕格式要点
- ✅ 使用UTF-8编码保存
- ✅ 时间格式：HH:MM:SS,mmm
- ✅ 每个字幕块之间有空行
- ✅ 序号连续递增
- ❌ 时间轴不要重叠

### 创建示例字幕
```bash
python test_subtitle_burn.py --create-sample
```

## ⚡ 性能优化建议

### 文件大小
- 视频：建议不超过500MB
- 音频：建议不超过100MB
- 字幕：通常小于1MB

### 处理时间
| 操作 | 预计时间 | 说明 |
|------|---------|------|
| 仅替换音轨 | 1-2分钟 | 视频不需要重新编码 |
| 替换音轨+延长视频 | 2-5分钟 | 需要重新编码视频 |
| 烧录字幕 | 3-10分钟 | 需要重新编码视频 |
| 混合音轨 | 2-5分钟 | 需要音频处理 |

### 加速技巧
1. **使用SSD硬盘**：提升读写速度
2. **关闭其他程序**：释放CPU和内存
3. **选择合适的模式**：
   - 不需要字幕？选择"仅替换音轨"
   - 音轨不比视频长？处理更快
4. **优化视频分辨率**：
   - 1080p以下处理更快
   - 4K视频需要更长时间

## 🔧 故障排除

### 问题1：字幕不显示
```
原因：字幕文件格式错误
解决：
1. 检查SRT格式是否正确
2. 确认使用UTF-8编码
3. 使用test_subtitle_burn.py测试
```

### 问题2：音视频不同步
```
原因：时间戳问题
解决：
1. 系统已自动添加 -avoid_negative_ts 参数
2. 检查原始文件是否已经不同步
3. 确认TTS音轨从0秒开始
```

### 问题3：视频慢放效果太明显
```
原因：音轨比视频长太多，拉伸系数过大
示例：视频30秒，音轨60秒 → 拉伸2.0x（慢放100%）

解决方案：
方案A：使用TTS时长控制（推荐）
1. TTS配音时启用"保持SRT总时长不变"
2. 设置最大加速倍率（如2.0x）
3. 系统自动调整TTS音轨时长匹配原视频
4. 视频合并时无需慢放或仅轻微慢放

方案B：手动调整音轨
1. 使用音频编辑软件加速TTS音轨
2. 将音轨时长调整到接近视频时长
3. 重新进行视频合并

建议拉伸系数：
✅ < 1.3x：效果自然
⚠️ 1.3x - 1.5x：可接受
❌ > 1.5x：明显慢放，建议优化
```

### 问题4：处理时间过长
```
原因：视频需要重新编码
优化：
1. 降低视频分辨率
2. 使用更快的硬件
3. 如果不需要字幕，选择"仅替换音轨"
```

## 📊 模式对比

| 模式 | 音轨 | 字幕 | 重新编码 | 速度 | 推荐场景 |
|------|------|------|---------|------|---------|
| 替换音轨 | 替换 | 可选烧录 | 有字幕时需要 | 中等 | ⭐推荐 |
| 混合音轨 | 混合 | 可选 | 需要 | 慢 | 保留原音 |
| 嵌入字幕 | 替换 | 软字幕 | 不需要 | 快 | 可开关字幕 |
| 去除音轨 | 移除 | 可选 | 不需要 | 快 | 静音视频 |
| 仅视频 | 无 | 无 | 不需要 | 快 | 提取视频流 |

## 🎓 最佳实践

### 1. 文件准备
- ✅ 使用高质量的原视频
- ✅ 确保TTS音轨清晰
- ✅ 字幕时间轴准确
- ✅ 文件命名规范，避免特殊字符

### 2. 模式选择
- **配音项目**：替换音轨 + 烧录字幕
- **教学视频**：嵌入字幕（软字幕）
- **解说视频**：混合音轨
- **静音视频**：去除音轨

### 3. 质量控制
- 合并前预览原文件
- 合并后检查输出质量
- 验证音视频同步
- 确认字幕显示正确

### 4. 推荐工作流程（避免黑屏问题）
```
步骤1：TTS配音
- 上传原视频的SRT字幕
- 启用"保持SRT总时长不变"功能
- 设置最大加速倍率（推荐1.5x-2.0x）
- 生成TTS音轨（时长自动匹配原视频）

步骤2：视频合并
- 上传原视频
- 上传TTS音轨（时长已匹配）
- 上传字幕文件
- 选择"替换音轨 + 烧录字幕"
- 开始合并

结果：
✅ 音视频时长完全一致
✅ 无黑屏问题
✅ 字幕完美同步
✅ 配音清晰流畅
```

### 5. 时长匹配的重要性
```
❌ 不推荐：
原视频: 1分50秒
TTS音轨: 2分49秒
→ 视频结束后59秒黑屏

✅ 推荐：
原视频: 1分50秒
TTS音轨: 1分50秒（通过"保持SRT总时长"功能实现）
→ 音视频完美同步，无黑屏
```

## 📞 获取帮助

### 测试工具
```bash
# 测试字幕烧录
python test_subtitle_burn.py

# 创建示例字幕
python test_subtitle_burn.py --create-sample

# 查看字幕格式说明
python test_subtitle_burn.py --explain

# 测试音视频同步
python test_video_sync.py
```

### 文档资源
- `doc/视频合并集成说明.md` - 完整功能说明
- `doc/视频合并工具使用指南.md` - 详细使用指南
- `doc/CHANGELOG-动态时间轴.md` - 更新日志

### 常见问题
查看"故障排除"部分或查阅完整文档
