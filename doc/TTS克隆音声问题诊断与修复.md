# TTSå…‹éš†éŸ³å£°é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

ä½¿ç”¨GPT-SoVITSè¿›è¡ŒTTSé…éŸ³æ—¶ï¼Œå¶å°”ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š
1. **é…å‡ºå‚è€ƒæ–‡æœ¬çš„å£°éŸ³**ï¼šè¾“å‡ºçš„æ˜¯å‚è€ƒéŸ³é¢‘çš„åŸå£°ï¼Œè€Œä¸æ˜¯ç”¨å­¦åˆ°çš„éŸ³è‰²åˆæˆæ–°æ–‡æœ¬
2. **è¯­è¨€ä¸åŒ¹é…**ï¼šå‚è€ƒéŸ³é¢‘æ˜¯æ—¥è¯­ï¼Œä½†ç³»ç»Ÿè¯†åˆ«ä¸ºä¸­æ–‡

## é—®é¢˜æ ¹æº

### 1. å‚è€ƒæ–‡æœ¬è¯­è¨€ï¼ˆprompt_langï¼‰è®¾ç½®é”™è¯¯

**ä»£ç ä¸­çš„é—®é¢˜**ï¼š
```python
params = {
    'text': text,                    # è¦åˆæˆçš„æ–‡æœ¬ï¼ˆæ—¥è¯­ï¼‰
    'text_lang': 'ja',               # ç›®æ ‡è¯­è¨€ï¼ˆæ—¥è¯­ï¼‰
    'ref_audio_path': 'audio.mp3',   # å‚è€ƒéŸ³é¢‘ï¼ˆæ—¥è¯­ï¼‰
    'prompt_text': 'æ—¥è¯­å‚è€ƒæ–‡æœ¬',    # å‚è€ƒæ–‡æœ¬ï¼ˆæ—¥è¯­ï¼‰
    'prompt_lang': 'zh',             # âŒ é”™è¯¯ï¼é»˜è®¤æ˜¯ä¸­æ–‡
    'speed_factor': 1.0
}
```

**æ­£ç¡®çš„è®¾ç½®**ï¼š
```python
params = {
    'text': text,
    'text_lang': 'ja',
    'ref_audio_path': 'audio.mp3',
    'prompt_text': 'æ—¥è¯­å‚è€ƒæ–‡æœ¬',
    'prompt_lang': 'ja',             # âœ… æ­£ç¡®ï¼åº”è¯¥æ˜¯æ—¥è¯­
    'speed_factor': 1.0
}
```

### 2. å‚è€ƒæ–‡æœ¬ä¸ç›®æ ‡æ–‡æœ¬ç›¸ä¼¼

å½“å‚è€ƒæ–‡æœ¬ï¼ˆprompt_textï¼‰ä¸è¦åˆæˆçš„æ–‡æœ¬ï¼ˆtextï¼‰ç›¸ä¼¼æˆ–ç›¸åŒæ—¶ï¼ŒTTSæ¨¡å‹å¯èƒ½ä¼šï¼š
- ç›´æ¥è¾“å‡ºå‚è€ƒéŸ³é¢‘çš„å£°éŸ³ç‰‡æ®µ
- è€Œä¸æ˜¯ç”¨å­¦åˆ°çš„éŸ³è‰²åˆæˆæ–°æ–‡æœ¬

**ç¤ºä¾‹**ï¼š
```python
# âŒ é”™è¯¯ç¤ºä¾‹
prompt_text = "ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ç”°ä¸­ã§ã™"
text = "ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ç”°ä¸­ã§ã™"  # ä¸å‚è€ƒæ–‡æœ¬ç›¸åŒï¼

# âœ… æ­£ç¡®ç¤ºä¾‹
prompt_text = "ã“ã‚“ã«ã¡ã¯ã€ç§ã¯ç”°ä¸­ã§ã™"
text = "ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­"  # ä¸å‚è€ƒæ–‡æœ¬ä¸åŒ
```

### 3. å‚è€ƒéŸ³é¢‘è´¨é‡é—®é¢˜

- å‚è€ƒéŸ³é¢‘åŒ…å«èƒŒæ™¯å™ªéŸ³
- å‚è€ƒéŸ³é¢‘æƒ…æ„Ÿè¿‡äºå¼ºçƒˆ
- å‚è€ƒéŸ³é¢‘è¯­é€Ÿå¼‚å¸¸
- å‚è€ƒéŸ³é¢‘æ—¶é•¿ä¸åˆé€‚ï¼ˆå¤ªçŸ­æˆ–å¤ªé•¿ï¼‰

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥TTSé…ç½®æ–‡ä»¶

æ‰“å¼€ `tts_config.json`ï¼Œæ£€æŸ¥æ¯ä¸ªè§’è‰²çš„é…ç½®ï¼š

```json
{
  "gptSovits": {
    "roles": [
      {
        "name": "spk01",
        "refAudioPath": "cs3.mp3",
        "promptText": "ä½•ã§ã ã‚ˆ ç§ãŸã¡ã¯æ²»ç™‚ã‚’å—ã‘ã«æ¥ãŸã‚“ã ã‚ˆ",
        "promptLang": "ja",  // âœ… ç¡®è®¤è¿™é‡Œæ˜¯ "ja"ï¼ˆæ—¥è¯­ï¼‰
        "speedFactor": 1
      }
    ]
  }
}
```

**æ£€æŸ¥æ¸…å•**ï¼š
- âœ… `promptLang` æ˜¯å¦è®¾ç½®ä¸º `"ja"`ï¼ˆæ—¥è¯­ï¼‰
- âœ… `promptText` æ˜¯å¦æ˜¯æ—¥è¯­æ–‡æœ¬
- âœ… `refAudioPath` æŒ‡å‘çš„éŸ³é¢‘æ˜¯å¦æ˜¯æ—¥è¯­
- âœ… `promptText` ä¸å‚è€ƒéŸ³é¢‘çš„å†…å®¹æ˜¯å¦åŒ¹é…

### æ­¥éª¤2ï¼šæ£€æŸ¥ä»£ç ä¸­çš„é»˜è®¤å€¼

æŸ¥çœ‹ `src/scripts/tts_dubbing_processor.py` ä¸­çš„ä»£ç ï¼š

```python
# ç¬¬241è¡Œé™„è¿‘
params_test = {
    'text': text,
    'text_lang': role_config.get('text_lang', self.text_lang),
    'ref_audio_path': role_config.get('refAudioPath', ''),
    'prompt_text': role_config.get('promptText', ''),
    'prompt_lang': role_config.get('promptLang', 'zh'),  # âš ï¸ é»˜è®¤æ˜¯'zh'
    'speed_factor': 1.0
}
```

**é—®é¢˜**ï¼šå¦‚æœé…ç½®ä¸­æ²¡æœ‰ `promptLang`ï¼Œä¼šé»˜è®¤ä½¿ç”¨ `'zh'`ï¼ˆä¸­æ–‡ï¼‰

### æ­¥éª¤3ï¼šæŸ¥çœ‹æ—¥å¿—è¾“å‡º

è¿è¡ŒTTSé…éŸ³æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¸­çš„APIè°ƒç”¨å‚æ•°ï¼š

```
ğŸ”„ è°ƒç”¨GPT-SoVITS API [spk01, è¯­é€Ÿ=1.00x]: ã“ã‚“ã«ã¡ã¯...
```

**éœ€è¦ç¡®è®¤**ï¼š
- å‚è€ƒéŸ³é¢‘è·¯å¾„æ˜¯å¦æ­£ç¡®
- å‚è€ƒæ–‡æœ¬æ˜¯å¦æ­£ç¡®
- å‚è€ƒæ–‡æœ¬è¯­è¨€æ˜¯å¦æ­£ç¡®

### æ­¥éª¤4ï¼šæµ‹è¯•å•ä¸ªè§’è‰²

åœ¨TTSæ¨¡å‹ç®¡ç†ç•Œé¢ï¼š
1. é€‰æ‹©ä¸€ä¸ªè§’è‰²
2. è¾“å…¥æµ‹è¯•æ–‡æœ¬ï¼ˆæ—¥è¯­ï¼‰
3. ç‚¹å‡»"æµ‹è¯•"
4. å¬æµ‹è¯•éŸ³é¢‘æ˜¯å¦æ­£å¸¸

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç¡®ä¿é…ç½®æ–‡ä»¶æ­£ç¡®ï¼ˆæ¨èï¼‰

åœ¨ `tts_config.json` ä¸­ï¼Œä¸ºæ¯ä¸ªè§’è‰²æ˜ç¡®è®¾ç½® `promptLang`ï¼š

```json
{
  "name": "spk01",
  "refAudioPath": "japanese_audio.mp3",
  "promptText": "æ—¥è¯­å‚è€ƒæ–‡æœ¬",
  "promptLang": "ja",  // âœ… æ˜ç¡®è®¾ç½®ä¸ºæ—¥è¯­
  "speedFactor": 1
}
```

### æ–¹æ¡ˆ2ï¼šä¿®æ”¹ä»£ç é»˜è®¤å€¼

å¦‚æœä¸»è¦ä½¿ç”¨æ—¥è¯­ï¼Œå¯ä»¥ä¿®æ”¹ä»£ç ä¸­çš„é»˜è®¤å€¼ï¼š

```python
# src/scripts/tts_dubbing_processor.py
# ç¬¬278è¡Œé™„è¿‘

# åŸæ¥ï¼š
'prompt_lang': role_config.get('promptLang', 'zh'),

# ä¿®æ”¹ä¸ºï¼š
'prompt_lang': role_config.get('promptLang', self.text_lang),  # ä½¿ç”¨ç›®æ ‡è¯­è¨€ä½œä¸ºé»˜è®¤å€¼
```

è¿™æ ·ï¼Œå¦‚æœé…ç½®ä¸­æ²¡æœ‰ `promptLang`ï¼Œä¼šä½¿ç”¨ `text_lang`ï¼ˆç›®æ ‡è¯­è¨€ï¼‰ä½œä¸ºé»˜è®¤å€¼ã€‚

### æ–¹æ¡ˆ3ï¼šæ·»åŠ è¯­è¨€è‡ªåŠ¨æ£€æµ‹

åœ¨ä»£ç ä¸­æ·»åŠ è¯­è¨€æ£€æµ‹é€»è¾‘ï¼š

```python
def _detect_prompt_lang(self, prompt_text, text_lang):
    """æ ¹æ®å‚è€ƒæ–‡æœ¬å†…å®¹æ£€æµ‹è¯­è¨€"""
    import re
    
    # æ£€æµ‹æ—¥è¯­å­—ç¬¦
    if re.search(r'[\u3040-\u309F\u30A0-\u30FF]', prompt_text):
        return 'ja'
    
    # æ£€æµ‹ä¸­æ–‡å­—ç¬¦
    if re.search(r'[\u4E00-\u9FFF]', prompt_text):
        return 'zh'
    
    # æ£€æµ‹è‹±æ–‡
    if re.match(r'^[a-zA-Z\s\.,!?;:\'\"()-]+$', prompt_text):
        return 'en'
    
    # é»˜è®¤ä½¿ç”¨ç›®æ ‡è¯­è¨€
    return text_lang
```

### æ–¹æ¡ˆ4ï¼šä¼˜åŒ–å‚è€ƒæ–‡æœ¬é€‰æ‹©

**å‚è€ƒæ–‡æœ¬çš„æœ€ä½³å®è·µ**ï¼š

1. **é•¿åº¦é€‚ä¸­**ï¼š3-10ç§’çš„éŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬
2. **å†…å®¹æ¸…æ™°**ï¼šå‘éŸ³æ¸…æ™°ï¼Œæ— èƒŒæ™¯å™ªéŸ³
3. **æƒ…æ„Ÿä¸­æ€§**ï¼šé¿å…è¿‡äºæ¿€åŠ¨æˆ–æ‚²ä¼¤çš„è¯­æ°”
4. **è¯­é€Ÿæ­£å¸¸**ï¼šä¸è¦å¤ªå¿«æˆ–å¤ªæ…¢
5. **ä¸ç›®æ ‡æ–‡æœ¬ä¸åŒ**ï¼šé¿å…ä¸è¦åˆæˆçš„æ–‡æœ¬ç›¸åŒ

**ç¤ºä¾‹**ï¼š

```json
{
  "name": "spk01",
  "refAudioPath": "sample.mp3",
  "promptText": "ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚æ•£æ­©ã«è¡Œãã¾ã—ã‚‡ã†ã€‚",  // ä¸­æ€§ã€æ¸…æ™°
  "promptLang": "ja",
  "speedFactor": 1
}
```

## éªŒè¯ä¿®å¤

### 1. é‡æ–°æµ‹è¯•è§’è‰²

åœ¨TTSæ¨¡å‹ç®¡ç†ç•Œé¢ï¼š
1. é‡æ–°åŠ è½½é…ç½®
2. æµ‹è¯•æ¯ä¸ªè§’è‰²
3. ç¡®è®¤è¾“å‡ºçš„æ˜¯åˆæˆéŸ³è‰²ï¼Œè€Œä¸æ˜¯å‚è€ƒéŸ³é¢‘åŸå£°

### 2. æ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹TTSè°ƒç”¨æ—¥å¿—ï¼Œç¡®è®¤å‚æ•°æ­£ç¡®ï¼š

```
ğŸ”„ è°ƒç”¨GPT-SoVITS API [spk01, è¯­é€Ÿ=1.00x]: ã“ã‚“ã«ã¡ã¯...
  å‚æ•°:
    text: ã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­
    text_lang: ja
    ref_audio_path: cs3.mp3
    prompt_text: ä½•ã§ã ã‚ˆ ç§ãŸã¡ã¯æ²»ç™‚ã‚’å—ã‘ã«æ¥ãŸã‚“ã ã‚ˆ
    prompt_lang: ja  âœ… æ­£ç¡®ï¼
    speed_factor: 1.0
```

### 3. å¯¹æ¯”æµ‹è¯•

ä½¿ç”¨ç›¸åŒçš„æ–‡æœ¬ï¼Œåˆ†åˆ«æµ‹è¯•ï¼š
- æ­£ç¡®é…ç½®ï¼ˆpromptLang=jaï¼‰
- é”™è¯¯é…ç½®ï¼ˆpromptLang=zhï¼‰

å¯¹æ¯”ä¸¤è€…çš„è¾“å‡ºï¼Œç¡®è®¤ä¿®å¤æœ‰æ•ˆã€‚

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ­£å¸¸ï¼Œæœ‰æ—¶å€™ä¸æ­£å¸¸ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› ï¼š
1. ä¸åŒè§’è‰²çš„é…ç½®ä¸ä¸€è‡´
2. æŸäº›æ–‡æœ¬ä¸å‚è€ƒæ–‡æœ¬ç›¸ä¼¼ï¼Œè§¦å‘äº†"è®°å¿†"
3. GPT-SoVITSæœåŠ¡ä¸ç¨³å®š

### Q2: ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯å—ï¼Ÿ

**A:** 
- ä¿®æ”¹ `tts_config.json` åï¼Œéœ€è¦é‡æ–°åŠ è½½é…ç½®
- åœ¨TTSæ¨¡å‹ç®¡ç†ç•Œé¢ç‚¹å‡»"ä¿å­˜é…ç½®"
- æˆ–è€…é‡å¯æ•´ä¸ªæœåŠ¡

### Q3: å¦‚ä½•é€‰æ‹©å¥½çš„å‚è€ƒéŸ³é¢‘ï¼Ÿ

**A:** å¥½çš„å‚è€ƒéŸ³é¢‘åº”è¯¥ï¼š
- âœ… æ—¶é•¿3-10ç§’
- âœ… å‘éŸ³æ¸…æ™°
- âœ… æ— èƒŒæ™¯å™ªéŸ³
- âœ… æƒ…æ„Ÿä¸­æ€§
- âœ… è¯­é€Ÿæ­£å¸¸
- âœ… å•ä¸€è¯´è¯äºº

### Q4: promptText å’Œ text å¯ä»¥ç›¸åŒå—ï¼Ÿ

**A:** 
- âŒ ä¸æ¨èç›¸åŒ
- ç›¸åŒæ—¶ï¼ŒTTSå¯èƒ½ç›´æ¥è¾“å‡ºå‚è€ƒéŸ³é¢‘
- åº”è¯¥ä½¿ç”¨ä¸åŒçš„æ–‡æœ¬

### Q5: å¦‚ä½•æ‰¹é‡ä¿®å¤é…ç½®ï¼Ÿ

**A:** å¯ä»¥ä½¿ç”¨è„šæœ¬æ‰¹é‡æ›´æ–°ï¼š

```python
import json

# è¯»å–é…ç½®
with open('tts_config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)

# æ‰¹é‡æ›´æ–°promptLang
for role in config['gptSovits']['roles']:
    if 'promptLang' not in role or role['promptLang'] == 'zh':
        # æ£€æµ‹å‚è€ƒæ–‡æœ¬è¯­è¨€
        if any(ord(c) >= 0x3040 and ord(c) <= 0x30FF for c in role['promptText']):
            role['promptLang'] = 'ja'  # æ—¥è¯­
        else:
            role['promptLang'] = 'zh'  # ä¸­æ–‡

# ä¿å­˜é…ç½®
with open('tts_config.json', 'w', encoding='utf-8') as f:
    json.dump(config, f, ensure_ascii=False, indent=2)

print("âœ… é…ç½®å·²æ›´æ–°")
```

## é¢„é˜²æªæ–½

### 1. é…ç½®æ¨¡æ¿

åˆ›å»ºé…ç½®æ¨¡æ¿ï¼Œç¡®ä¿æ¯æ¬¡æ·»åŠ è§’è‰²æ—¶éƒ½åŒ…å«å¿…è¦å­—æ®µï¼š

```json
{
  "name": "è§’è‰²å",
  "refAudioPath": "éŸ³é¢‘è·¯å¾„",
  "promptText": "å‚è€ƒæ–‡æœ¬",
  "promptLang": "ja",  // âš ï¸ å¿…é¡»è®¾ç½®ï¼
  "speedFactor": 1,
  "text_lang": "ja"    // å¯é€‰ï¼Œä½†æ¨èè®¾ç½®
}
```

### 2. é…ç½®éªŒè¯

åœ¨åŠ è½½é…ç½®æ—¶æ·»åŠ éªŒè¯ï¼š

```python
def validate_role_config(role):
    """éªŒè¯è§’è‰²é…ç½®"""
    required_fields = ['name', 'refAudioPath', 'promptText', 'promptLang']
    
    for field in required_fields:
        if field not in role:
            raise ValueError(f"è§’è‰²é…ç½®ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
    
    # éªŒè¯promptLang
    valid_langs = ['zh', 'en', 'ja', 'ko']
    if role['promptLang'] not in valid_langs:
        raise ValueError(f"ä¸æ”¯æŒçš„è¯­è¨€: {role['promptLang']}")
    
    return True
```

### 3. æ—¥å¿—å¢å¼º

åœ¨TTSè°ƒç”¨æ—¶è¾“å‡ºæ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```python
print(f"ğŸ”„ è°ƒç”¨GPT-SoVITS API:")
print(f"   è§’è‰²: {speaker}")
print(f"   æ–‡æœ¬: {text[:50]}...")
print(f"   ç›®æ ‡è¯­è¨€: {text_lang}")
print(f"   å‚è€ƒéŸ³é¢‘: {ref_audio_path}")
print(f"   å‚è€ƒæ–‡æœ¬: {prompt_text[:30]}...")
print(f"   å‚è€ƒè¯­è¨€: {prompt_lang}")  # âš ï¸ é‡ç‚¹æ£€æŸ¥è¿™ä¸€è¡Œ
print(f"   è¯­é€Ÿ: {speed_factor}x")
```

## æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**ï¼š
- `promptLang` é»˜è®¤å€¼æ˜¯ `'zh'`ï¼ˆä¸­æ–‡ï¼‰
- å³ä½¿å‚è€ƒéŸ³é¢‘å’Œå‚è€ƒæ–‡æœ¬æ˜¯æ—¥è¯­
- å¦‚æœé…ç½®ä¸­æ²¡æœ‰æ˜ç¡®è®¾ç½® `promptLang`
- ç³»ç»Ÿä¼šä½¿ç”¨é”™è¯¯çš„è¯­è¨€ï¼Œå¯¼è‡´TTSè¾“å‡ºå¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. âœ… åœ¨é…ç½®æ–‡ä»¶ä¸­æ˜ç¡®è®¾ç½® `promptLang: "ja"`
2. âœ… ä¿®æ”¹ä»£ç é»˜è®¤å€¼ä¸º `self.text_lang`
3. âœ… æ·»åŠ è¯­è¨€è‡ªåŠ¨æ£€æµ‹
4. âœ… ä¼˜åŒ–å‚è€ƒæ–‡æœ¬é€‰æ‹©

**éªŒè¯æ–¹æ³•**ï¼š
1. æ£€æŸ¥é…ç½®æ–‡ä»¶
2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
3. æµ‹è¯•æ¯ä¸ªè§’è‰²
4. å¯¹æ¯”ä¿®å¤å‰åçš„æ•ˆæœ
