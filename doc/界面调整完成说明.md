# 界面调整完成说明 - 智能双重变速机制集成

## ✅ 已完成的修改

### 1. 前端界面修改 (index.html)

#### 单角色配音界面
在"自动对齐时间轴"选项后添加了：

✅ **智能音频加速开关**
```html
<div class="mb-4">
  <label class="flex items-center cursor-pointer">
    <input type="checkbox" v-model="ttsDubbing.enableSmartSpeedup">
    <span class="text-sm text-gray-300">
      <i class="fas fa-magic mr-1 text-primary"></i>
      启用智能音频加速（推荐）
    </span>
  </label>
  <p class="text-xs text-gray-500 ml-6 mt-1">
    自动调整音频速度以匹配字幕时长，提升配音质量
  </p>
</div>
```

✅ **最大加速倍率滑块**
```html
<div v-if="ttsDubbing.enableSmartSpeedup" class="mb-4 bg-dark p-3 rounded border border-gray-700">
  <label class="block text-xs text-gray-400 mb-2">
    最大加速倍率: {{ ttsDubbing.maxAudioSpeedRate.toFixed(1) }}x
  </label>
  <input 
    type="range" 
    v-model.number="ttsDubbing.maxAudioSpeedRate"
    min="1.0" 
    max="2.5" 
    step="0.1"
    class="w-full"
  >
  <div class="flex justify-between text-xs text-gray-600 mt-1">
    <span>1.0x</span>
    <span class="text-gray-500">建议: 1.5x-2.0x</span>
    <span>2.5x</span>
  </div>
</div>
```

#### 多角色配音界面
在高级选项中添加了相同的控件（样式略有调整以适应折叠面板）

### 2. Vue 数据模型更新

✅ **ttsDubbing 数据字段**
```javascript
const ttsDubbing = ref({
  // ... 现有字段
  
  // 新增：智能双重变速机制
  enableSmartSpeedup: false,        // 是否启用智能变速
  enableAudioSpeedup: true,         // 是否启用音频加速
  enableVideoSlowdown: false,       // 是否启用视频慢速
  maxAudioSpeedRate: 2.0,           // 最大音频加速倍率
  maxVideoSpeedRate: 10.0,          // 最大视频慢速倍率
  removeSilentGaps: false,          // 是否移除静音间隙
});
```

✅ **multiRoleDubbing 数据字段**
```javascript
const multiRoleDubbing = ref({
  // ... 现有字段
  
  // 新增：智能双重变速机制（同上）
  enableSmartSpeedup: false,
  enableAudioSpeedup: true,
  enableVideoSlowdown: false,
  maxAudioSpeedRate: 2.0,
  maxVideoSpeedRate: 10.0,
  removeSilentGaps: false,
});
```

### 3. API 调用更新

✅ **startTtsDubbing 函数**
```javascript
// 新增：智能双重变速机制参数
formData.append('enable_smart_speedup', ttsDubbing.value.enableSmartSpeedup);
formData.append('enable_audio_speedup', ttsDubbing.value.enableAudioSpeedup);
formData.append('enable_video_slowdown', ttsDubbing.value.enableVideoSlowdown);
formData.append('max_audio_speed_rate', ttsDubbing.value.maxAudioSpeedRate);
formData.append('max_video_pts_rate', ttsDubbing.value.maxVideoSpeedRate);
formData.append('remove_silent_gaps', ttsDubbing.value.removeSilentGaps);

console.log('智能加速:', ttsDubbing.value.enableSmartSpeedup);
console.log('最大加速倍率:', ttsDubbing.value.maxAudioSpeedRate);
```

✅ **startMultiRoleDubbing 函数**
```javascript
// 新增：智能双重变速机制参数（同上）
formData.append('enable_smart_speedup', multiRoleDubbing.value.enableSmartSpeedup);
// ... 其他参数
```

### 4. 后端 API 接口更新 (main.py)

✅ **/api/tts-dubbing/start 接口**
```python
@app.post("/api/tts-dubbing/start")
async def start_tts_dubbing(
    # ... 现有参数
    
    # 新增：智能双重变速机制参数
    enable_smart_speedup: bool = Form(False),
    enable_audio_speedup: bool = Form(True),
    enable_video_slowdown: bool = Form(False),
    max_audio_speed_rate: float = Form(2.0),
    max_video_pts_rate: float = Form(10.0),
    remove_silent_gaps: bool = Form(False)
):
```

✅ **TTSDubbingProcessor 调用**
```python
processor = TTSDubbingProcessor(
    # ... 现有参数
    
    # 新增：智能双重变速机制参数
    enable_smart_speedup=enable_smart_speedup,
    enable_audio_speedup=enable_audio_speedup,
    enable_video_slowdown=enable_video_slowdown,
    max_audio_speed_rate=max_audio_speed_rate,
    max_video_pts_rate=max_video_pts_rate,
    remove_silent_gaps=remove_silent_gaps
)
```

✅ **/api/tts-dubbing/multi-role 接口**
```python
@app.post("/api/tts-dubbing/multi-role")
async def start_multi_role_dubbing(
    # ... 现有参数
    
    # 新增：智能双重变速机制参数（同上）
    enable_smart_speedup: bool = Form(default=False),
    # ... 其他参数
):
```

### 5. 多角色配音处理器更新 (tts_multi_role_dubbing.py)

✅ **MultiRoleDubbingProcessor.__init__**
```python
def __init__(self, srt_path, output_dir, engine, roles_config, 
             text_lang='zh', speed_factor=1.0, silence_duration=0.5, 
             auto_align=True, api_url=None, api_key=None, 
             task_id=None, task_dict=None,
             # 新增参数
             enable_smart_speedup=False, enable_audio_speedup=True,
             enable_video_slowdown=False, max_audio_speed_rate=2.0,
             max_video_pts_rate=10.0, remove_silent_gaps=False):
```

✅ **super().__init__ 调用**
```python
super().__init__(
    # ... 现有参数
    
    # 新增：智能双重变速机制参数
    enable_smart_speedup=enable_smart_speedup,
    enable_audio_speedup=enable_audio_speedup,
    enable_video_slowdown=enable_video_slowdown,
    max_audio_speed_rate=max_audio_speed_rate,
    max_video_pts_rate=max_video_pts_rate,
    remove_silent_gaps=remove_silent_gaps
)
```

---

## 📝 修改的文件清单

1. ✅ `src/static/index.html` - 前端界面和 Vue 代码
2. ✅ `src/main.py` - 后端 API 接口
3. ✅ `src/scripts/tts_multi_role_dubbing.py` - 多角色配音处理器

**注意**: `src/scripts/tts_dubbing_processor.py` 已经支持这些参数，无需修改。

---

## 🎯 功能说明

### 用户操作流程

1. **上传 SRT 文件**
2. **选择 TTS 引擎和角色**
3. **勾选"启用智能音频加速（推荐）"** ← 新增
4. **调整"最大加速倍率"滑块（1.0x - 2.5x）** ← 新增
5. **点击"开始配音"**

### 功能效果

- **未启用智能加速**: 使用传统拼接方式，配音可能与字幕时长不匹配
- **启用智能加速**: 
  - 自动检测配音时长与字幕时长的差异
  - 优先利用静默间隙容纳配音
  - 如果间隙不足，自动加速音频（最大不超过设定倍率）
  - 输出更新后的字幕文件（时间轴已对齐）

### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| enableSmartSpeedup | false | 是否启用智能变速（总开关） |
| enableAudioSpeedup | true | 是否启用音频加速 |
| maxAudioSpeedRate | 2.0 | 最大音频加速倍率（1.0-2.5） |
| enableVideoSlowdown | false | 是否启用视频慢速（未来功能） |
| maxVideoSpeedRate | 10.0 | 最大视频慢速倍率 |
| removeSilentGaps | false | 是否移除字幕间静音间隙 |

---

## 🧪 测试步骤

### 1. 启动服务

```bash
cd pyannote-audio-web-ui/pyannote-audio-web-ui
python src/main.py
```

### 2. 访问界面

浏览器打开: `http://127.0.0.1:8514`

### 3. 测试单角色配音

1. 切换到"TTS配音"标签
2. 选择"单角色配音"
3. 上传 SRT 文件
4. 选择 TTS 引擎（如 GPT-SoVITS）
5. 选择角色
6. **勾选"启用智能音频加速（推荐）"**
7. **调整滑块到 1.5x**
8. 点击"开始配音"
9. 观察控制台输出：
   ```
   智能加速: true
   最大加速倍率: 1.5
   ```

### 4. 测试多角色配音

1. 选择"多角色配音"
2. 上传带说话人标识的 SRT 文件
3. 配置角色映射
4. 展开"高级选项"
5. **勾选"启用智能音频加速"**
6. **调整滑块到 2.0x**
7. 点击"开始多角色配音"
8. 观察控制台输出

### 5. 验证输出

- 检查生成的音频文件
- 检查更新后的字幕文件（如果启用了智能加速）
- 验证音频时长是否与字幕对齐

---

## 🎨 界面效果

### 单角色配音界面

```
┌─────────────────────────────────────┐
│ 配音配置                             │
├─────────────────────────────────────┤
│ □ 带说话人标识的SRT文件              │
│ [选择文件] 字幕.srt                  │
│                                     │
│ TTS引擎                             │
│ [GPT-SoVITS ▼]                      │
│                                     │
│ 合成语言                             │
│ [中文 ▼]                            │
│                                     │
│ 语速                                 │
│ [━━━●━━━━━━] 1.0x                   │
│                                     │
│ ☑ 自动对齐时间轴                     │
│                                     │
│ ☑ 启用智能音频加速（推荐）            │ ← 新增
│   自动调整音频速度以匹配字幕时长      │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │ 最大加速倍率: 2.0x               │ │ ← 新增
│ │ [━━━━━●━━━━] 1.0x - 2.5x        │ │
│ │ 1.0x    建议: 1.5x-2.0x    2.5x │ │
│ │ 倍率越高，音频压缩越多，但可能   │ │
│ │ 影响音质                         │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [开始配音]                           │
└─────────────────────────────────────┘
```

---

## ⚠️ 注意事项

### 1. 音质影响

| 加速倍率 | 音质影响 | 推荐场景 |
|---------|---------|---------|
| 1.0-1.3x | 几乎无损 | 所有场景 |
| 1.3-1.5x | 轻微影响 | 一般配音 |
| 1.5-2.0x | 明显影响 | 快速预览 |
| >2.0x | 严重失真 | 不推荐 |

### 2. 默认值

- 默认**未启用**智能加速（保持向后兼容）
- 用户需要手动勾选才会启用
- 默认最大加速倍率为 2.0x

### 3. 视频慢速功能

- 当前版本**未实现**视频慢速功能
- 界面中已预留相关参数
- 未来可通过集成完整的 pyvideotrans 算法实现

---

## 🚀 下一步计划

### 短期（可选）

- [ ] 添加"移除静音间隙"选项到界面
- [ ] 添加音频变速引擎选择（rubberband/atempo）
- [ ] 优化界面布局和提示文案

### 长期（未来功能）

- [ ] 添加视频文件上传功能
- [ ] 实现视频慢速处理
- [ ] 集成完整的 pyvideotrans 对齐算法
- [ ] 添加物理时间轴模型支持

---

## 📚 相关文档

- [对齐算法应用总结](./对齐算法应用总结.md)
- [对齐算法移植指南](./对齐算法移植指南.md)
- [界面调整指南](./界面调整指南-对齐算法集成.md)
- [双重变速机制使用说明](./双重变速机制使用说明.md)

---

**完成日期**: 2024-12-15  
**版本**: v1.0  
**状态**: ✅ 已完成并可测试
