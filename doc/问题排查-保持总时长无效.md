# é—®é¢˜æ’æŸ¥ - "ä¿æŒæ€»æ—¶é•¿ä¸å˜"åŠŸèƒ½æ— æ•ˆ

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šå¯ç”¨"ä¿æŒSRTæ€»æ—¶é•¿ä¸å˜"åï¼Œæ²¡æœ‰çœ‹åˆ°æ˜æ˜¾å˜åŒ–ã€‚

## ğŸ§ å¯èƒ½åŸå› åˆ†æ

### åŸå› 1ï¼šè¯­é€Ÿå‚æ•°å·²åœ¨TTSç”Ÿæˆæ—¶åº”ç”¨ â­ æœ€å¯èƒ½

**é—®é¢˜**ï¼š
```python
# åœ¨ _synthesize_gpt_sovits() æ–¹æ³•ä¸­
params = {
    'text': text,
    'speed_factor': role_speed_factor  # â† è¯­é€Ÿåœ¨TTSç”Ÿæˆæ—¶å°±åº”ç”¨äº†
}
```

**å½±å“**ï¼š
- TTSç”Ÿæˆçš„éŸ³é¢‘å·²ç»æ˜¯è°ƒæ•´è¿‡è¯­é€Ÿçš„
- å¦‚æœ `speed_factor` è®¾ç½®åˆç†ï¼ˆå¦‚1.0ï¼‰ï¼Œç”Ÿæˆçš„éŸ³é¢‘æ—¶é•¿å¯èƒ½å·²ç»æ¥è¿‘å­—å¹•æ—¶é•¿
- `TimelineAdjuster` è¯»å–çš„æ˜¯å·²è°ƒæ•´è¯­é€Ÿåçš„éŸ³é¢‘æ—¶é•¿
- å¦‚æœæ—¶é•¿å·®å¼‚ < 10msï¼Œä¼šè§¦å‘"ç®€å•è°ƒæ•´"ç­–ç•¥ï¼Œä¸åšä»»ä½•æ”¹å˜

**éªŒè¯æ–¹æ³•**ï¼š
æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œçœ‹æ˜¯å¦è¾“å‡ºï¼š
```
âœ… å·®å¼‚å¾ˆå°æˆ–ä¸éœ€è¦ä¿æŒæ€»æ—¶é•¿ï¼Œç›´æ¥æŒ‰å®é™…æ—¶é•¿æ’åˆ—
```

---

### åŸå› 2ï¼šæœªå¯ç”¨æ™ºèƒ½éŸ³é¢‘åŠ é€Ÿ

**é—®é¢˜**ï¼š
åªæœ‰åŒæ—¶å¯ç”¨"æ™ºèƒ½éŸ³é¢‘åŠ é€Ÿ"å’Œ"ä¿æŒæ€»æ—¶é•¿ä¸å˜"ï¼Œæ‰ä¼šä½¿ç”¨ `TimelineAdjuster`ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
æ£€æŸ¥æ˜¯å¦å‹¾é€‰äº†"å¯ç”¨æ™ºèƒ½éŸ³é¢‘åŠ é€Ÿï¼ˆæ¨èï¼‰"å¤é€‰æ¡†ã€‚

---

### åŸå› 3ï¼šæ—¶é•¿å·®å¼‚å¤ªå°

**é—®é¢˜**ï¼š
```python
if not self.preserve_total_time or abs(time_diff) < 10:
    print("âœ… å·®å¼‚å¾ˆå°æˆ–ä¸éœ€è¦ä¿æŒæ€»æ—¶é•¿ï¼Œç›´æ¥æŒ‰å®é™…æ—¶é•¿æ’åˆ—")
    return self._simple_timeline_adjustment(actual_durations)
```

å¦‚æœé…éŸ³æ€»æ—¶é•¿ä¸åŸå§‹SRTæ€»æ—¶é•¿å·®å¼‚ < 10msï¼Œä¼šè®¤ä¸º"å·®å¼‚å¾ˆå°"ï¼Œä¸åšè°ƒæ•´ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„"æ—¶é•¿å·®å¼‚"æ•°å€¼ã€‚

---

### åŸå› 4ï¼šé™éŸ³é—´éš™ä¸è¶³

**é—®é¢˜**ï¼š
å¦‚æœåŸå§‹SRTçš„é™éŸ³é—´éš™å¾ˆå°‘ï¼Œå³ä½¿é…éŸ³è¶…å‡ºï¼Œä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å‹ç¼©ã€‚

**éªŒè¯æ–¹æ³•**ï¼š
æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„"åŸå§‹é—´éš™æ€»æ—¶é•¿"ã€‚

---

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—

å¯åŠ¨é…éŸ³åï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œé‡ç‚¹å…³æ³¨ï¼š

```
â±ï¸  å¼€å§‹åŠ¨æ€è°ƒæ•´æ—¶é—´è½´
åŸå§‹æ€»æ—¶é•¿: XXXXms
  å­—å¹• 1: åŸæ—¶é•¿=XXXms, å®é™…é…éŸ³=XXXms, å·®å¼‚=Â±XXms
  å­—å¹• 2: åŸæ—¶é•¿=XXXms, å®é™…é…éŸ³=XXXms, å·®å¼‚=Â±XXms
  ...
æ€»é…éŸ³æ—¶é•¿: XXXXms
æ—¶é•¿å·®å¼‚: Â±XXXms
```

**å…³é”®ä¿¡æ¯**ï¼š
- å¦‚æœçœ‹åˆ°"å·®å¼‚å¾ˆå°æˆ–ä¸éœ€è¦ä¿æŒæ€»æ—¶é•¿"ï¼Œè¯´æ˜å·®å¼‚ < 10ms
- å¦‚æœçœ‹åˆ°"é…éŸ³è¶…å‡ºXXmsï¼Œéœ€è¦å‹ç¼©é™éŸ³é—´éš™"ï¼Œè¯´æ˜è¿›å…¥å‹ç¼©é€»è¾‘
- å¦‚æœçœ‹åˆ°"é…éŸ³çŸ­äºåŸå§‹XXmsï¼Œéœ€è¦æ‰©å±•é™éŸ³é—´éš™"ï¼Œè¯´æ˜è¿›å…¥æ‰©å±•é€»è¾‘

### æ­¥éª¤2ï¼šæ£€æŸ¥è¯­é€Ÿè®¾ç½®

æŸ¥çœ‹ç•Œé¢ä¸Šçš„"è¯­é€Ÿç³»æ•°"è®¾ç½®ï¼š
- å¦‚æœè®¾ç½®ä¸º 1.0ï¼ŒTTSç”Ÿæˆçš„éŸ³é¢‘æ—¶é•¿å¯èƒ½å·²ç»å¾ˆæ¥è¿‘å­—å¹•æ—¶é•¿
- å¦‚æœè®¾ç½®ä¸º 0.8ï¼ˆæ…¢é€Ÿï¼‰ï¼Œç”Ÿæˆçš„éŸ³é¢‘ä¼šæ›´é•¿
- å¦‚æœè®¾ç½®ä¸º 1.2ï¼ˆå¿«é€Ÿï¼‰ï¼Œç”Ÿæˆçš„éŸ³é¢‘ä¼šæ›´çŸ­

### æ­¥éª¤3ï¼šæ£€æŸ¥æ˜¯å¦å¯ç”¨æ™ºèƒ½åŠ é€Ÿ

ç¡®è®¤æ˜¯å¦å‹¾é€‰äº†ï¼š
- â˜‘ å¯ç”¨æ™ºèƒ½éŸ³é¢‘åŠ é€Ÿï¼ˆæ¨èï¼‰
- â˜‘ ä¿æŒSRTæ€»æ—¶é•¿ä¸å˜ï¼ˆæ¨èï¼‰

### æ­¥éª¤4ï¼šæ£€æŸ¥è¾“å‡ºæ–‡ä»¶

æŸ¥çœ‹è¾“å‡ºç›®å½•ä¸­çš„ `updated_subtitles.srt` æ–‡ä»¶ï¼š
- å¯¹æ¯”åŸå§‹SRTå’Œæ›´æ–°åçš„SRTçš„æ—¶é—´è½´
- æ£€æŸ¥æœ€åä¸€æ¡å­—å¹•çš„ç»“æŸæ—¶é—´æ˜¯å¦ç­‰äºåŸå§‹SRTæ€»æ—¶é•¿

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè°ƒæ•´æ—¶é•¿å·®å¼‚é˜ˆå€¼ï¼ˆæ¨èï¼‰

**é—®é¢˜**ï¼šå½“å‰é˜ˆå€¼ 10ms å¤ªå°ï¼Œå¯¼è‡´å¾ˆå¤šæƒ…å†µè¢«è®¤ä¸º"å·®å¼‚å¾ˆå°"ã€‚

**ä¿®æ”¹**ï¼š
```python
# timeline_adjuster.py ç¬¬ 77 è¡Œ
if not self.preserve_total_time or abs(time_diff) < 10:  # â† æ”¹ä¸ºæ›´å¤§çš„é˜ˆå€¼
```

**å»ºè®®æ”¹ä¸º**ï¼š
```python
if not self.preserve_total_time or abs(time_diff) < 100:  # 100ms = 0.1ç§’
```

---

### æ–¹æ¡ˆ2ï¼šå¢åŠ è°ƒè¯•æ—¥å¿—

**ç›®çš„**ï¼šè®©ç”¨æˆ·æ¸…æ¥šçœ‹åˆ°è°ƒæ•´è¿‡ç¨‹ã€‚

**ä¿®æ”¹**ï¼šåœ¨ `tts_dubbing_processor.py` çš„ `process()` æ–¹æ³•ä¸­å¢åŠ æ—¥å¿—ï¼š

```python
if self.preserve_total_time:
    print("â±ï¸  ä½¿ç”¨åŠ¨æ€æ—¶é—´è½´è°ƒæ•´ï¼ˆä¿æŒæ€»æ—¶é•¿ï¼‰")
    print(f"ğŸ“Š åŸå§‹SRTæ€»æ—¶é•¿: {subtitle_data[-1]['end_ms']}ms")
    
    # ä½¿ç”¨TimelineAdjusteråŠ¨æ€è°ƒæ•´æ—¶é—´è½´
    timeline_adjuster = TimelineAdjuster(...)
    updated_subtitles = timeline_adjuster.adjust_timeline()
    
    print(f"ğŸ“Š è°ƒæ•´åæ€»æ—¶é•¿: {updated_subtitles[-1]['end_ms']}ms")
    print(f"ğŸ“Š æ—¶é•¿å·®å¼‚: {updated_subtitles[-1]['end_ms'] - subtitle_data[-1]['end_ms']}ms")
```

---

### æ–¹æ¡ˆ3ï¼šåˆ†ç¦»è¯­é€Ÿè°ƒæ•´å’Œæ—¶é—´è½´è°ƒæ•´

**é—®é¢˜**ï¼šè¯­é€Ÿåœ¨TTSç”Ÿæˆæ—¶å°±åº”ç”¨äº†ï¼Œå¯¼è‡´æ—¶é—´è½´è°ƒæ•´æ•ˆæœä¸æ˜æ˜¾ã€‚

**å»ºè®®**ï¼š
1. TTSç”Ÿæˆæ—¶ä¸åº”ç”¨è¯­é€Ÿï¼ˆ`speed_factor=1.0`ï¼‰
2. ç”ŸæˆåŸå§‹é€Ÿåº¦çš„éŸ³é¢‘
3. åœ¨æ—¶é—´è½´è°ƒæ•´é˜¶æ®µå†åº”ç”¨è¯­é€Ÿå’Œæ—¶é•¿è°ƒæ•´

**ä¿®æ”¹**ï¼š
```python
# æ–¹æ¡ˆAï¼šåœ¨TTSç”Ÿæˆæ—¶å¿½ç•¥è¯­é€Ÿ
params = {
    'text': text,
    'speed_factor': 1.0,  # â† å›ºå®šä¸º1.0ï¼Œä¸åº”ç”¨è¯­é€Ÿ
}

# æ–¹æ¡ˆBï¼šåœ¨TimelineAdjusterä¸­è€ƒè™‘è¯­é€Ÿå› ç´ 
class TimelineAdjuster:
    def __init__(self, ..., speed_factor=1.0):
        self.speed_factor = speed_factor
    
    def adjust_timeline(self):
        # è®¡ç®—æ—¶è€ƒè™‘è¯­é€Ÿå› ç´ 
        actual_duration = self._get_audio_duration(audio_file)
        adjusted_duration = actual_duration / self.speed_factor
```

---

### æ–¹æ¡ˆ4ï¼šå¼ºåˆ¶è°ƒæ•´æ¨¡å¼

**ç›®çš„**ï¼šå³ä½¿å·®å¼‚å¾ˆå°ï¼Œä¹Ÿè¿›è¡Œè°ƒæ•´ã€‚

**ä¿®æ”¹**ï¼š
```python
# timeline_adjuster.py
if not self.preserve_total_time:
    return self._simple_timeline_adjustment(actual_durations)

# ç§»é™¤ abs(time_diff) < 10 çš„åˆ¤æ–­ï¼Œå¼ºåˆ¶è°ƒæ•´
if time_diff > 0:
    return self._compress_timeline(actual_durations, time_diff)
elif time_diff < 0:
    return self._expand_timeline(actual_durations, abs(time_diff))
else:
    return self._simple_timeline_adjustment(actual_durations)
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šæç«¯è¯­é€Ÿæµ‹è¯•

**è®¾ç½®**ï¼š
- è¯­é€Ÿç³»æ•°ï¼š0.5ï¼ˆææ…¢ï¼‰
- å¯ç”¨æ™ºèƒ½åŠ é€Ÿ
- å¯ç”¨ä¿æŒæ€»æ—¶é•¿

**é¢„æœŸ**ï¼š
- ç”Ÿæˆçš„éŸ³é¢‘ä¼šå¾ˆé•¿
- åº”è¯¥çœ‹åˆ°"é…éŸ³è¶…å‡ºXXmsï¼Œéœ€è¦å‹ç¼©é™éŸ³é—´éš™"
- æœ€ç»ˆéŸ³é¢‘æ€»æ—¶é•¿åº”ç­‰äºåŸå§‹SRT

### æµ‹è¯•2ï¼šæ— è¯­é€Ÿè°ƒæ•´æµ‹è¯•

**è®¾ç½®**ï¼š
- è¯­é€Ÿç³»æ•°ï¼š1.0ï¼ˆæ­£å¸¸ï¼‰
- å¯ç”¨æ™ºèƒ½åŠ é€Ÿ
- å¯ç”¨ä¿æŒæ€»æ—¶é•¿

**é¢„æœŸ**ï¼š
- å¦‚æœTTSç”Ÿæˆçš„éŸ³é¢‘æ—¶é•¿æ¥è¿‘å­—å¹•æ—¶é•¿ï¼Œå¯èƒ½çœ‹åˆ°"å·®å¼‚å¾ˆå°"
- éœ€è¦æŸ¥çœ‹å…·ä½“çš„æ—¶é•¿å·®å¼‚æ•°å€¼

### æµ‹è¯•3ï¼šæŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**æ“ä½œ**ï¼š
1. å¯åŠ¨é…éŸ³
2. å¤åˆ¶æ§åˆ¶å°æ‰€æœ‰æ—¥å¿—
3. æŸ¥æ‰¾å…³é”®ä¿¡æ¯ï¼š
   - "â±ï¸ å¼€å§‹åŠ¨æ€è°ƒæ•´æ—¶é—´è½´"
   - "æ—¶é•¿å·®å¼‚: Â±XXXms"
   - è°ƒæ•´ç­–ç•¥ï¼ˆç®€å•/å‹ç¼©/æ‰©å±•ï¼‰

---

## ğŸ“ ä¸´æ—¶è°ƒè¯•ä»£ç 

åœ¨ `timeline_adjuster.py` çš„ `adjust_timeline()` æ–¹æ³•å¼€å¤´æ·»åŠ ï¼š

```python
def adjust_timeline(self) -> List[Dict]:
    print("\n" + "ğŸ”"*30)
    print("ğŸ” DEBUG: TimelineAdjuster.adjust_timeline() è¢«è°ƒç”¨")
    print(f"ğŸ” preserve_total_time = {self.preserve_total_time}")
    print(f"ğŸ” å­—å¹•æ•°é‡ = {len(self.subtitles)}")
    print(f"ğŸ” éŸ³é¢‘æ–‡ä»¶æ•°é‡ = {len(self.audio_files)}")
    print("ğŸ”"*30 + "\n")
    
    # ... åŸæœ‰ä»£ç 
```

åœ¨ `tts_dubbing_processor.py` çš„ `process()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
if self.enable_smart_speedup:
    print("\n" + "ğŸš€"*30)
    print(f"ğŸš€ DEBUG: enable_smart_speedup = {self.enable_smart_speedup}")
    print(f"ğŸš€ DEBUG: preserve_total_time = {self.preserve_total_time}")
    print("ğŸš€"*30 + "\n")
    
    if self.preserve_total_time:
        print("â±ï¸  ä½¿ç”¨åŠ¨æ€æ—¶é—´è½´è°ƒæ•´ï¼ˆä¿æŒæ€»æ—¶é•¿ï¼‰")
        # ... åŸæœ‰ä»£ç 
```

---

## âœ… æ¨èç«‹å³æ‰§è¡Œçš„ä¿®æ”¹

### ä¿®æ”¹1ï¼šé™ä½å·®å¼‚é˜ˆå€¼åˆ¤æ–­çš„ä¼˜å…ˆçº§

```python
# timeline_adjuster.py ç¬¬ 75-79 è¡Œ
# ä¿®æ”¹å‰ï¼š
if not self.preserve_total_time or abs(time_diff) < 10:
    print("âœ… å·®å¼‚å¾ˆå°æˆ–ä¸éœ€è¦ä¿æŒæ€»æ—¶é•¿ï¼Œç›´æ¥æŒ‰å®é™…æ—¶é•¿æ’åˆ—")
    return self._simple_timeline_adjustment(actual_durations)

# ä¿®æ”¹åï¼š
if not self.preserve_total_time:
    print("âš ï¸ æœªå¯ç”¨ä¿æŒæ€»æ—¶é•¿ï¼Œç›´æ¥æŒ‰å®é™…æ—¶é•¿æ’åˆ—")
    return self._simple_timeline_adjustment(actual_durations)

if abs(time_diff) < 100:  # æé«˜é˜ˆå€¼åˆ°100ms
    print(f"âœ… å·®å¼‚å¾ˆå°({time_diff}ms < 100ms)ï¼Œç›´æ¥æŒ‰å®é™…æ—¶é•¿æ’åˆ—")
    return self._simple_timeline_adjustment(actual_durations)
```

### ä¿®æ”¹2ï¼šå¢åŠ è¯¦ç»†æ—¥å¿—

```python
# tts_dubbing_processor.py process() æ–¹æ³•ä¸­
if self.preserve_total_time:
    print("â±ï¸  ä½¿ç”¨åŠ¨æ€æ—¶é—´è½´è°ƒæ•´ï¼ˆä¿æŒæ€»æ—¶é•¿ï¼‰")
    print(f"ğŸ“Š åŸå§‹SRTæ€»æ—¶é•¿: {subtitle_data[-1]['end_ms']}ms")
    print(f"ğŸ“Š é…éŸ³æ–‡ä»¶æ•°é‡: {len(audio_files)}")
    
    # ä½¿ç”¨TimelineAdjusteråŠ¨æ€è°ƒæ•´æ—¶é—´è½´
    timeline_adjuster = TimelineAdjuster(...)
    updated_subtitles = timeline_adjuster.adjust_timeline()
    
    if updated_subtitles:
        final_time = updated_subtitles[-1]['end_ms']
        original_time = subtitle_data[-1]['end_ms']
        print(f"ğŸ“Š è°ƒæ•´åæ€»æ—¶é•¿: {final_time}ms")
        print(f"ğŸ“Š ä¸åŸå§‹å·®å¼‚: {final_time - original_time:+d}ms")
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œè¿è¡Œä¸€æ¬¡é…éŸ³ï¼ŒæŸ¥çœ‹è¯¦ç»†è¾“å‡º
2. **æ ¹æ®æ—¥å¿—åˆ¤æ–­**ï¼šç¡®å®šæ˜¯å“ªä¸ªåŸå› å¯¼è‡´çš„
3. **åº”ç”¨å¯¹åº”æ–¹æ¡ˆ**ï¼šæ ¹æ®åŸå› é€‰æ‹©åˆé€‚çš„è§£å†³æ–¹æ¡ˆ
4. **éªŒè¯æ•ˆæœ**ï¼šå†æ¬¡æµ‹è¯•ï¼Œç¡®è®¤é—®é¢˜è§£å†³

---

**åˆ›å»ºæ—¶é—´**: 2025-12-15  
**çŠ¶æ€**: å¾…éªŒè¯
