# 测试清单 - 动态时间轴调整功能

## ✅ 功能测试清单

### 1. 基础功能测试

#### 1.1 界面显示测试
- [ ] 单角色配音界面显示"保持SRT总时长不变"复选框
- [ ] 多角色配音界面显示"保持SRT总时长不变"复选框
- [ ] 复选框默认勾选状态为 `true`
- [ ] 只有启用"智能音频加速"后才显示该选项
- [ ] 复选框文字和图标显示正确

#### 1.2 参数传递测试
- [ ] 前端正确发送 `preserve_total_time` 参数到后端
- [ ] 后端 `/api/tts-dubbing/start` 接口正确接收参数
- [ ] 后端 `/api/tts-dubbing/multi-role` 接口正确接收参数
- [ ] 参数正确传递到 `TTSDubbingProcessor`
- [ ] 参数正确传递到 `MultiRoleDubbingProcessor`

---

### 2. 核心功能测试

#### 2.1 简单调整测试（差异 < 10ms）
**测试数据**：
```
原始SRT: 字幕1(0-2000ms), 字幕2(2500-5000ms)
配音时长: 音频1(2005ms), 音频2(2495ms)
```

**预期结果**：
- [ ] 使用简单调整策略
- [ ] 直接按实际时长排列
- [ ] 保留原始间隙比例
- [ ] 控制台输出"差异很小或不需要保持总时长"

#### 2.2 压缩时间轴测试（配音超出）
**测试数据**：
```
原始SRT: 总时长10秒
配音总时长: 12秒（超出2秒）
```

**预期结果**：
- [ ] 使用压缩时间轴策略
- [ ] 按比例压缩静音间隙
- [ ] 最终音频总时长 = 10秒
- [ ] 控制台输出"配音超出XXms，需要压缩静音间隙"
- [ ] 生成 `updated_subtitles.srt` 文件
- [ ] 字幕时间轴正确调整

#### 2.3 扩展时间轴测试（配音短于）
**测试数据**：
```
原始SRT: 总时长10秒
配音总时长: 8秒（短2秒）
```

**预期结果**：
- [ ] 使用扩展时间轴策略
- [ ] 按比例扩展静音间隙
- [ ] 最终音频总时长 = 10秒
- [ ] 控制台输出"配音短于原始XXms，需要扩展静音间隙"
- [ ] 生成 `updated_subtitles.srt` 文件
- [ ] 字幕时间轴正确调整

---

### 3. 边界情况测试

#### 3.1 极端压缩测试
**测试数据**：
```
原始SRT: 总时长5秒，静音间隙总计1秒
配音总时长: 8秒（超出3秒）
```

**预期结果**：
- [ ] 移除所有静音间隙
- [ ] 字幕紧密排列
- [ ] 控制台输出"间隙不足，移除所有间隙"
- [ ] 最终音频总时长尽可能接近原始时长

#### 3.2 无间隙SRT测试
**测试数据**：
```
原始SRT: 字幕连续无间隙
配音总时长: 超出原始时长
```

**预期结果**：
- [ ] 正确处理无间隙情况
- [ ] 字幕紧密排列
- [ ] 不会出现错误或崩溃

#### 3.3 单条字幕测试
**测试数据**：
```
原始SRT: 只有1条字幕
```

**预期结果**：
- [ ] 正确处理单条字幕
- [ ] 不会出现数组越界错误
- [ ] 正确生成音频和字幕

---

### 4. 多角色配音测试

#### 4.1 多角色时间轴调整
**测试数据**：
```
原始SRT: 3个角色，总时长15秒
配音总时长: 17秒（超出2秒）
```

**预期结果**：
- [ ] 每个角色的配音正确生成
- [ ] 时间轴统一调整
- [ ] 最终音频总时长 = 15秒
- [ ] 角色切换处时间轴正确

#### 4.2 角色语速差异测试
**测试数据**：
```
角色A: 语速快，配音短于字幕
角色B: 语速慢，配音长于字幕
```

**预期结果**：
- [ ] 正确处理不同角色的时长差异
- [ ] 统一调整时间轴
- [ ] 最终总时长保持不变

---

### 5. 兼容性测试

#### 5.1 禁用保持总时长测试
**测试步骤**：
1. 取消勾选"保持SRT总时长不变"
2. 启动配音

**预期结果**：
- [ ] 使用传统 `SpeedRateAdjuster`
- [ ] 不调整时间轴
- [ ] 控制台输出"使用传统双重变速机制"

#### 5.2 禁用智能加速测试
**测试步骤**：
1. 取消勾选"启用智能音频加速"
2. 启动配音

**预期结果**：
- [ ] 不显示"保持总时长"选项
- [ ] 使用传统拼接方式
- [ ] 控制台输出"使用传统方式拼接音频"

---

### 6. 输出文件测试

#### 6.1 音频文件测试
- [ ] 生成 `dubbing_result.wav` 文件
- [ ] 音频文件可以正常播放
- [ ] 音频时长与原始SRT一致（误差 < 100ms）
- [ ] 音质正常，无明显失真

#### 6.2 字幕文件测试
- [ ] 生成 `updated_subtitles.srt` 文件
- [ ] 字幕文件格式正确
- [ ] 字幕时间轴已调整
- [ ] 字幕文本内容完整
- [ ] 最后一条字幕的结束时间 = 原始SRT总时长

---

### 7. 日志输出测试

#### 7.1 控制台日志
- [ ] 输出"⏱️ 开始动态调整时间轴"
- [ ] 输出每条字幕的原时长和实际配音时长
- [ ] 输出总配音时长和时长差异
- [ ] 输出调整策略（简单/压缩/扩展）
- [ ] 输出每条字幕调整后的时间轴
- [ ] 输出最终总时长验证

#### 7.2 错误处理
- [ ] 音频文件不存在时正确处理
- [ ] 音频时长获取失败时正确处理
- [ ] 不会因为异常而中断整个流程

---

### 8. 性能测试

#### 8.1 处理时间测试
**测试数据**：
```
SRT文件: 100条字幕
```

**预期结果**：
- [ ] 时间轴调整耗时 < 1秒
- [ ] 总处理时间增加 < 10%
- [ ] 不会明显影响用户体验

#### 8.2 内存占用测试
**测试数据**：
```
SRT文件: 500条字幕
```

**预期结果**：
- [ ] 内存占用无明显增加
- [ ] 不会出现内存泄漏
- [ ] 临时文件正确清理

---

### 9. 用户体验测试

#### 9.1 界面交互测试
- [ ] 复选框点击响应流畅
- [ ] 参数变化实时反映
- [ ] 配音过程中进度正常显示
- [ ] 完成后结果正确显示

#### 9.2 错误提示测试
- [ ] 配音失败时显示清晰的错误信息
- [ ] 参数错误时给出合理提示
- [ ] 不会出现未捕获的异常

---

### 10. 回归测试

#### 10.1 原有功能测试
- [ ] 不启用智能加速时，原有功能正常
- [ ] 单角色配音功能正常
- [ ] 多角色配音功能正常
- [ ] 其他TTS功能不受影响

#### 10.2 兼容性测试
- [ ] 与现有代码无冲突
- [ ] 不影响其他模块功能
- [ ] 向后兼容

---

## 📊 测试结果记录

### 测试环境
- **操作系统**: Windows / Linux / macOS
- **Python版本**: 3.x
- **浏览器**: Chrome / Firefox / Edge
- **测试日期**: YYYY-MM-DD

### 测试结果汇总

| 测试类别 | 测试项数 | 通过数 | 失败数 | 通过率 |
|---------|---------|--------|--------|--------|
| 基础功能 | 10 | - | - | - |
| 核心功能 | 12 | - | - | - |
| 边界情况 | 9 | - | - | - |
| 多角色配音 | 6 | - | - | - |
| 兼容性 | 6 | - | - | - |
| 输出文件 | 10 | - | - | - |
| 日志输出 | 8 | - | - | - |
| 性能测试 | 6 | - | - | - |
| 用户体验 | 6 | - | - | - |
| 回归测试 | 6 | - | - | - |
| **总计** | **79** | **-** | **-** | **-%** |

---

## 🐛 已知问题

### 问题1
- **描述**: 
- **重现步骤**: 
- **预期结果**: 
- **实际结果**: 
- **严重程度**: 高/中/低
- **状态**: 待修复/已修复

---

## 📝 测试建议

1. **优先测试核心功能**：先测试压缩和扩展时间轴的基本功能
2. **使用真实数据**：使用实际的SRT文件和TTS配音进行测试
3. **检查日志输出**：仔细查看控制台日志，确认调整逻辑正确
4. **验证输出文件**：播放生成的音频，检查字幕文件的时间轴
5. **测试边界情况**：特别注意极端情况的处理

---

## ✅ 测试完成标准

- [ ] 所有测试项通过率 ≥ 95%
- [ ] 无严重级别的bug
- [ ] 性能测试达标
- [ ] 用户体验良好
- [ ] 文档完整准确

---

**测试人员**: ___________  
**测试日期**: ___________  
**审核人员**: ___________  
**审核日期**: ___________
