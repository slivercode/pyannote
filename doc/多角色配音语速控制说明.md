# 多角色配音语速控制说明

## 🎭 问题描述

在多角色配音场景中，每个角色的语速需要独立控制。之前的实现使用全局的 `speed_factor`，导致所有角色使用相同的语速，无法满足不同角色的个性化需求。

## ✅ 解决方案

现已更新 `TTSDubbingProcessor`，支持为每个角色单独设置语速系数。系统会自动识别字幕中的说话人标记，并应用对应角色的语速配置。

## 📝 字幕格式要求

### 支持的说话人标记格式

#### 格式1: 方括号格式（推荐）
```srt
1
00:00:00,000 --> 00:00:02,500
[SPEAKER_00] 你好，我是第一个角色。

2
00:00:02,500 --> 00:00:05,000
[SPEAKER_01] 你好，我是第二个角色。
```

#### 格式2: 冒号格式
```srt
1
00:00:00,000 --> 00:00:02,500
SPEAKER_00: 你好，我是第一个角色。

2
00:00:02,500 --> 00:00:05,000
SPEAKER_01: 你好，我是第二个角色。
```

### 说话人标识规则

- 格式: `SPEAKER_XX`（XX为两位数字，如00, 01, 02...）
- 系统会自动提取说话人标识并去除标记，只保留实际文本
- 如果字幕没有说话人标记，将使用默认配置

## 🔧 配置方法

### 方式1: 多角色配置（推荐）

为每个角色单独配置参考音频和语速：

```python
from scripts.tts_dubbing_processor import TTSDubbingProcessor

# 定义多角色配置
role_data = {
    'SPEAKER_00': {
        'refAudioPath': 'references/speaker_00.wav',
        'promptText': '这是第一个角色的参考文本',
        'promptLang': 'zh',
        'speed_factor': 1.0,  # 正常语速
        'text_lang': 'zh'
    },
    'SPEAKER_01': {
        'refAudioPath': 'references/speaker_01.wav',
        'promptText': '这是第二个角色的参考文本',
        'promptLang': 'zh',
        'speed_factor': 0.8,  # 慢速（80%）
        'text_lang': 'zh'
    },
    'SPEAKER_02': {
        'refAudioPath': 'references/speaker_02.wav',
        'promptText': '这是第三个角色的参考文本',
        'promptLang': 'zh',
        'speed_factor': 1.2,  # 快速（120%）
        'text_lang': 'zh'
    },
    'default': {
        # 默认配置（用于未识别的说话人）
        'refAudioPath': 'references/default.wav',
        'promptText': '默认参考文本',
        'promptLang': 'zh',
        'speed_factor': 1.0,
        'text_lang': 'zh'
    }
}

# 创建处理器
processor = TTSDubbingProcessor(
    srt_path="input_with_speakers.srt",
    output_dir="output",
    engine="gpt-sovits",
    role_data=role_data,  # 传入多角色配置
    api_url="http://localhost:9880",
    speed_factor=1.0,  # 全局默认语速（当角色配置中没有指定时使用）
)

# 执行配音
result = processor.process()
```

### 方式2: 单角色配置（兼容旧版）

如果只有一个角色，可以使用简化配置：

```python
role_data = {
    'refAudioPath': 'reference.wav',
    'promptText': '参考文本',
    'promptLang': 'zh',
    'speed_factor': 1.0  # 可选，不指定则使用全局speed_factor
}

processor = TTSDubbingProcessor(
    srt_path="input.srt",
    output_dir="output",
    engine="gpt-sovits",
    role_data=role_data,
    api_url="http://localhost:9880",
    speed_factor=1.0,  # 全局语速
)
```

## 🎯 语速系数说明

### 语速系数范围

- **0.5** - 50%速度（非常慢）
- **0.8** - 80%速度（较慢）
- **1.0** - 100%速度（正常）
- **1.2** - 120%速度（较快）
- **1.5** - 150%速度（快速）
- **2.0** - 200%速度（非常快）

### 推荐设置

| 角色类型 | 推荐语速 | 说明 |
|---------|---------|------|
| 老年角色 | 0.7-0.9 | 语速较慢，更符合角色特征 |
| 成年角色 | 0.9-1.1 | 正常语速 |
| 青少年角色 | 1.0-1.2 | 语速稍快，更有活力 |
| 儿童角色 | 1.1-1.3 | 语速较快，活泼 |
| 旁白/解说 | 0.9-1.0 | 清晰稳定 |
| 激动/紧张 | 1.2-1.5 | 快速表达情绪 |

## 📊 处理流程

```
1. 解析SRT文件
   ├─ 提取时间轴
   ├─ 识别说话人标记 [SPEAKER_XX]
   └─ 清理文本（去除标记）

2. 为每条字幕合成语音
   ├─ 根据说话人查找对应配置
   ├─ 获取该角色的语速系数
   ├─ 调用TTS API生成音频
   └─ 保存音频文件

3. 拼接音频（可选启用双重变速）
   ├─ 按时间轴对齐
   ├─ 添加静音间隙
   └─ 导出最终音频
```

## 🔍 日志输出示例

启用多角色配音后，控制台会输出详细信息：

```
📖 开始解析SRT文件: input_with_speakers.srt
✅ 解析字幕 1 [SPEAKER_00]: 你好，我是第一个角色。
✅ 解析字幕 2 [SPEAKER_01]: 你好，我是第二个角色。
✅ 解析字幕 3 [SPEAKER_00]: 我的语速是正常的。

📝 处理字幕 1/3: 你好，我是第一个角色。
🎭 使用角色配置: SPEAKER_00
🔄 调用GPT-SoVITS API [SPEAKER_00, 语速=1.0]: 你好，我是第一个角色。
✅ 语音合成成功: audio_0001.wav

📝 处理字幕 2/3: 你好，我是第二个角色。
🎭 使用角色配置: SPEAKER_01
🔄 调用GPT-SoVITS API [SPEAKER_01, 语速=0.8]: 你好，我是第二个角色。
✅ 语音合成成功: audio_0002.wav

📝 处理字幕 3/3: 我的语速是正常的。
🎭 使用角色配置: SPEAKER_00
🔄 调用GPT-SoVITS API [SPEAKER_00, 语速=1.0]: 我的语速是正常的。
✅ 语音合成成功: audio_0003.wav
```

## 🛠️ 完整示例

### 示例1: 三角色对话配音

```python
from scripts.tts_dubbing_processor import TTSDubbingProcessor

# 准备SRT文件（带说话人标记）
srt_content = """1
00:00:00,000 --> 00:00:02,500
[SPEAKER_00] 大家好，欢迎来到今天的节目。

2
00:00:02,500 --> 00:00:05,000
[SPEAKER_01] 你好主持人，很高兴参加这个节目。

3
00:00:05,000 --> 00:00:07,500
[SPEAKER_02] 我也很期待今天的讨论。

4
00:00:07,500 --> 00:00:10,000
[SPEAKER_00] 那我们开始吧。
"""

# 保存SRT文件
with open('dialogue.srt', 'w', encoding='utf-8') as f:
    f.write(srt_content)

# 配置三个角色
role_data = {
    'SPEAKER_00': {  # 主持人 - 正常语速
        'refAudioPath': 'd:/audio/host.wav',
        'promptText': '欢迎收听',
        'promptLang': 'zh',
        'speed_factor': 1.0,
    },
    'SPEAKER_01': {  # 嘉宾1 - 稍慢
        'refAudioPath': 'd:/audio/guest1.wav',
        'promptText': '很高兴来到这里',
        'promptLang': 'zh',
        'speed_factor': 0.9,
    },
    'SPEAKER_02': {  # 嘉宾2 - 稍快
        'refAudioPath': 'd:/audio/guest2.wav',
        'promptText': '大家好',
        'promptLang': 'zh',
        'speed_factor': 1.1,
    }
}

# 创建处理器
processor = TTSDubbingProcessor(
    srt_path='dialogue.srt',
    output_dir='output',
    engine='gpt-sovits',
    role_data=role_data,
    api_url='http://localhost:9880',
    auto_align=True,
)

# 执行配音
result = processor.process()
print(f"配音完成: {result}")
```

### 示例2: 结合双重变速机制

```python
# 启用智能双重变速 + 多角色语速控制
processor = TTSDubbingProcessor(
    srt_path='dialogue.srt',
    output_dir='output',
    engine='gpt-sovits',
    role_data=role_data,
    api_url='http://localhost:9880',
    
    # 启用双重变速机制
    enable_smart_speedup=True,
    enable_audio_speedup=True,
    max_audio_speed_rate=1.5,  # 限制最大加速倍率
    
    auto_align=True,
)

result = processor.process()
```

## ⚠️ 注意事项

### 1. 配置优先级

语速系数的优先级（从高到低）：
1. 角色配置中的 `speed_factor`
2. 全局 `speed_factor` 参数
3. 默认值 1.0

### 2. 说话人标识匹配

- 说话人标识必须完全匹配（区分大小写）
- 推荐使用 `SPEAKER_00`, `SPEAKER_01` 等标准格式
- 如果找不到对应配置，会使用 `default` 配置或全局配置

### 3. 双重变速机制

- 角色的 `speed_factor` 是TTS合成时的语速
- 双重变速机制是后期对已合成音频的调整
- 两者可以同时使用，效果会叠加

### 4. 性能考虑

- 多角色配音需要为每个角色准备参考音频
- 不同角色的音频合成时间可能不同
- 建议使用进度回调监控处理进度

## 🎉 总结

更新后的系统支持：

✅ **自动识别说话人** - 从SRT字幕中提取说话人标记  
✅ **独立语速控制** - 每个角色可设置不同的语速系数  
✅ **灵活配置** - 支持单角色和多角色两种模式  
✅ **兼容旧版** - 完全向后兼容原有的单角色配置  
✅ **详细日志** - 输出每个角色的语速信息  
✅ **智能降级** - 未找到配置时自动使用默认值  

现在你可以为每个角色设置合适的语速，让配音更加自然和个性化！

---

**更新日期**: 2024-12-12  
**版本**: v1.1.0
