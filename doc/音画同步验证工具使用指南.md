# 音画同步验证工具使用指南

## 📋 概述

本项目提供了两个诊断工具来帮助你检查和解决TTS配音后的音画同步问题：

1. **diagnose_tts_timeline.py** - 诊断TTS生成的字幕和音频时间轴
2. **verify_sync.py** - 综合验证音频、视频、字幕的同步情况

## 🔧 工具1：TTS时间轴诊断工具

### 功能
- 解析SRT字幕文件，分析时间轴结构
- 对比字幕时间轴与音频实际时长
- 检测间隙过大、字幕重叠等问题
- 提供针对性的修复建议

### 使用方法

#### 基本用法（仅检查字幕）
```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt
```

#### 完整用法（检查字幕+音频）
```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

### 输出示例

```
🔍 TTS配音时间轴诊断
============================================================

📝 解析字幕文件: output/updated_subtitles.srt
✅ 找到 15 条字幕

📊 字幕时间轴分析:
------------------------------------------------------------
字幕总数: 15
字幕总时长: 85.50秒 (85500ms)
时间轴总长: 120.30秒 (120300ms)
间隙总时长: 34.80秒 (34800ms)

🎵 检查音频文件: output/dubbing_result.wav
------------------------------------------------------------
音频时长: 120.25秒 (120250ms)

⚖️ 音频 vs 字幕时间轴:
  音频时长: 120.25秒
  字幕时间轴: 120.30秒
  差异: +0.05秒 (50ms)
  ✅ 差异很小，基本匹配

🔍 问题诊断:
------------------------------------------------------------
发现以下问题:
  ⚠️ 间隙过大 (34.80秒)，占总时长的 28.9%

💡 建议:
------------------------------------------------------------
1. 字幕时间轴与音频基本匹配
2. 如果字幕和画面不同步:
   - 检查视频是否被慢放
   - 如果视频被慢放，字幕时间轴也需要相应调整
   - 使用视频合并模块会自动调整字幕时间轴
```

### 常见问题诊断

#### 问题1：间隙过大
```
⚠️ 间隙过大 (34.80秒)，占总时长的 28.9%
```
**原因**：TTS生成时添加了过多静音间隙  
**解决**：
- 启用"移除静音间隙"功能
- 减小"静音间隔时长"（建议0.3-0.5秒）

#### 问题2：音频比字幕长
```
⚠️ 音频比字幕长 5.50秒
   可能原因：字幕时间轴被压缩了
```
**原因**：启用了"保持SRT总时长"，字幕被压缩  
**解决**：关闭"保持SRT总时长"功能

#### 问题3：字幕重叠
```
⚠️ 字幕 5 和 6 存在重叠
```
**原因**：时间轴计算错误  
**解决**：重新生成TTS配音

## 🔧 工具2：综合同步验证工具

### 功能
- 同时检查视频、音频、字幕的时长
- 对比三者之间的差异
- 抽样检查关键时间点的字幕内容
- 提供针对性的修复建议

### 使用方法

#### 检查音频和字幕（TTS生成后）
```bash
python verify_sync.py --audio output/dubbing_result.wav --subtitle output/updated_subtitles.srt
```

#### 检查视频、音频和字幕（视频合并后）
```bash
python verify_sync.py --video output/final_video.mp4 --audio output/dubbing_result.wav --subtitle output/updated_subtitles.srt
```

#### 仅检查视频和字幕
```bash
python verify_sync.py --video output/final_video.mp4 --subtitle output/updated_subtitles.srt
```

### 输出示例

```
🔍 综合同步验证
============================================================

📁 文件检查:
   ✅ 视频: output/final_video.mp4
   ✅ 音频: output/dubbing_result.wav
   ✅ 字幕: output/updated_subtitles.srt

📊 时长对比:
------------------------------------------------------------
   视频: 169.50秒
   音频: 120.25秒
   字幕: 120.30秒

⚖️ 差异分析:
------------------------------------------------------------
   最长: 169.50秒
   最短: 120.25秒
   差异: 49.25秒
   ⚠️ 时长差异过大，可能导致不同步

   视频 vs 音频: 49.25秒差异
      ⚠️ 视频比音频长，可能需要裁剪视频

   音频 vs 字幕: 0.05秒差异

   视频 vs 字幕: 49.20秒差异
      ⚠️ 视频比字幕长

🎯 关键时间点检查:
------------------------------------------------------------
     0秒: 大家好，欢迎来到今天的教程...
    10秒: 首先我们来看第一个步骤...
    30秒: 接下来是第二个重要的部分...
    60秒: 现在让我们进入第三个环节...

💡 建议:
------------------------------------------------------------
   视频和音频时长不匹配
     → 检查音频是否完整生成
   视频和字幕时长不匹配
     → 视频被慢放后，字幕时间轴也需要相应调整
     → 使用视频合并功能会自动调整字幕时间轴

🔧 进一步诊断:
------------------------------------------------------------
   运行以下命令进行详细诊断:
   python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

## 📊 诊断流程

### 步骤1：TTS生成后立即诊断

```bash
# 生成TTS配音后
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

**检查项**：
- ✅ 字幕和音频时长是否匹配（差异 < 1秒）
- ✅ 间隙是否合理（< 总时长的20%）
- ✅ 无字幕重叠

**如果不匹配**：
1. 调整TTS设置（关闭"保持SRT总时长"，启用"移除静音间隙"）
2. 重新生成TTS配音
3. 再次诊断

### 步骤2：视频合并前验证

```bash
# 合并视频前
python verify_sync.py --video input/original_video.mp4 --audio output/dubbing_result.wav --subtitle output/updated_subtitles.srt
```

**检查项**：
- 📹 原视频时长
- 🎵 TTS音频时长
- 📝 字幕时间轴长度
- ⚖️ 三者差异

**预期结果**：
- 音频和字幕应该匹配（差异 < 1秒）
- 如果音频比视频长，系统会自动慢放视频

### 步骤3：视频合并后验证

```bash
# 合并视频后
python verify_sync.py --video output/final_video.mp4 --subtitle output/final_subtitles.srt
```

**检查项**：
- ✅ 最终视频和字幕时长是否匹配
- ✅ 关键时间点的字幕内容是否正确

## 🎯 常见场景诊断

### 场景1：跨语言配音（中文→日语）

**问题**：日语配音比中文长很多，导致大量静音间隙

**诊断**：
```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

**预期输出**：
```
⚠️ 间隙过大 (45.00秒)，占总时长的 35%
```

**解决方案**：
1. 关闭"保持SRT总时长"
2. 启用"移除静音间隙"
3. 重新生成配音

**验证**：
```bash
# 重新生成后再次诊断
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav

# 应该看到：
✅ 差异很小，基本匹配
间隙总时长: 7.50秒 (合理范围)
```

### 场景2：视频慢放后字幕不同步

**问题**：视频被慢放以匹配音频，但字幕时间轴未调整

**诊断**：
```bash
python verify_sync.py --video output/final_video.mp4 --subtitle output/final_subtitles.srt
```

**预期输出**：
```
视频 vs 字幕: 49.20秒差异
   ⚠️ 字幕比视频长，字幕时间轴可能未调整
```

**解决方案**：
1. 确保使用最新版本的 `video_merger.py`
2. 重新合并视频（系统会自动调整字幕时间轴）
3. 检查日志中是否有"调整字幕时间轴"的输出

**验证**：
```bash
# 重新合并后再次验证
python verify_sync.py --video output/final_video.mp4 --subtitle output/final_subtitles.srt

# 应该看到：
✅ 时长差异可接受
视频 vs 字幕: 0.15秒差异
```

### 场景3：前面同步，后面越来越不同步

**问题**：累积误差导致后面的字幕越来越不同步

**诊断**：
```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

**检查**：
- 查看每条字幕的时长是否异常
- 查看间隙分布是否均匀

**解决方案**：
1. 检查TTS生成的每段音频实际时长
2. 确保音频拼接时时长计算准确
3. 使用最新版本的代码（已添加时长验证）

## 🛠️ 代码改进

### 改进1：TTS时间轴验证

在 `src/scripts/tts_dubbing_processor.py` 中，`_save_updated_srt()` 方法现在会：
- ✅ 验证字幕总时长
- ✅ 检测间隙过大
- ✅ 检测字幕重叠
- ✅ 输出详细的验证信息

### 改进2：音频拼接验证

在 `src/scripts/tts_dubbing_processor.py` 中，`_merge_audio_with_timeline()` 方法现在会：
- ✅ 记录每段音频的实际时长
- ✅ 对比预期时长和实际时长
- ✅ 统计总的配音时长和间隙时长
- ✅ 验证最终音频时长

### 改进3：字幕时间轴调整验证

在 `src/scripts/video_merger.py` 中，`_adjust_subtitle_timeline()` 方法现在会：
- ✅ 记录调整前后的时间戳
- ✅ 验证实际拉伸比例
- ✅ 输出详细的调整信息

## 📝 最佳实践

### 1. TTS生成阶段

**推荐设置**（跨语言配音）：
```json
{
  "preserveTotalTime": false,  // 关闭
  "removeSilentGaps": true,    // 启用
  "silenceDuration": 0.5       // 0.5秒
}
```

**生成后立即诊断**：
```bash
python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
```

### 2. 视频合并阶段

**合并前验证**：
```bash
python verify_sync.py --video input/original_video.mp4 --audio output/dubbing_result.wav --subtitle output/updated_subtitles.srt
```

**合并后验证**：
```bash
python verify_sync.py --video output/final_video.mp4 --subtitle output/final_subtitles.srt
```

### 3. 问题排查

如果发现不同步：

1. **先诊断TTS阶段**
   ```bash
   python diagnose_tts_timeline.py output/updated_subtitles.srt --audio output/dubbing_result.wav
   ```

2. **如果TTS阶段正常，再检查视频合并**
   ```bash
   python verify_sync.py --video output/final_video.mp4 --audio output/dubbing_result.wav --subtitle output/final_subtitles.srt
   ```

3. **根据诊断结果调整设置**

## 🎯 预期效果

使用这些工具后，你应该能够：
- ✅ 快速定位音画不同步的原因
- ✅ 验证TTS生成的字幕和音频是否匹配
- ✅ 确认视频合并后的同步情况
- ✅ 获得针对性的修复建议

---

**更新日期**: 2024-12-18  
**版本**: v1.6.0
