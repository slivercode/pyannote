# 更新日志 - 字幕自动调整功能

## [2024-12-18] 新增功能：字幕自动调整

### 功能描述

在TTS配音模块中新增"字幕自动调整"功能。当启用"移除静音间隙"选项时，系统会自动根据实际生成的音频时长，按比例拉伸字幕时间轴，并导出调整后的字幕文件。

### 使用场景

**跨语言配音**（如中文字幕配日语音频）：
- 原始视频：85秒，中文字幕
- 日语配音：170秒（日语表达更长）
- 系统自动：拉伸字幕时间轴到170秒

### 如何使用

1. 进入"TTS配音"模块
2. 上传SRT字幕文件
3. **勾选"移除静音间隙（推荐）"**
4. 点击"开始配音"
5. 获得输出：
   - `dubbing_result.wav` - 配音音频
   - `adjusted_subtitles.srt` - 调整后的字幕

### 技术实现

- **算法**：按比例拉伸（stretch_ratio = audio_duration / subtitle_duration）
- **触发条件**：音频比字幕长10%以上
- **输出文件**：`adjusted_subtitles.srt`

### 修改的文件

- `src/scripts/tts_dubbing_processor.py`
  - 新增 `_adjust_subtitle_timeline_for_audio()` 方法
  - 修改 `process()` 方法中的传统拼接逻辑
  
- `src/scripts/tts_multi_role_dubbing.py`
  - 修改 `process()` 方法中的传统拼接逻辑

### 新增文件

- `test_subtitle_auto_adjust.py` - 功能测试脚本
- `doc/字幕自动调整功能说明.md` - 详细功能说明
- `doc/跨语言配音完整流程.md` - 完整使用指南
- `doc/字幕自动调整功能-实现总结.md` - 实现总结

### 测试结果

✅ 场景1：拉伸2倍（10秒→20秒）- 通过
✅ 场景2：差异<10%（10秒→10.5秒）- 正确跳过
✅ 场景3：日语配音（10秒→17秒）- 通过

### 相关功能

配合使用以下功能可获得最佳效果：

1. **TTS配音**：移除静音间隙 + 字幕自动调整
2. **视频合并**：自动慢放视频以匹配音频
3. **字幕烧录**：使用调整后的字幕

### 完整流程

```
中文字幕(85秒)
    ↓
[TTS配音 + 移除静音间隙]
    ↓
日语音频(170秒) + 调整后字幕(170秒)
    ↓
[视频合并 + 自动慢放]
    ↓
最终视频(170秒，完美同步)
```

### 推荐设置

**跨语言配音**：
- ✅ 移除静音间隙
- ❌ 保持SRT总时长不变
- TTS生成语速：1.0x

**同语言配音**：
- ❌ 移除静音间隙
- ✅ 保持SRT总时长不变
- TTS生成语速：根据需要调整

### 已知限制

1. 假设语速差异是均匀的
2. 不能针对单个片段精确调整
3. 需要原始SRT文件时间轴准确

### 未来计划

- **方案B**：基于音频片段的精确对齐
  - 记录每个片段的实际时长
  - 逐条精确调整字幕时间轴
  - 适合语速差异不均匀的场景

---

## 相关文档

- [字幕自动调整功能说明](doc/字幕自动调整功能说明.md)
- [跨语言配音完整流程](doc/跨语言配音完整流程.md)
- [字幕自动调整功能-实现总结](doc/字幕自动调整功能-实现总结.md)
