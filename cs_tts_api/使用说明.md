# GPT-SoVITS API 调用说明

## 🔍 根据 pyvideotrans 源码分析

### 关键发现

1. **请求方法**: `GET` 请求（不是 POST）
2. **参数传递**: 通过 `params` 传递（不是 `json`）
3. **有两种模式**: V1 和 V2，参数名不同

---

## 📋 V1 模式 vs V2 模式

### V1 模式参数

```python
data = {
    "text": "要合成的文本",
    "text_language": "zh",  # 注意是 text_language
    "refer_wav_path": "cs3.mp3",  # 注意是 refer_wav_path
    "prompt_text": "参考音频的文本",
    "prompt_language": "ja",  # 注意是 prompt_language
    "extra": "pyvideotrans",
    "ostype": "win32"
}

# API 地址
url = "http://192.168.110.204:9880"  # 不需要 /tts 后缀
```

### V2 模式参数

```python
data = {
    "text": "要合成的文本",
    "text_lang": "zh",  # 注意是 text_lang（简写）
    "ref_audio_path": "cs3.mp3",  # 注意是 ref_audio_path
    "prompt_text": "参考音频的文本",
    "prompt_lang": "ja",  # 注意是 prompt_lang（简写）
    "speed_factor": 1.0
}

# API 地址
url = "http://192.168.110.204:9880/tts"  # V2 需要 /tts 后缀
```

---

## 🎯 参数名对比表

| 功能 | V1 模式 | V2 模式 |
|------|---------|---------|
| 合成文本语言 | `text_language` | `text_lang` |
| 参考音频路径 | `refer_wav_path` | `ref_audio_path` |
| 参考文本语言 | `prompt_language` | `prompt_lang` |
| API 路径 | `/` | `/tts` |

---

## 📁 参考音频路径规则

**重要**: 参考音频文件必须放在 **GPT-SoVITS 服务器的项目根目录**

### 正确示例

假设 GPT-SoVITS 安装在 `/home/fuxin/GPT-SoVITS/`

1. **将音频文件放到根目录**
   ```bash
   /home/fuxin/GPT-SoVITS/cs3.mp3  ← 正确位置
   ```

2. **配置时只写文件名**
   ```python
   "ref_audio_path": "cs3.mp3"  # 或 "refer_wav_path": "cs3.mp3"
   ```

### 错误示例

```python
# ❌ 错误：使用客户端本地路径
"ref_audio_path": "D:\\AI_video\\cs3.mp3"

# ❌ 错误：使用服务器其他路径
"ref_audio_path": "/home/fuxin/cs3.mp3"
```

---

## 🚀 测试步骤

### 步骤1: 确认 GPT-SoVITS 版本

在 pyvideotrans 界面中，如果勾选了 **"是否为V2版本"**，则使用 V2 模式。

### 步骤2: 上传音频到服务器

```bash
# 使用 scp 上传
scp cs3.mp3 user@192.168.110.204:/home/fuxin/GPT-SoVITS/

# 或者直接在服务器上放置文件
```

### 步骤3: 运行测试脚本

```bash
# 测试 V2 模式
python test_gptsovits_v2.py

# 测试 V1 模式
python test_gptsovits_v1.py
```

---

## 🔧 根据你的配置

从截图看，你的配置是：
- API地址: `http://192.168.110.204:9880`
- 额外参数: `pyvideotrans`
- 参考音频: `cs3.mp3#何でだよ 私たちは治療を受けに来たんだよ そうだよ ここはお前の家じゃないだろ#ja`

这意味着：
1. ✅ 使用 **V2 模式**（如果勾选了 V2）
2. ✅ 文件名: `cs3.mp3`
3. ✅ 参考文本: `何でだよ 私たちは治療を受けに来たんだよ そうだよ ここはお前の家じゃないだろ`
4. ✅ 参考语言: `ja`

---

## ⚠️ 502 错误的可能原因

1. **GPT-SoVITS 服务未启动**
   ```bash
   # 检查服务是否运行
   curl http://192.168.110.204:9880/
   ```

2. **参考音频文件不存在**
   ```bash
   # SSH 登录服务器检查
   ls -la /home/fuxin/GPT-SoVITS/cs3.mp3
   ```

3. **参数格式错误**
   - 确认使用的是 V1 还是 V2
   - 使用对应的参数名

4. **音频格式问题**
   - 建议使用 WAV 格式
   - 时长 3-10 秒
   - 采样率 22050Hz

---

## 📝 完整调用示例（V2）

```python
import requests

url = "http://192.168.110.204:9880/tts"

data = {
    "text": "你好，这是测试文本",
    "text_lang": "zh",
    "ref_audio_path": "cs3.mp3",
    "prompt_text": "何でだよ 私たちは治療を受けに来たんだよ そうだよ ここはお前の家じゃないだろ",
    "prompt_lang": "ja",
    "speed_factor": 1.0
}

response = requests.get(url, params=data, timeout=30)

if response.status_code == 200:
    with open("output.wav", "wb") as f:
        f.write(response.content)
    print("✅ 成功")
else:
    print(f"❌ 失败: {response.text}")
```

---

## 💡 调试建议

1. **先测试 V2 模式**
   ```bash
   python test_gptsovits_v2.py
   ```

2. **如果失败，测试 V1 模式**
   ```bash
   python test_gptsovits_v1.py
   ```

3. **查看完整的请求 URL**
   - 脚本会打印完整的 URL
   - 检查参数是否正确编码

4. **检查服务器日志**
   - 登录到 192.168.110.204
   - 查看 GPT-SoVITS 的运行日志
   - 确认它在哪里查找音频文件

---

## 📞 问题排查清单

- [ ] GPT-SoVITS 服务是否正常运行？
- [ ] 使用的是 V1 还是 V2 模式？
- [ ] 参数名是否正确（text_lang vs text_language）？
- [ ] cs3.mp3 是否在 GPT-SoVITS 根目录？
- [ ] 音频文件权限是否可读？
- [ ] 网络连接是否正常？
- [ ] API 地址是否正确（是否需要 /tts 后缀）？
